name: apgms

services:
  db:
    image: postgres:16
    container_name: apgms-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: apgms
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - apgms_pgdata_local:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - apgmsnet

  redis:
    image: redis:7
    container_name: apgms-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - apgmsnet

  tax-engine:
    container_name: apgms-tax-engine
    image: apgms-tax-engine-local
    build:
      context: .
      dockerfile: services/tax-engine/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-dev}
        BUILD_TS: ${BUILD_TS:-dev}
    restart: unless-stopped
    ports:
      - "8000:8000"
    networks:
      - apgmsnet

  api-gateway:
    container_name: apgms-api-gateway
    image: apgms-api-gateway-local
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-dev}
        BUILD_TS: ${BUILD_TS:-dev}
    restart: unless-stopped
    depends_on:
      db:
        condition: service_started
      redis:
        condition: service_started
      tax-engine:
        condition: service_started
    environment:
      NODE_ENV: development
      APGMS_MODE: demo

      DATABASE_URL: postgresql://postgres:postgres@db:5432/apgms?schema=public
      SHADOW_DATABASE_URL: postgresql://postgres:postgres@db:5432/apgms?schema=public

      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_URL: redis://redis:6379

      TAX_ENGINE_URL: http://tax-engine:8000

      CORS_ALLOWED_ORIGINS: http://localhost:5173,http://localhost:3000

      AUTH_ISSUER: http://auth.local.test
      AUTH_AUDIENCE: apgms-local
      AUTH_JWKS: '{"keys":[{"kid":"dev-key-1","alg":"RS256"}]}'
      AUTH_DEV_SECRET: local-dev-shared-secret-change-me
      AUTH_FAILURE_THRESHOLD: "5"

      API_RATE_LIMIT_MAX: "60"
      API_RATE_LIMIT_WINDOW: 1 minute

      PII_ACTIVE_KEY: local
      PII_ACTIVE_SALT: local
      PII_KEYS: '[{"kid":"local","material":"AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQE="}]'
      PII_SALTS: '[{"sid":"local","secret":"AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI="}]'

      ENABLE_PROTOTYPE: "true"

      # identity gate values in container runtime env too
      GIT_SHA: ${GIT_SHA:-dev}
      BUILD_TS: ${BUILD_TS:-dev}
    ports:
      - "3000:3000"
    networks:
      - apgmsnet

  worker:
    container_name: apgms-worker
    image: apgms-worker-local
    build:
      context: .
      dockerfile: services/worker/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-dev}
        BUILD_TS: ${BUILD_TS:-dev}
    restart: on-failure
    depends_on:
      db:
        condition: service_started
      redis:
        condition: service_started
      tax-engine:
        condition: service_started
    environment:
      NODE_ENV: development
      APGMS_MODE: demo

      DATABASE_URL: postgresql://postgres:postgres@db:5432/apgms?schema=public
      SHADOW_DATABASE_URL: postgresql://postgres:postgres@db:5432/apgms?schema=public

      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_URL: redis://redis:6379

      TAX_ENGINE_URL: http://tax-engine:8000

      CORS_ALLOWED_ORIGINS: http://localhost:5173,http://localhost:3000

      AUTH_ISSUER: http://auth.local.test
      AUTH_AUDIENCE: apgms-local
      AUTH_JWKS: '{"keys":[{"kid":"dev-key-1","alg":"RS256"}]}'
      AUTH_DEV_SECRET: local-dev-shared-secret-change-me
      AUTH_FAILURE_THRESHOLD: "5"

      API_RATE_LIMIT_MAX: "60"
      API_RATE_LIMIT_WINDOW: 1 minute

      PII_ACTIVE_KEY: local
      PII_ACTIVE_SALT: local
      PII_KEYS: '[{"kid":"local","material":"AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQE="}]'
      PII_SALTS: '[{"sid":"local","secret":"AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI="}]'

      GIT_SHA: ${GIT_SHA:-dev}
      BUILD_TS: ${BUILD_TS:-dev}

networks:
  apgmsnet:
    driver: bridge

volumes:
  apgms_pgdata_local:
    name: apgms_apgms_pgdata_local
