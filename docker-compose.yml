

services:
  db:
    image: postgres:16
    container_name: apgms-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: apgms
    ports:
      - "5432:5432"
    volumes:
      # persistent PG data volume
      - apgms-final_pgdata:/var/lib/postgresql/data
      # bootstrap schema + seed on FIRST startup of a new volume
      - ./db/init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
    networks:
      - apgmsnet

  redis:
    image: redis:7
    container_name: apgms-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - apgmsnet

  tax-engine:
    image: apgms-tax-engine
    container_name: apgms-tax-engine
    restart: unless-stopped
    networks:
      - apgmsnet

  api-gateway:
    image: apgms-final-api-gateway:latest
    container_name: apgms-api-gateway
    depends_on:
      - db
      - redis
      - tax-engine
    restart: unless-stopped
    environment:
      # --- DB URLs ---
      DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"
      SHADOW_DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"

      # --- Auth / JWT placeholders ---
      AUTH_AUDIENCE: "apgms-local"
      AUTH_ISSUER: "http://auth.local.test"
      AUTH_JWKS: >-
        {"keys":[{"kid":"dev-key-1","alg":"RS256"}]}

      # --- PII crypto material ---
      PII_KEYS: >-
        [{"kid":"dev-key-1","material":"GPHZGdDjE+r7X6S6zQA8KRU34GRXPeePjRGN8dkgk00="}]
      PII_ACTIVE_KEY: "dev-key-1"

      PII_SALTS: >-
        [{"sid":"dev-salt-1","secret":"BN10EUaMmjdthpHf3WGjdHrBuXNL4TkzQNg0KALHEB4="}]
      PII_ACTIVE_SALT: "dev-salt-1"

      # --- rate limit / security knobs ---
      API_RATE_LIMIT_MAX: "60"
      API_RATE_LIMIT_WINDOW: "1 minute"
      AUTH_FAILURE_THRESHOLD: "5"

      # --- CORS ---
      CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://localhost:3000"

      # --- internal service wiring ---
      TAX_ENGINE_URL: "http://tax-engine:8000"

    ports:
      - "3000:3000"
    networks:
      - apgmsnet

volumes:
  apgms-final_pgdata:

networks:
  apgmsnet:
    driver: bridge
