services:
  db:
    image: postgres:16
    container_name: apgms-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: apgms
    ports:
      - "5432:5432"
    volumes:
      - apgms-final_pgdata:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - apgmsnet

  redis:
    image: redis:7
    container_name: apgms-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - apgmsnet

  tax-engine:
    image: apgms-tax-engine
    container_name: apgms-tax-engine
    restart: unless-stopped
    networks:
      - apgmsnet

  api-gateway:
    image: apgms-final-api-gateway
    container_name: apgms-api-gateway
    depends_on:
      - db
      - redis
      - tax-engine
    restart: unless-stopped
    environment: &gateway_env
      # --- Database URLs ---
      DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"
      SHADOW_DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"

      # --- Auth / JWT config ---
      AUTH_AUDIENCE: "apgms-local"
      AUTH_ISSUER: "http://auth.local.test"
      AUTH_DEV_SECRET: ${AUTH_DEV_SECRET:?AUTH_DEV_SECRET not set}
      AUTH_JWKS: >-
        {"keys":[{"kid":"dev-key-1","alg":"RS256"}]}

      # --- PII crypto material ---
      PII_KEYS: ${PII_KEYS:?PII_KEYS not set}
      PII_ACTIVE_KEY: ${PII_ACTIVE_KEY:-dev-key-1}

      PII_SALTS: ${PII_SALTS:?PII_SALTS not set}
      PII_ACTIVE_SALT: ${PII_ACTIVE_SALT:-dev-salt-1}
      # --- Rate limit / security knobs ---
      API_RATE_LIMIT_MAX: "60"
      API_RATE_LIMIT_WINDOW: "1 minute"
      AUTH_FAILURE_THRESHOLD: "5"

      # --- CORS for webapp ---
      CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://localhost:3000"

      # --- Internal service URLs ---
      TAX_ENGINE_URL: "http://tax-engine:8000"

      # --- Redis config (important: use the redis service, not localhost) ---
      REDIS_URL: "redis://redis:6379"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

    ports:
      - "3000:3000"
    networks:
      - apgmsnet

  worker:
    image: apgms-final-worker
    container_name: apgms-worker
    depends_on:
      - db
      - redis
      - tax-engine
    restart: on-failure
    environment: *gateway_env
    command: pnpm --filter worker exec tsx src/index.ts
    networks:
      - apgmsnet

networks:
  apgmsnet:
    driver: bridge

volumes:
  apgms-final_pgdata:
