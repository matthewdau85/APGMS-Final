version: "3.9"

services:
  db:
    image: postgres:16
    container_name: apgms-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: apgms
    ports:
      - "5432:5432"
    volumes:
      # persistent data
      - apgms-final_pgdata:/var/lib/postgresql/data
      # bootstrap schema + seed admin user
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - apgmsnet

  redis:
    image: redis:7
    container_name: apgms-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - apgmsnet

  tax-engine:
    image: apgms-tax-engine
    container_name: apgms-tax-engine
    restart: unless-stopped
    networks:
      - apgmsnet

  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
    image: apgms-final-api-gateway:latest
    container_name: apgms-api-gateway
    depends_on:
      - db
      - redis
      - tax-engine
    restart: unless-stopped
    environment:
      # --- DB URLs ---
      DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"
      SHADOW_DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"

      # --- Auth / JWT config ---
      AUTH_AUDIENCE: "apgms-local"
      AUTH_ISSUER: "http://auth.local.test"

      # RSA keypair used to mint and verify JWTs locally
      AUTH_PRIVATE_KEY: |-
        -----BEGIN PRIVATE KEY-----
        MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDQ+eGZUwWOgVRq
        763syRKiBSAfEfLP5u/6BoagJSwWYsMerL5vEWgoR0NiuAeiTvjn6FGzApqWBGb0
        e8YKiGXe+A15zbbNACzqwB73ku5Va+rpvphPrQT1TQsMFVYjMaHM341nU9dRvmbI
        +zcZn/RMUG0O5B4yCAK+gz3PHuL1hQ9OkvcJ0xVg1kFCXNGu72imLFhLmifb1nKk
        tN+qMq4zHnZ0SvNndftow2ftNC43gIOqfmOaEyPRjbqDvF44Xy25kRM3Css37w32
        f2iho7sA/YDutEde4W/YHUIv/efMIvYSoz2xLFTgO09/7QdaApJee2IS/nrjN1D4
        ePc1lyxrAgMBAAECggEAKTD4DPbWY46Oiz2PNNs1dwY3nKg3Ck/lAY2Dv9FT7V2u
        RD+ckdwGgdn6KF1J8+5JFb0vTW+39NYNTSeQk8bq/ZY7YcTwwVvFfsg70mT94YyS
        E1zkPOBH1+pFwS37ephv4ig2gSV/jbdQH1GVPNHQn7JCrOq+IPJ/R/oqlsbpyacD
        YmJp18VaAfBcOz1TeLe/2koNgyOcNlEODvnHBAoWc15XOSM2BIACwaI0bF8ExNXb
        2lXHtG7O8nq955fmbD4wgEBLj4LRJ5ykmPAP4D3VJwJTaPicpSor4hAsl06mi9at
        9dEy3v5YcFJo6Bvx1HQJyTRyHqgSUiOwMGT4D8TscQKBgQDygrzLKCQcJ/UkJEEk
        U5qQxsgqxNvD1el+aoTTzJNWDtvkGxeykNU0N0wKdvrP2pk3I9LDalEEFHPVKeoB
        y4+L6v7VNab88TdON1/wN7JwrFGJwUGjw6d7hzYZS7eXzE+yPajfGqVkWJrSAARZ
        qRFgWk7pVRVALYqhk6q/JiDBnQKBgQDcmZ+hMkbRcW4/zkryeooPrWn36q4S+MgL
        98NodLAPdmgsVtpowZTc4WKikruBj7PhEqClagLR6Q/mfl5jy1PWoZH3722K7bPS
        L1rn+rGmL+ayG7sPI7Y6Tl1+6LqQUQ1LRf4zTZ1sdDqQtk9zxvEmp/qf6yuEyFef
        a1yoIemrpwKBgB9OGSjwiZjI37BGrdIOqMk/n99FgkkJeBbFkVf19J8LU/9iL/Dx
        GVSgPsSrDz19roGbsj1foA2yxjEiM/7/VAxvzW2ge2nziXwjUdMknXhGBlCODfch
        7qDXl3g0egKycSdFJmOGgQsvFO0+61DXrlKN1dnxDck3F8o70bLTLS9RAoGAB6k+
        Jfb9BqEN1yFu8OTYjprTJ0z7JqWFLQU5wBLtWlweWgvaIfE3HkSljEfUQzeeY56l
        /Zik6G1TpAmXdZfGHZoW26lxAHYo3I/QdGX8bW0UcfMMmAYBehzmmlWyxPhLoeWY
        Yme7o9yVfBkYwUiTb2g+B/e+1ymuAVdVLHGhD9kCgYBWkwhG/oZCa6becA8orCmh
        JpZV9qgKUm/FrrcqYkkEzhQtidbtA6CyxmR/0ovdlEXwRZ4q0aTf3gdYWGRwKaBa
        YDweUyS+G2zY8ceH6srK3EHnN9tt55U4UD+Xcf41s1Ao60pB02kj73TvJ6qYjm1W
        fXZ6JjuJy42pptN1wxi/8g==
        -----END PRIVATE KEY-----
      AUTH_PUBLIC_KEY: |-
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0PnhmVMFjoFUau+t7MkS
        ogUgHxHyz+bv+gaGoCUsFmLDHqy+bxFoKEdDYrgHok745+hRswKalgRm9HvGCohl
        3vgNec22zQAs6sAe95LuVWvq6b6YT60E9U0LDBVWIzGhzN+NZ1PXUb5myPs3GZ/0
        TFBtDuQeMggCvoM9zx7i9YUPTpL3CdMVYNZBQlzRru9opixYS5on29ZypLTfqjKu
        Mx52dErzZ3X7aMNn7TQuN4CDqn5jmhMj0Y26g7xeOF8tuZETNwrLN+8N9n9ooaO7
        AP2A7rRHXuFv2B1CL/3nzCL2EqM9sSxU4DtPf+0HWgKSXntiEv564zdQ+Hj3NZcs
        awIDAQAB
        -----END PUBLIC KEY-----

      # still required by loadConfig() / config.ts
      AUTH_JWKS: >-
        {"keys":[{"kid":"dev-key-1","alg":"RS256"}]}

      # --- PII crypto material (your generated secrets from before) ---
      PII_KEYS: >-
        [{"kid":"dev-key-1","material":"GPHZGdDjE+r7X6S6zQA8KRU34GRXPeePjRGN8dkgk00="}]
      PII_ACTIVE_KEY: "dev-key-1"

      PII_SALTS: >-
        [{"sid":"dev-salt-1","secret":"BN10EUaMmjdthpHf3WGjdHrBuXNL4TkzQNg0KALHEB4="}]
      PII_ACTIVE_SALT: "dev-salt-1"

      # --- rate limit / monitoring knobs ---
      API_RATE_LIMIT_MAX: "60"
      API_RATE_LIMIT_WINDOW: "1 minute"
      AUTH_FAILURE_THRESHOLD: "5"

      # --- CORS so the webapp can talk to the API ---
      CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://localhost:3000"

      # --- service-to-service URL for tax-engine ---
      TAX_ENGINE_URL: "http://tax-engine:8000"
    ports:
      - "3000:3000"
    networks:
      - apgmsnet

  webapp:
    build:
      context: ./webapp
    image: apgms-webapp:latest
    container_name: apgms-webapp
    environment:
      VITE_API_BASE_URL: "http://localhost:3000"
    depends_on:
      - api-gateway
    ports:
      - "5173:5173"
    networks:
      - apgmsnet

networks:
  apgmsnet:
    driver: bridge

volumes:
  apgms-final_pgdata:
