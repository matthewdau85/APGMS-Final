version: "3.9"

services:
  db:
    image: postgres:16
    container_name: apgms-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: apgms
    ports:
      - "5432:5432"
    volumes:
      # persistent data
      - apgms-final_pgdata:/var/lib/postgresql/data
      # bootstrap schema + seed admin user
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - apgmsnet

  redis:
    image: redis:7
    container_name: apgms-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - apgmsnet

  tax-engine:
    image: apgms-tax-engine
    container_name: apgms-tax-engine
    restart: unless-stopped
    networks:
      - apgmsnet

  ml-service:
    build:
      context: .
      dockerfile: ./services/ml-service/Dockerfile
    image: apgms-ml-service:latest
    container_name: apgms-ml-service
    restart: unless-stopped
    environment:
      PYTHONUNBUFFERED: "1"
    ports:
      - "8001:8001"
    networks:
      - apgmsnet

  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
    image: apgms-final-api-gateway:latest
    container_name: apgms-api-gateway
    depends_on:
      - db
      - redis
      - tax-engine
      - ml-service
    restart: unless-stopped
    environment:
      # --- DB URLs ---
      DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"
      SHADOW_DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"

      # --- Auth / JWT config ---
      AUTH_AUDIENCE: "apgms-local"
      AUTH_ISSUER: "http://auth.local.test"

      # HS256 secret used by /auth/login to sign tokens, and by authGuard to verify them
      AUTH_DEV_SECRET: "local-dev-shared-secret-change-me"

      # still required by loadConfig() / config.ts
      AUTH_JWKS: >-
        {"keys":[{"kid":"dev-key-1","alg":"RS256"}]}

      # --- PII crypto material (your generated secrets from before) ---
      PII_KEYS: >-
        [{"kid":"dev-key-1","material":"GPHZGdDjE+r7X6S6zQA8KRU34GRXPeePjRGN8dkgk00="}]
      PII_ACTIVE_KEY: "dev-key-1"

      PII_SALTS: >-
        [{"sid":"dev-salt-1","secret":"BN10EUaMmjdthpHf3WGjdHrBuXNL4TkzQNg0KALHEB4="}]
      PII_ACTIVE_SALT: "dev-salt-1"

      # --- rate limit / monitoring knobs ---
      API_RATE_LIMIT_MAX: "60"
      API_RATE_LIMIT_WINDOW: "1 minute"
      AUTH_FAILURE_THRESHOLD: "5"

      # --- CORS so the webapp can talk to the API ---
      CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://localhost:3000"

      # --- service-to-service URL for tax-engine ---
      TAX_ENGINE_URL: "http://tax-engine:8000"
      ML_SERVICE_URL: "http://ml-service:8001"
    ports:
      - "3000:3000"
    networks:
      - apgmsnet

  webapp:
    build:
      context: ./webapp
    image: apgms-webapp:latest
    container_name: apgms-webapp
    environment:
      VITE_API_BASE_URL: "http://localhost:3000"
    depends_on:
      - api-gateway
    ports:
      - "5173:5173"
    networks:
      - apgmsnet

networks:
  apgmsnet:
    driver: bridge

volumes:
  apgms-final_pgdata:
