const containerStyle: React.CSSProperties = {
  minHeight: "100vh",
  display: "flex",
  alignItems: "center",
  justifyContent: "center",
  background: "linear-gradient(135deg, #eef2ff 0%, #f8fafc 60%, #ffffff 100%)",
  padding: "32px",
};

const cardStyle: React.CSSProperties = {
  width: "100%",
  maxWidth: "420px",
  background: "#ffffff",
  borderRadius: "12px",
  boxShadow: "0 12px 32px rgba(15, 23, 42, 0.08)",
  padding: "32px",
  fontFamily: "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
  display: "grid",
  gap: "20px",
};

const titleStyle: React.CSSProperties = {
  fontSize: "22px",
  fontWeight: 700,
  margin: 0,
};

const subtitleStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#475569",
  margin: 0,
  lineHeight: 1.5,
};

const formStyle: React.CSSProperties = {
  display: "grid",
  gap: "16px",
};

const labelStyle: React.CSSProperties = {
  display: "grid",
  gap: "8px",
  fontSize: "14px",
  color: "#1e293b",
};

const inputStyle: React.CSSProperties = {
  padding: "10px 12px",
  borderRadius: "8px",
  border: "1px solid #cbd5f5",
  fontSize: "14px",
};

const helperTextStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#64748b",
};

const errorStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#b91c1c",
  background: "#fee2e2",
  padding: "10px 12px",
  borderRadius: "8px",
};

const submitButtonStyle: React.CSSProperties = {
  background: "#0b5fff",
  color: "#ffffff",
  border: "none",
  borderRadius: "8px",
  padding: "12px",
  fontSize: "15px",
  fontWeight: 600,
};

const footerStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  fontSize: "13px",
  color: "#64748b",
};

const linkStyle: React.CSSProperties = {
  color: "#0b5fff",
  textDecoration: "none",
  fontWeight: 500,
};



============================================================
FILE: C:\src\apgms-final\webapp\src\RegulatorMonitoringPage.tsx
============================================================
import React, { useEffect, useMemo, useState } from "react";
import { fetchRegulatorMonitoringSnapshots } from "./api";
import { getRegulatorToken } from "./regulatorAuth";

type SnapshotResponse = Awaited<ReturnType<typeof fetchRegulatorMonitoringSnapshots>>;
type Snapshot = SnapshotResponse["snapshots"][number];

type State = {
  loading: boolean;
  error: string | null;
  snapshots: Snapshot[];
};

const initialState: State = {
  loading: true,
  error: null,
  snapshots: [],
};

export default function RegulatorMonitoringPage() {
  const token = getRegulatorToken();
  const [state, setState] = useState<State>(initialState);
  const [selectedId, setSelectedId] = useState<string | null>(null);

  useEffect(() => {
    if (!token) {
      setState({ loading: false, error: "Session expired", snapshots: [] });
      return;
    }
    const authToken = token;
    let cancelled = false;
    async function load() {
      setState(initialState);
      try {
        const data = await fetchRegulatorMonitoringSnapshots(authToken, 10);
        if (cancelled) return;
        setState({
          loading: false,
          error: null,
          snapshots: data.snapshots,
        });
        setSelectedId(data.snapshots[0]?.id ?? null);
      } catch (error) {
        if (cancelled) return;
        setState({
          loading: false,
          error: error instanceof Error ? error.message : "load_failed",
          snapshots: [],
        });
      }
    }
    load();
    return () => {
      cancelled = true;
    };
  }, [token]);

  const selectedSnapshot = useMemo(
    () => state.snapshots.find((snap) => snap.id === selectedId) ?? null,
    [state.snapshots, selectedId]
  );

  if (!token) {
    return (
      <div style={panelStyle}>
        <h2 style={panelTitleStyle}>Session expired</h2>
        <p>Please sign in again.</p>
      </div>
    );
  }

  if (state.loading) {
    return (
      <div style={panelStyle}>
        <h2 style={panelTitleStyle}>Loading monitoring timeline...</h2>
      </div>
    );
  }

  if (state.error) {
    return (
      <div style={panelStyle}>
        <h2 style={panelTitleStyle}>Unable to load monitoring snapshots</h2>
        <p style={{ color: "#b91c1c" }}>{state.error}</p>
      </div>
    );
  }

  return (
    <div style={layoutStyle}>
      <aside style={listStyle}>
        <h2 style={listTitleStyle}>Monitoring cadence</h2>
        <p style={listSubtitleStyle}>
          Automated snapshots when alerts update, obligations change, or plans are requested.
        </p>
        <div style={listItemsStyle}>
          {state.snapshots.length === 0 ? (
            <div style={emptyStateStyle}>No monitoring events captured.</div>
          ) : (
            state.snapshots.map((snapshot) => (
              <button
                key={snapshot.id}
                type="button"
                onClick={() => setSelectedId(snapshot.id)}
                style={{
                  ...listItemButtonStyle,
                  borderColor: snapshot.id === selectedId ? "#0b5fff" : "transparent",
                  background:
                    snapshot.id === selectedId ? "rgba(11, 95, 255, 0.12)" : "transparent",
                }}
              >
                <div style={listItemTitleStyle}>
                  {formatDate(snapshot.createdAt)}
                </div>
                <div style={listItemMetaStyle}>
                  Alerts: {snapshot.payload.alerts.total} Â· Plans open:{" "}
                  {snapshot.payload.paymentPlansOpen}
                </div>
              </button>
            ))
          )}
        </div>
      </aside>
      <section style={detailStyle}>
        {selectedSnapshot ? (
          <SnapshotDetail snapshot={selectedSnapshot} />
        ) : (
          <div style={emptyStateStyle}>Select a snapshot to inspect metrics.</div>
        )}
      </section>
    </div>
  );
}

function SnapshotDetail({ snapshot }: { snapshot: Snapshot }) {
  const payload = snapshot.payload;
  return (
    <div style={detailContentStyle}>
      <header style={detailHeaderStyle}>
        <div>
          <div style={detailTitleStyle}>
            Snapshot generated {formatDate(snapshot.createdAt)}
          </div>
          <div style={detailSubtitleStyle}>
            Evidence captured at {formatDate(payload.generatedAt)}
          </div>
        </div>
        <div style={tagGroupStyle}>
          <DetailTag label="Alerts" value={String(payload.alerts.total)} />
          <DetailTag label="High severity" value={String(payload.alerts.openHigh)} tone="warn" />
          <DetailTag label="Payment plans open" value={String(payload.paymentPlansOpen)} />
        </div>
      </header>

      <div style={detailGridStyle}>
        <div style={cardStyle}>
          <h3 style={cardTitleStyle}>Bas readiness</h3>
          {payload.bas ? (
            <div style={cardBodyStyle}>
              <ReadinessRow label="Overall" status={payload.bas.overallStatus} />
              <ReadinessRow label="PAYGW" status={payload.bas.paygw.status} />
              <ReadinessRow label="GST" status={payload.bas.gst.status} />
              {payload.bas.blockers.length > 0 ? (
                <ul style={blockerListStyle}>
                  {payload.bas.blockers.map((item, idx) => (
                    <li key={idx}>{item}</li>
                  ))}
                </ul>
              ) : (
                <div style={emptyStateStyle}>No blockers recorded.</div>
              )}
            </div>
          ) : (
            <div style={emptyStateStyle}>BAS preview unavailable.</div>
          )}
        </div>

        <div style={cardStyle}>
          <h3 style={cardTitleStyle}>Designated account balances</h3>
          <div style={cardBodyStyle}>
            <MetricRow label="PAYGW" value={formatCurrency(payload.designatedTotals.paygw)} />
            <MetricRow label="GST" value={formatCurrency(payload.designatedTotals.gst)} />
          </div>
        </div>

        <div style={cardStyle}>
          <h3 style={cardTitleStyle}>Recent alert activity</h3>
          {payload.alerts.recent.length === 0 ? (
            <div style={emptyStateStyle}>No recent alerts.</div>
          ) : (
            <div style={recentListStyle}>
              {payload.alerts.recent.map((alert) => (
                <div key={alert.id} style={recentRowStyle(alert.severity)}>
                  <div style={recentTitleStyle}>{alert.type}</div>
                  <div style={recentMetaStyle}>
                    {formatDate(alert.createdAt)} Â· {alert.resolved ? "Resolved" : "Open"}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      <div style={payloadWrapperStyle}>
        <div style={payloadHeaderStyle}>
          Raw payload
          <span style={payloadHintStyle}>
            Use for downstream evidence ingestion (JSON schema stable).
          </span>
        </div>
        <pre style={payloadPreStyle}>{JSON.stringify(payload, null, 2)}</pre>
      </div>
    </div>
  );
}

function DetailTag({
  label,
  value,
  tone = "info",
}: {
  label: string;
  value: string;
  tone?: "info" | "warn";
}) {
  const palette =
    tone === "warn"
      ? { bg: "rgba(239, 68, 68, 0.16)", color: "#b91c1c" }
      : { bg: "rgba(59, 130, 246, 0.16)", color: "#1d4ed8" };
  return (
    <div
      style={{
        background: palette.bg,
        color: palette.color,
        borderRadius: "999px",
        padding: "6px 12px",
        fontSize: "12px",
        fontWeight: 600,
        display: "flex",
        gap: "6px",
      }}
    >
      <span>{label}</span>
      <span>{value}</span>
    </div>
  );
}

function ReadinessRow({ label, status }: { label: string; status: string }) {
  const tone = status === "READY" ? "ready" : "blocked";
  const palette =
    tone === "ready"
      ? { color: "#15803d", bg: "rgba(74, 222, 128, 0.16)" }
      : { color: "#c2410c", bg: "rgba(251, 191, 36, 0.18)" };
  return (
    <div style={readinessRowStyle}>
      <span>{label}</span>
      <span style={{ ...readinessBadgeStyle, background: palette.bg, color: palette.color }}>
        {status}
      </span>
    </div>
  );
}

function MetricRow({ label, value }: { label: string; value: string }) {
  return (
    <div style={metricRowStyle}>
      <span>{label}</span>
      <strong>{value}</strong>
    </div>
  );
}

function formatDate(value: string) {
  return new Date(value).toLocaleString("en-AU", {
    dateStyle: "medium",
    timeStyle: "short",
  });
}

function formatCurrency(amount: number): string {
  return new Intl.NumberFormat("en-AU", {
    style: "currency",
    currency: "AUD",
    maximumFractionDigits: 2,
  }).format(amount);
}

const panelStyle: React.CSSProperties = {
  background: "#ffffff",
  borderRadius: "12px",
  padding: "32px",
  boxShadow: "0 12px 32px rgba(15, 23, 42, 0.06)",
};

const panelTitleStyle: React.CSSProperties = {
  margin: 0,
  fontSize: "20px",
  fontWeight: 600,
};

const layoutStyle: React.CSSProperties = {
  display: "grid",
  gridTemplateColumns: "280px 1fr",
  gap: "24px",
};

const listStyle: React.CSSProperties = {
  background: "#ffffff",
  borderRadius: "12px",
  padding: "24px",
  boxShadow: "0 12px 32px rgba(15, 23, 42, 0.05)",
  display: "grid",
  gap: "16px",
  alignSelf: "start",
};

const listTitleStyle: React.CSSProperties = {
  margin: 0,
  fontSize: "18px",
  fontWeight: 600,
};

const listSubtitleStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#64748b",
};

const listItemsStyle: React.CSSProperties = {
  display: "grid",
  gap: "10px",
};

const listItemButtonStyle: React.CSSProperties = {
  textAlign: "left",
  borderRadius: "10px",
  border: "2px solid transparent",
  padding: "12px",
  background: "transparent",
  cursor: "pointer",
  display: "grid",
  gap: "4px",
};

const listItemTitleStyle: React.CSSProperties = {
  fontSize: "14px",
  fontWeight: 600,
  color: "#0f172a",
};

const listItemMetaStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#475569",
};

const emptyStateStyle: React.CSSProperties = {
  background: "#f1f5f9",
  borderRadius: "10px",
  padding: "16px",
  fontSize: "13px",
  color: "#475569",
};

const detailStyle: React.CSSProperties = {
  background: "#ffffff",
  borderRadius: "12px",
  padding: "28px",
  boxShadow: "0 12px 32px rgba(15, 23, 42, 0.05)",
  minHeight: "520px",
};

const detailContentStyle: React.CSSProperties = {
  display: "grid",
  gap: "24px",
};

const detailHeaderStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  alignItems: "flex-start",
  gap: "16px",
  flexWrap: "wrap",
};

const detailTitleStyle: React.CSSProperties = {
  fontSize: "20px",
  fontWeight: 600,
  marginBottom: "4px",
};

const detailSubtitleStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#64748b",
};

const tagGroupStyle: React.CSSProperties = {
  display: "flex",
  gap: "12px",
  alignItems: "center",
  flexWrap: "wrap",
};

const detailGridStyle: React.CSSProperties = {
  display: "grid",
  gridTemplateColumns: "repeat(auto-fit, minmax(260px, 1fr))",
  gap: "20px",
};

const cardStyle: React.CSSProperties = {
  border: "1px solid #e2e8f0",
  borderRadius: "12px",
  padding: "18px",
  display: "grid",
  gap: "12px",
};

const cardTitleStyle: React.CSSProperties = {
  fontSize: "16px",
  fontWeight: 600,
  margin: 0,
};

const cardBodyStyle: React.CSSProperties = {
  display: "grid",
  gap: "10px",
};

const readinessRowStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  fontSize: "13px",
  color: "#475569",
};

const readinessBadgeStyle: React.CSSProperties = {
  padding: "4px 8px",
  borderRadius: "999px",
  fontWeight: 600,
  fontSize: "12px",
};

const metricRowStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  fontSize: "14px",
  color: "#475569",
};

const blockerListStyle: React.CSSProperties = {
  margin: 0,
  paddingInlineStart: "18px",
  display: "grid",
  gap: "6px",
  fontSize: "13px",
  color: "#334155",
};

const recentListStyle: React.CSSProperties = {
  display: "grid",
  gap: "10px",
};

const recentRowStyle = (severity: string): React.CSSProperties => {
  const palette: Record<string, { border: string; bg: string }> = {
    HIGH: { border: "#f87171", bg: "rgba(248, 113, 113, 0.16)" },
    MEDIUM: { border: "#fbbf24", bg: "rgba(251, 191, 36, 0.16)" },
    default: { border: "#60a5fa", bg: "rgba(96, 165, 250, 0.16)" },
  };
  const tone = palette[severity] ?? palette.default;
  return {
    borderLeft: `4px solid ${tone.border}`,
    background: tone.bg,
    borderRadius: "10px",
    padding: "12px 16px",
  };
};

const recentTitleStyle: React.CSSProperties = {
  fontSize: "14px",
  fontWeight: 600,
  color: "#0f172a",
};

const recentMetaStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#475569",
  marginTop: "4px",
};

const payloadWrapperStyle: React.CSSProperties = {
  border: "1px solid #e2e8f0",
  borderRadius: "12px",
  overflow: "hidden",
};

const payloadHeaderStyle: React.CSSProperties = {
  padding: "12px 16px",
  background: "#f8fafc",
  fontSize: "13px",
  color: "#475569",
  display: "flex",
  justifyContent: "space-between",
};

const payloadHintStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#94a3b8",
};

const payloadPreStyle: React.CSSProperties = {
  margin: 0,
  padding: "18px",
  background: "#0f172a",
  color: "#e2e8f0",
  fontSize: "12px",
  lineHeight: 1.6,
  maxHeight: "320px",
  overflow: "auto",
  borderRadius: "0 0 12px 12px",
};



============================================================
FILE: C:\src\apgms-final\webapp\src\RegulatorOverviewPage.tsx
============================================================
import React, { useEffect, useMemo, useState } from "react";
import {
  fetchRegulatorAlerts,
  fetchRegulatorBankSummary,
  fetchRegulatorComplianceReport,
  fetchRegulatorMonitoringSnapshots,
} from "./api";
import { getRegulatorSession, getRegulatorToken } from "./regulatorAuth";

type ComplianceReport = Awaited<ReturnType<typeof fetchRegulatorComplianceReport>>;
type AlertsResponse = Awaited<ReturnType<typeof fetchRegulatorAlerts>>;
type MonitoringResponse = Awaited<ReturnType<typeof fetchRegulatorMonitoringSnapshots>>;
type BankSummaryResponse = Awaited<ReturnType<typeof fetchRegulatorBankSummary>>;

type State = {
  loading: boolean;
  error: string | null;
  compliance: ComplianceReport | null;
  alerts: AlertsResponse["alerts"] | null;
  snapshots: MonitoringResponse["snapshots"] | null;
  bankSummary: BankSummaryResponse | null;
};

const initialState: State = {
  loading: true,
  error: null,
  compliance: null,
  alerts: null,
  snapshots: null,
  bankSummary: null,
};

export default function RegulatorOverviewPage() {
  const token = getRegulatorToken();
  const session = getRegulatorSession();
  const [state, setState] = useState<State>(initialState);

  useEffect(() => {
    if (!token) {
      setState((prev) => ({ ...prev, loading: false, error: "Session expired" }));
      return;
    }
    const authToken = token;
    let cancelled = false;
    async function load() {
      setState(initialState);
      try {
        const [compliance, alerts, snapshots, bankSummary] = await Promise.all([
          fetchRegulatorComplianceReport(authToken),
          fetchRegulatorAlerts(authToken),
          fetchRegulatorMonitoringSnapshots(authToken, 5),
          fetchRegulatorBankSummary(authToken),
        ]);
        if (cancelled) return;
        setState({
          loading: false,
          error: null,
          compliance,
          alerts: alerts.alerts,
          snapshots: snapshots.snapshots,
          bankSummary,
        });
      } catch (error) {
        if (cancelled) return;
        const message = error instanceof Error ? error.message : "load_failed";
        setState({
          loading: false,
          error: message,
          compliance: null,
          alerts: null,
          snapshots: null,
          bankSummary: null,
        });
      }
    }
    load();
    return () => {
      cancelled = true;
    };
  }, [token]);

  const latestSnapshot = useMemo(() => state.snapshots?.[0] ?? null, [state.snapshots]);

  if (!token) {
    return (
      <div style={panelStyle}>
        <h2 style={panelTitleStyle}>Session expired</h2>
        <p>Please sign in again to continue.</p>
      </div>
    );
  }

  if (state.loading) {
    return (
      <div style={panelStyle}>
        <h2 style={panelTitleStyle}>Loading regulator view...</h2>
      </div>
    );
  }

  if (state.error) {
    return (
      <div style={panelStyle}>
        <h2 style={panelTitleStyle}>Unable to load regulator overview</h2>
        <p style={{ color: "#b91c1c" }}>{state.error}</p>
      </div>
    );
  }

  const compliance = state.compliance!;
  const alerts = state.alerts ?? [];
  const bankSummary = state.bankSummary;

  return (
    <div style={{ display: "grid", gap: "24px" }}>
      <header style={headerStyle}>
        <div>
          <h1 style={headerTitleStyle}>Regulator snapshot</h1>
          <p style={headerSubtitleStyle}>
            Live evidence pack for <strong>{session?.orgId ?? compliance.orgId}</strong>
          </p>
        </div>
        <div style={pillGroupStyle}>
          <StatusPill
            label="Next BAS due"
            value={compliance.nextBasDue ? formatDate(compliance.nextBasDue) : "Not scheduled"}
          />
          <StatusPill
            label="High severity alerts"
            value={String(compliance.alertsSummary.openHighSeverity)}
            tone={compliance.alertsSummary.openHighSeverity > 0 ? "warn" : "ok"}
          />
          <StatusPill
            label="Holding PAYGW"
            value={formatCurrency(compliance.designatedTotals.paygw)}
          />
          <StatusPill
            label="Holding GST"
            value={formatCurrency(compliance.designatedTotals.gst)}
          />
        </div>
      </header>

      <section style={sectionStyle}>
        <h2 style={sectionTitleStyle}>Compliance timeline</h2>
        <div style={{ display: "grid", gap: "12px" }}>
          {compliance.basHistory.length === 0 ? (
            <div style={emptyStateStyle}>No BAS history found.</div>
          ) : (
            compliance.basHistory.map((entry) => (
              <div key={entry.period} style={timelineRowStyle}>
                <div>
                  <div style={timelinePeriodStyle}>{entry.period}</div>
                  <div style={timelineMetaStyle}>
                    Lodged: {entry.lodgedAt ? formatDate(entry.lodgedAt) : "Pending"}
                  </div>
                </div>
                <div style={timelineStatusStyle(entry.status)}>
                  {entry.status}
                  <span style={timelineNotesStyle}>{entry.notes}</span>
                </div>
              </div>
            ))
          )}
        </div>
      </section>

      <section style={sectionStyle}>
        <h2 style={sectionTitleStyle}>Alerts overview</h2>
        {alerts.length === 0 ? (
          <div style={emptyStateStyle}>No open alerts.</div>
        ) : (
          <div style={{ display: "grid", gap: "8px" }}>
            {alerts.slice(0, 6).map((alert) => (
              <div key={alert.id} style={alertRowStyle(alert.severity)}>
                <div>
                  <div style={alertTypeStyle}>{alert.type}</div>
                  <div style={alertMessageStyle}>{alert.message}</div>
                </div>
                <div style={alertMetaStyle}>
                  <span>{formatDate(alert.createdAt)}</span>
                  <span>{alert.resolved ? "Resolved" : "Open"}</span>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>

      <section style={sectionStyle}>
        <h2 style={sectionTitleStyle}>Designated accounts snapshot</h2>
        {latestSnapshot?.payload ? (
          <div style={snapshotGridStyle}>
            <SnapshotCard
              title="PAYGW holding status"
              payload={latestSnapshot.payload}
              field="paygw"
            />
            <SnapshotCard
              title="GST holding status"
              payload={latestSnapshot.payload}
              field="gst"
            />
            <div style={snapshotCardStyle}>
              <div style={snapshotTitleStyle}>Blockers</div>
              {latestSnapshot.payload.bas?.blockers?.length ? (
                <ul style={blockersListStyle}>
                  {latestSnapshot.payload.bas.blockers.map((item, idx) => (
                    <li key={idx}>{item}</li>
                  ))}
                </ul>
              ) : (
                <div style={emptyStateStyle}>No blockers recorded.</div>
              )}
            </div>
          </div>
        ) : (
          <div style={emptyStateStyle}>No monitoring snapshot captured yet.</div>
        )}
      </section>

      <section style={sectionStyle}>
        <h2 style={sectionTitleStyle}>Bank activity summary</h2>
        {bankSummary ? (
          <div style={bankSummaryLayoutStyle}>
            <div>
              <div style={bankSummaryLabelStyle}>Total ledger entries</div>
              <div style={bankSummaryValueStyle}>{bankSummary.summary.totalEntries}</div>
            </div>
            <div>
              <div style={bankSummaryLabelStyle}>Total secured amount</div>
              <div style={bankSummaryValueStyle}>
                {formatCurrency(bankSummary.summary.totalAmount)}
              </div>
            </div>
            <div>
              <div style={bankSummaryLabelStyle}>Window</div>
              <div style={bankSummaryValueStyle}>
                {bankSummary.summary.firstEntryAt
                  ? `${formatDate(bankSummary.summary.firstEntryAt)} â†’ ${formatDate(
                      bankSummary.summary.lastEntryAt ?? bankSummary.summary.firstEntryAt
                    )}`
                  : "No data"}
              </div>
            </div>
          </div>
        ) : (
          <div style={emptyStateStyle}>Unable to load bank summary.</div>
        )}
      </section>
    </div>
  );
}

function formatCurrency(amount: number): string {
  return new Intl.NumberFormat("en-AU", {
    style: "currency",
    currency: "AUD",
    maximumFractionDigits: 2,
  }).format(amount);
}

function formatDate(value: string | null): string {
  if (!value) return "â€”";
  const date = new Date(value);
  return date.toLocaleString("en-AU", {
    dateStyle: "medium",
    timeStyle: "short",
  });
}

type StatusTone = "ok" | "warn";

function StatusPill({
  label,
  value,
  tone = "ok",
}: {
  label: string;
  value: string;
  tone?: StatusTone;
}) {
  const colors =
    tone === "ok"
      ? { bg: "rgba(34, 197, 94, 0.12)", color: "#166534" }
      : { bg: "rgba(239, 68, 68, 0.12)", color: "#b91c1c" };
  return (
    <div
      style={{
        borderRadius: "999px",
        padding: "8px 16px",
        backgroundColor: colors.bg,
        color: colors.color,
        display: "flex",
        flexDirection: "column",
        gap: "2px",
        minWidth: "140px",
      }}
    >
      <span style={{ fontSize: "12px", textTransform: "uppercase", letterSpacing: "0.08em" }}>
        {label}
      </span>
      <strong style={{ fontSize: "16px" }}>{value}</strong>
    </div>
  );
}

function SnapshotCard({
  title,
  payload,
  field,
}: {
  title: string;
  payload: MonitoringResponse["snapshots"][number]["payload"];
  field: "paygw" | "gst";
}) {
  const info = payload.bas?.[field];
  if (!info) {
    return (
      <div style={snapshotCardStyle}>
        <div style={snapshotTitleStyle}>{title}</div>
        <div style={emptyStateStyle}>No BAS context captured.</div>
      </div>
    );
  }
  const statusTone = info.status === "READY" ? "ok" : "warn";
  return (
    <div style={snapshotCardStyle}>
      <div style={snapshotTitleStyle}>{title}</div>
      <div style={snapshotFieldStyle}>
        <span>Status</span>
        <span style={statusBadgeStyle(statusTone)}>{info.status}</span>
      </div>
      <div style={snapshotMetricStyle}>
        <span>Required</span>
        <strong>{formatCurrency(info.required ?? 0)}</strong>
      </div>
      <div style={snapshotMetricStyle}>
        <span>Secured</span>
        <strong>{formatCurrency(info.secured ?? 0)}</strong>
      </div>
    </div>
  );
}

const panelStyle: React.CSSProperties = {
  background: "#ffffff",
  borderRadius: "12px",
  padding: "32px",
  boxShadow: "0 12px 32px rgba(15, 23, 42, 0.06)",
};

const panelTitleStyle: React.CSSProperties = {
  margin: 0,
  fontSize: "20px",
  fontWeight: 600,
};

const headerStyle: React.CSSProperties = {
  display: "flex",
  alignItems: "center",
  justifyContent: "space-between",
  gap: "16px",
};

const headerTitleStyle: React.CSSProperties = {
  fontSize: "28px",
  margin: 0,
  color: "#0f172a",
};

const headerSubtitleStyle: React.CSSProperties = {
  fontSize: "15px",
  color: "#475569",
  marginTop: "6px",
};

const pillGroupStyle: React.CSSProperties = {
  display: "flex",
  gap: "16px",
  flexWrap: "wrap",
};

const sectionStyle: React.CSSProperties = {
  background: "#ffffff",
  borderRadius: "12px",
  padding: "24px",
  boxShadow: "0 8px 24px rgba(15, 23, 42, 0.05)",
  display: "grid",
  gap: "16px",
};

const sectionTitleStyle: React.CSSProperties = {
  fontSize: "18px",
  margin: 0,
  color: "#0f172a",
};

const emptyStateStyle: React.CSSProperties = {
  padding: "16px",
  borderRadius: "8px",
  background: "#f1f5f9",
  color: "#475569",
  fontSize: "14px",
};

const timelineRowStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  padding: "12px 16px",
  borderRadius: "8px",
  border: "1px solid #e2e8f0",
};

const timelinePeriodStyle: React.CSSProperties = {
  fontSize: "15px",
  fontWeight: 600,
  color: "#0f172a",
};

const timelineMetaStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#64748b",
};

const timelineStatusStyle = (status: string): React.CSSProperties => ({
  display: "flex",
  alignItems: "center",
  gap: "8px",
  fontSize: "14px",
  color: status === "ON_TIME" ? "#15803d" : "#b45309",
});

const timelineNotesStyle: React.CSSProperties = {
  fontWeight: 400,
  color: "#475569",
  fontSize: "12px",
};

const alertRowStyle = (severity: string): React.CSSProperties => {
  const tones: Record<string, { border: string; bg: string }> = {
    HIGH: { border: "#fca5a5", bg: "rgba(239, 68, 68, 0.08)" },
    MEDIUM: { border: "#fcd34d", bg: "rgba(250, 204, 21, 0.08)" },
    default: { border: "#bae6fd", bg: "rgba(59, 130, 246, 0.08)" },
  };
  const tone = tones[severity] ?? tones.default;
  return {
    borderLeft: `4px solid ${tone.border}`,
    background: tone.bg,
    padding: "12px 16px",
    borderRadius: "8px",
    display: "flex",
    justifyContent: "space-between",
    gap: "12px",
  };
};

const alertTypeStyle: React.CSSProperties = {
  fontWeight: 600,
  fontSize: "14px",
  color: "#0f172a",
};

const alertMessageStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#334155",
  marginTop: "4px",
};

const alertMetaStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#475569",
  display: "grid",
  justifyItems: "end",
  gap: "4px",
};

const snapshotGridStyle: React.CSSProperties = {
  display: "grid",
  gap: "16px",
  gridTemplateColumns: "repeat(auto-fit, minmax(240px, 1fr))",
};

const snapshotCardStyle: React.CSSProperties = {
  border: "1px solid #e2e8f0",
  borderRadius: "12px",
  padding: "16px",
  display: "grid",
  gap: "12px",
};

const snapshotTitleStyle: React.CSSProperties = {
  fontSize: "15px",
  fontWeight: 600,
  color: "#0f172a",
};

const snapshotFieldStyle: React.CSSProperties = {
  display: "flex",
  alignItems: "center",
  justifyContent: "space-between",
  fontSize: "13px",
  color: "#475569",
};

const statusBadgeStyle = (tone: "ok" | "warn"): React.CSSProperties => ({
  padding: "4px 8px",
  borderRadius: "999px",
  background: tone === "ok" ? "rgba(16, 185, 129, 0.12)" : "rgba(234, 179, 8, 0.14)",
  color: tone === "ok" ? "#047857" : "#92400e",
  fontWeight: 600,
  fontSize: "12px",
});

const snapshotMetricStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  fontSize: "13px",
  color: "#475569",
};

const blockersListStyle: React.CSSProperties = {
  margin: 0,
  paddingInlineStart: "16px",
  display: "grid",
  gap: "8px",
  color: "#334155",
  fontSize: "13px",
};

const bankSummaryLayoutStyle: React.CSSProperties = {
  display: "grid",
  gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
  gap: "24px",
};

const bankSummaryLabelStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#64748b",
  marginBottom: "8px",
};

const bankSummaryValueStyle: React.CSSProperties = {
  fontSize: "18px",
  fontWeight: 600,
  color: "#0f172a",
};



============================================================
FILE: C:\src\apgms-final\webapp\src\router.tsx
============================================================
import React from "react";
import {
  createBrowserRouter,
  Navigate,
  RouterProvider,
} from "react-router-dom";
import { OnboardingWizard } from "./routes/OnboardingWizard";
import { Dashboard } from "./routes/Dashboard";
import { Layout } from "./routes/Layout";

// Temporary auth/org stub â€“ replace with real context when ready
function useAuth() {
  const stored = window.localStorage.getItem("apgms_org_id");
  return { orgId: stored ?? null, isAuthenticated: true };
}

const router = createBrowserRouter([
  {
    path: "/",
    element: <Layout />,
    children: [
      {
        index: true,
        element: <RedirectToDashboardOrOnboarding />,
      },
      {
        path: "onboarding",
        element: <OnboardingGuard />,
      },
      {
        path: "dashboard",
        element: <Dashboard />,
      },
      // ...other routes...
    ],
  },
]);

function RedirectToDashboardOrOnboarding() {
  const { orgId } = useAuth();
  if (!orgId) return <Navigate to="/onboarding" replace />;
  return <Navigate to="/dashboard" replace />;
}

function OnboardingGuard() {
  const { orgId } = useAuth();
  if (orgId) return <Navigate to="/dashboard" replace />;
  return <OnboardingWizard />;
}

export const AppRouter: React.FC = () => <RouterProvider router={router} />;



============================================================
FILE: C:\src\apgms-final\webapp\src\routes\OnboardingWizard.tsx
============================================================
import React, { useState } from "react";

type TaxObligationType = "GST" | "PAYGW" | "PAYGI";

type ValidateResponse = {
  abn?: string;
  tfn?: string;
  legalName: string;
  obligations: TaxObligationType[];
};

type SetupPayload = {
  abn: string;
  legalName: string;
  schedule: "MONTHLY" | "QUARTERLY";
  shortfallThresholdBps: number;
  bankCode: "cba" | "nab" | "anz";
  account: {
    bsb: string;
    accountNumber: string;
    accountName: string;
  };
  obligations: TaxObligationType[];
};

type Step = 0 | 1 | 2 | 3;

// Assume dev proxy /api â†’ Fastify
const API_BASE = "/api";

export const OnboardingWizard: React.FC = () => {
  const [step, setStep] = useState<Step>(0);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [abn, setAbn] = useState("");
  const [tfn, setTfn] = useState("");
  const [validateResult, setValidateResult] = useState<ValidateResponse | null>(
    null,
  );

  const [schedule, setSchedule] = useState<"MONTHLY" | "QUARTERLY">(
    "QUARTERLY",
  );
  const [shortfallBps, setShortfallBps] = useState(500);

  const [bankCode, setBankCode] = useState<"cba" | "nab" | "anz">("cba");
  const [bsb, setBsb] = useState("");
  const [accountNumber, setAccountNumber] = useState("");
  const [accountName, setAccountName] = useState("");

  const [selectedObligations, setSelectedObligations] = useState<
    TaxObligationType[]
  >([]);

  const toggleObligation = (code: TaxObligationType) => {
    setSelectedObligations((prev) =>
      prev.includes(code) ? prev.filter((x) => x !== code) : [...prev, code],
    );
  };

  const callApi = async (path: string, options: RequestInit) => {
    const res = await fetch(`${API_BASE}${path}`, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        ...(options.headers ?? {}),
      },
      credentials: "include",
    });

    if (!res.ok) {
      let msg = `Request failed with ${res.status}`;
      try {
        const body = await res.json();
        msg = body?.error?.message ?? msg;
      } catch {
        // ignore
      }
      throw new Error(msg);
    }

    return res.json();
  };

  const handleValidate = async () => {
    setError(null);
    setLoading(true);
    try {
      const body: { abn?: string; tfn?: string } = {};
      if (abn) body.abn = abn;
      if (tfn) body.tfn = tfn;

      const result: ValidateResponse = await callApi(
        "/onboarding/validate",
        {
          method: "POST",
          body: JSON.stringify(body),
        },
      );

      setValidateResult(result);
      setSelectedObligations(result.obligations);
      setStep(1);
    } catch (err: any) {
      setError(err.message ?? String(err));
    } finally {
      setLoading(false);
    }
  };

  const handleSetup = async () => {
    if (!validateResult?.abn) {
      setError("ABN must be validated first");
      return;
    }
    setError(null);
    setLoading(true);
    try {
      const payload: SetupPayload = {
        abn: validateResult.abn,
        legalName: validateResult.legalName,
        schedule,
        shortfallThresholdBps: shortfallBps,
        bankCode,
        account: {
          bsb,
          accountNumber,
          accountName: accountName || validateResult.legalName,
        },
        obligations: selectedObligations,
      };
      const res = await callApi("/onboarding/setup", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      // store orgId for routing logic
      if (res?.orgId) {
        window.localStorage.setItem("apgms_org_id", res.orgId);
      }

      setStep(3);
    } catch (err: any) {
      setError(err.message ?? String(err));
    } finally {
      setLoading(false);
    }
  };

  const canContinueFromStep1 =
    !!validateResult &&
    !!bsb &&
    !!accountNumber &&
    selectedObligations.length > 0;

  return (
    <div className="max-w-2xl mx-auto p-6 space-y-6">
      <header className="space-y-1">
        <h1 className="text-2xl font-semibold">
          APGMS Onboarding â€“ Tax Buffer Setup
        </h1>
        <p className="text-sm text-slate-600">
          We&apos;ll validate your ABN/TFN, detect obligations, and configure
          secure PayTo mandates to your tax buffer.
        </p>
      </header>

      <div className="flex items-center space-x-2 text-xs text-slate-600">
        <span className={step === 0 ? "font-semibold" : ""}>1. ABN / TFN</span>
        <span>â€º</span>
        <span className={step === 1 ? "font-semibold" : ""}>
          2. Bank &amp; Schedule
        </span>
        <span>â€º</span>
        <span className={step === 2 ? "font-semibold" : ""}>
          3. Confirm &amp; Create
        </span>
        <span>â€º</span>
        <span className={step === 3 ? "font-semibold" : ""}>4. Done</span>
      </div>

      {error && (
        <div className="rounded-md border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-800">
          {error}
        </div>
      )}

      {step === 0 && (
        <section className="space-y-4 border rounded-lg p-4">
          <h2 className="text-lg font-medium">Step 1 â€“ ABN / TFN</h2>
          <p className="text-sm text-slate-600">
            Enter your ABN or TFN so we can look up your registration and
            obligations.
          </p>
          <div className="space-y-3">
            <label className="block text-sm">
              ABN
              <input
                className="mt-1 block w-full rounded-md border px-2 py-1 text-sm"
                value={abn}
                onChange={(e) => setAbn(e.target.value)}
                placeholder="11-digit ABN"
              />
            </label>
            <label className="block text-sm">
              TFN (optional)
              <input
                className="mt-1 block w-full rounded-md border px-2 py-1 text-sm"
                value={tfn}
                onChange={(e) => setTfn(e.target.value)}
                placeholder="TFN if applicable"
              />
            </label>
          </div>
          <div className="flex justify-end">
            <button
              type="button"
              onClick={handleValidate}
              disabled={loading || (!abn && !tfn)}
              className="inline-flex items-center rounded-md border px-3 py-1.5 text-sm font-medium disabled:opacity-60"
            >
              {loading ? "Validatingâ€¦" : "Validate"}
            </button>
          </div>
        </section>
      )}

      {step === 1 && validateResult && (
        <section className="space-y-4 border rounded-lg p-4">
          <h2 className="text-lg font-medium">
            Step 2 â€“ Bank, Schedule &amp; Obligations
          </h2>

          <div className="space-y-2 text-sm">
            <div>
              <div className="font-semibold">Entity</div>
              <div>{validateResult.legalName}</div>
              <div className="text-slate-600">
                ABN: {validateResult.abn ?? "â€”"} | TFN:{" "}
                {validateResult.tfn ?? "â€”"}
              </div>
            </div>
          </div>

          <div className="grid gap-4 md:grid-cols-2 text-sm">
            <div className="space-y-2">
              <label className="block">
                Payment frequency
                <select
                  className="mt-1 block w-full rounded-md border px-2 py-1 text-sm"
                  value={schedule}
                  onChange={(e) =>
                    setSchedule(e.target.value as "MONTHLY" | "QUARTERLY")
                  }
                >
                  <option value="MONTHLY">Monthly</option>
                  <option value="QUARTERLY">Quarterly (BAS)</option>
                </select>
              </label>

              <label className="block">
                Shortfall threshold (%)
                <input
                  type="number"
                  className="mt-1 block w-full rounded-md border px-2 py-1 text-sm"
                  value={shortfallBps / 100}
                  min={0}
                  max={100}
                  onChange={(e) =>
                    setShortfallBps(Math.round(Number(e.target.value) * 100))
                  }
                />
              </label>

              <fieldset className="space-y-2">
                <legend className="text-sm font-medium">
                  Obligations to secure
                </legend>
                {(["GST", "PAYGW", "PAYGI"] as TaxObligationType[]).map(
                  (code) => {
                    const detected = validateResult.obligations.includes(code);
                    const checked = selectedObligations.includes(code);
                    return (
                      <label key={code} className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={checked}
                          disabled={!detected}
                          onChange={() => toggleObligation(code)}
                        />
                        <span>
                          {code}{" "}
                          {!detected && (
                            <span className="text-xs text-slate-500">
                              (not detected on registration)
                            </span>
                          )}
                        </span>
                      </label>
                    );
                  },
                )}
              </fieldset>
            </div>

            <div className="space-y-2">
              <label className="block">
                Bank
                <select
                  className="mt-1 block w-full rounded-md border px-2 py-1 text-sm"
                  value={bankCode}
                  onChange={(e) =>
                    setBankCode(e.target.value as "cba" | "nab" | "anz")
                  }
                >
                  <option value="cba">CBA</option>
                  <option value="nab">NAB</option>
                  <option value="anz">ANZ</option>
                </select>
              </label>

              <label className="block">
                BSB
                <input
                  className="mt-1 block w-full rounded-md border px-2 py-1 text-sm"
                  value={bsb}
                  onChange={(e) => setBsb(e.target.value)}
                  placeholder="e.g. 062-000"
                />
              </label>

              <label className="block">
                Account number
                <input
                  className="mt-1 block w-full rounded-md border px-2 py-1 text-sm"
                  value={accountNumber}
                  onChange={(e) => setAccountNumber(e.target.value)}
                  placeholder="e.g. 12345678"
                />
              </label>

              <label className="block">
                Account name (optional)
                <input
                  className="mt-1 block w-full rounded-md border px-2 py-1 text-sm"
                  value={accountName}
                  onChange={(e) => setAccountName(e.target.value)}
                  placeholder={validateResult.legalName}
                />
              </label>
            </div>
          </div>

          <div className="flex justify-between">
            <button
              type="button"
              className="text-sm underline"
              onClick={() => setStep(0)}
            >
              Back
            </button>
            <button
              type="button"
              disabled={loading || !canContinueFromStep1}
              className="inline-flex items-center rounded-md border px-3 py-1.5 text-sm font-medium disabled:opacity-60"
              onClick={() => setStep(2)}
            >
              Next
            </button>
          </div>
        </section>
      )}

      {step === 2 && validateResult && (
        <section className="space-y-4 border rounded-lg p-4">
          <h2 className="text-lg font-medium">Step 3 â€“ Confirm</h2>
          <p className="text-sm text-slate-600">
            Review your settings. When you continue, APGMS will initiate a
            PayTo mandate and create designated tax buffer accounts.
          </p>

          <div className="space-y-2 text-sm">
            <div>
              <div className="font-semibold">Entity</div>
              <div>{validateResult.legalName}</div>
              <div className="text-slate-600">
                ABN: {validateResult.abn ?? "â€”"}
              </div>
            </div>

            <div>
              <div className="font-semibold">Schedule</div>
              <div>{schedule}</div>
            </div>

            <div>
              <div className="font-semibold">Shortfall threshold</div>
              <div>{(shortfallBps / 100).toFixed(2)}%</div>
            </div>

            <div>
              <div className="font-semibold">Obligations</div>
              <div>{selectedObligations.join(", ") || "None"}</div>
            </div>

            <div>
              <div className="font-semibold">Bank account</div>
              <div>
                {bsb} / {accountNumber}
              </div>
              <div className="text-slate-600">
                {accountName || validateResult.legalName}
              </div>
            </div>
          </div>

          <div className="flex justify-between">
            <button
              type="button"
              className="text-sm underline"
              onClick={() => setStep(1)}
            >
              Back
            </button>
            <button
              type="button"
              disabled={loading}
              className="inline-flex items-center rounded-md border px-3 py-1.5 text-sm font-medium disabled:opacity-60"
              onClick={handleSetup}
            >
              {loading ? "Creatingâ€¦" : "Create mandates & accounts"}
            </button>
          </div>
        </section>
      )}

      {step === 3 && (
        <section className="space-y-3 border rounded-lg p-4">
          <h2 className="text-lg font-medium">All done</h2>
          <p className="text-sm text-slate-600">
            Your organisation is onboarded. APGMS will now start tracking
            buffer coverage versus your obligations. You can review this in the
            dashboard.
          </p>
          <div>
            <button
              type="button"
              className="inline-flex items-center rounded-md border px-3 py-1.5 text-sm font-medium"
              onClick={() => {
                window.location.href = "/dashboard";
              }}
            >
              Go to dashboard
            </button>
          </div>
        </section>
      )}
    </div>
  );
};



============================================================
FILE: C:\src\apgms-final\webapp\src\SecurityPage.tsx
============================================================
import React, { useEffect, useState } from "react";
import { fetchSecurityUsers, initiateMfa, verifyMfa } from "./api";
import { getToken, getSessionUser, updateSession } from "./auth";
import { ErrorState, SkeletonBlock, StatusChip, StatCard } from "./components/UI";

type SecurityUser = Awaited<ReturnType<typeof fetchSecurityUsers>>["users"][number];

export default function SecurityPage() {
  const token = getToken();
  const sessionUser = getSessionUser();
  const [users, setUsers] = useState<SecurityUser[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [enableLoading, setEnableLoading] = useState(false);
  const [enableError, setEnableError] = useState<string | null>(null);
  const [enableSuccess, setEnableSuccess] = useState<string | null>(null);

  useEffect(() => {
    if (!token) return;
    void loadUsers();
  }, [token]);

  async function loadUsers() {
    if (!token) return;
    setError(null);
    setLoading(true);
    try {
      const response = await fetchSecurityUsers(token);
      setUsers(response.users);
    } catch (err) {
      console.error(err);
      setError("Unable to load security settings");
    } finally {
      setLoading(false);
    }
  }

  async function handleEnableMfa() {
    if (!token || !sessionUser) return;
    setEnableLoading(true);
    setEnableError(null);
    setEnableSuccess(null);
    try {
      const challenge = await initiateMfa(token);
      window.alert(`MFA enrolment initiated.\n\nDev stub code: ${challenge.code} (expires in ${challenge.expiresInSeconds}s).`);
      const supplied = window.prompt("Enter the MFA code to finish enabling MFA on your account:", challenge.code);
      if (!supplied || supplied.trim().length === 0) {
        setEnableError("MFA enrolment cancelled.");
        return;
      }
      const verification = await verifyMfa(token, supplied.trim());
      updateSession({ token: verification.token, user: verification.user });
      setEnableSuccess("Multi-factor authentication enabled for your account.");
      const refreshedToken = getToken();
      if (refreshedToken) {
        const response = await fetchSecurityUsers(refreshedToken);
        setUsers(response.users);
      }
    } catch (err) {
      console.error(err);
      setEnableError("Unable to enable MFA. Please try again.");
    } finally {
      setEnableLoading(false);
    }
  }

  if (!token) return null;

  const mfaEnabledCount = users.filter((u) => u.mfaEnabled).length;

  return (
    <div style={{ display: "grid", gap: "24px" }}>
      <header>
        <h1 style={pageTitleStyle}>Security & Access</h1>
        <p style={pageSubtitleStyle}>
          Control who can access APGMS and confirm multi-factor authentication settings before handing credentials to regulators.
        </p>
      </header>

      {loading && (
        <div style={{ display: "grid", gap: 8 }}>
          <SkeletonBlock width="50%" />
          <SkeletonBlock width="100%" height={120} />
        </div>
      )}
      {error && <ErrorState message={error} onRetry={loadUsers} detail="We could not load security settings." />}

      {!loading && !error && (
        <>
          <section style={summaryGridStyle}>
            <StatCard title="Users" value={users.length} />
            <StatCard title="MFA Enabled" value={mfaEnabledCount} tone={mfaEnabledCount === users.length ? "success" : "warning"} />
          </section>

          <section style={cardStyle}>
            <div style={headerRowStyle}>
              <div>
                <h2 style={sectionTitleStyle}>Access List</h2>
                <p style={sectionSubtitleStyle}>Users, roles, and MFA status.</p>
              </div>
              <button type="button" className="app-button" onClick={handleEnableMfa} disabled={enableLoading}>
                {enableLoading ? "Enabling..." : "Enable MFA for me"}
              </button>
            </div>
            {enableError && <ErrorState message={enableError} />}
            {enableSuccess && <div style={successTextStyle}>{enableSuccess}</div>}

            {users.length === 0 ? (
              <div style={infoTextStyle}>No users found.</div>
            ) : (
              <table style={tableStyle}>
                <thead>
                  <tr>
                    <th style={thStyle}>Email</th>
                    <th style={thStyle}>Role</th>
                    <th style={thStyle}>MFA</th>
                    <th style={thStyle}>Created</th>
                    <th style={thStyle}>Last Login</th>
                  </tr>
                </thead>
                <tbody>
                  {users.map((user) => (
                    <tr key={user.id}>
                      <td style={tdStyle}>{user.email}</td>
                      <td style={tdStyle}><StatusChip tone="neutral">{user.role}</StatusChip></td>
                      <td style={tdStyle}><StatusChip tone={user.mfaEnabled ? "success" : "warning"}>{user.mfaEnabled ? "Enabled" : "Pending"}</StatusChip></td>
                      <td style={tdStyle}>{new Date(user.createdAt).toLocaleString()}</td>
                      <td style={tdStyle}>{user.lastLogin ? new Date(user.lastLogin).toLocaleString() : "Never"}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </section>
        </>
      )}
    </div>
  );
}

const pageTitleStyle: React.CSSProperties = {
  fontSize: "24px",
  fontWeight: 700,
  marginBottom: "8px",
};

const pageSubtitleStyle: React.CSSProperties = {
  color: "#4b5563",
  margin: 0,
  fontSize: "14px",
  maxWidth: "600px",
};

const summaryGridStyle: React.CSSProperties = {
  display: "grid",
  gap: "12px",
  gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))",
};

const cardStyle: React.CSSProperties = {
  backgroundColor: "#ffffff",
  borderRadius: "12px",
  padding: "20px",
  border: "1px solid #e2e8f0",
  boxShadow: "0 1px 2px rgba(15, 23, 42, 0.08)",
  display: "grid",
  gap: "12px",
};

const headerRowStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  gap: 12,
  flexWrap: "wrap",
};

const sectionTitleStyle: React.CSSProperties = {
  fontSize: "18px",
  fontWeight: 600,
  margin: 0,
};

const sectionSubtitleStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#4b5563",
  margin: 0,
};

const tableStyle: React.CSSProperties = {
  borderCollapse: "collapse",
  width: "100%",
};

const thStyle: React.CSSProperties = {
  textAlign: "left",
  padding: "10px 12px",
  fontSize: "12px",
  textTransform: "uppercase",
  letterSpacing: "0.06em",
  color: "#6b7280",
  borderBottom: "1px solid #e5e7eb",
};

const tdStyle: React.CSSProperties = {
  padding: "12px",
  fontSize: "14px",
  borderBottom: "1px solid #f1f5f9",
  color: "#111827",
};

const infoTextStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#6b7280",
};

const successTextStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#047857",
};



============================================================
FILE: C:\src\apgms-final\webapp\src\styles\global.css
============================================================
* {
  box-sizing: border-box;
}

html {
  font-family: var(--font-family-sans);
  line-height: var(--font-lineheight-relaxed);
  background-color: var(--color-background);
  color: var(--color-text);
}

body {
  margin: 0;
  min-height: 100vh;
  background-color: var(--color-background);
  color: var(--color-text);
}

h1,
 h2,
 h3,
 h4,
 h5,
 h6 {
  margin: 0;
  font-weight: var(--font-weight-semibold);
  line-height: var(--font-lineheight-tight);
}

p {
  margin: 0;
  line-height: var(--font-lineheight-cozy);
}

a {
  color: inherit;
}

table {
  border-collapse: collapse;
}

button,
 input,
 textarea,
 select {
  font: inherit;
}

/* ===== Status badges (a11y-compliant) ===== */

/* Generic badge structure â€“ keep whatever you already have */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: .35rem;
  padding: .15rem .5rem;
  border-radius: 9999px;
  font-weight: 600;
  line-height: 1.2;
}

/* Label vs hint (hint often rendered smaller) */
.status-badge__label { font-size: 12px; }
.status-badge__hint  { font-size: 10.4px; }

/* ACTIVE */
.status-badge--active {
  color: var(--status-active-fg);
  background-color: var(--status-active-bg);
}
.status-badge--active > .status-badge__hint {
  color: var(--status-active-hint-fg);
}

/* MONITORING */
.status-badge--monitoring {
  color: var(--status-monitor-fg);
  background-color: var(--status-monitor-bg);
}
.status-badge--monitoring > .status-badge__hint {
  color: var(--status-monitor-hint-fg);
}

/* PENDING */
.status-badge--pending {
  color: var(--status-pending-fg);
  background-color: var(--status-pending-bg);
}
.status-badge--pending > .status-badge__hint {
  color: var(--status-pending-hint-fg);
}



============================================================
FILE: C:\src\apgms-final\webapp\src\styles\themes.css
============================================================
:root {
  --font-heading: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
  --font-body: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
  --radius-sm: 6px;
  --radius-md: 10px;
  --shadow-card: 0 8px 20px rgba(0, 0, 0, 0.04);
  --shadow-soft: 0 2px 6px rgba(0, 0, 0, 0.06);
}

body.theme-navy {
  --bg: #f6f8fb;
  --surface: #ffffff;
  --surface-alt: #f0f4ff;
  --text: #0f172a;
  --muted: #475569;
  --border: #e2e8f0;
  --nav-bg: #0b1c38;
  --nav-text: #e2e8f0;
  --accent: #2563eb;
  --accent-strong: #1d4ed8;
  --success: #0f9b5f;
  --warning: #f97316;
  --danger: #dc2626;
}

body.theme-sunset {
  --bg: #fff8f2;
  --surface: #ffffff;
  --surface-alt: #ffe8d8;
  --text: #2d1b12;
  --muted: #5b4337;
  --border: #f3d8c4;
  --nav-bg: #2d1b12;
  --nav-text: #fcefe5;
  --accent: #ef6c41;
  --accent-strong: #d94b24;
  --success: #0f9b5f;
  --warning: #f59e0b;
  --danger: #c53030;
}

body.theme-forest {
  --bg: #f4f7f4;
  --surface: #ffffff;
  --surface-alt: #e8f5e9;
  --text: #0f2415;
  --muted: #3f6249;
  --border: #d7e7db;
  --nav-bg: #0f2415;
  --nav-text: #e6f1e9;
  --accent: #2f855a;
  --accent-strong: #276749;
  --success: #2f855a;
  --warning: #d97706;
  --danger: #b91c1c;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
}

a {
  color: var(--accent);
}

.app-card {
  background: var(--surface);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-card);
  border: 1px solid var(--border);
  padding: 16px;
}

.app-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: var(--surface-alt);
  color: var(--text);
  border: 1px solid var(--border);
  font-size: 12px;
  font-weight: 600;
}

.app-chip.success { color: var(--success); border-color: rgba(15,155,95,0.25); background: rgba(15,155,95,0.08); }
.app-chip.warning { color: var(--warning); border-color: rgba(247,115,22,0.25); background: rgba(247,115,22,0.1); }
.app-chip.danger { color: var(--danger); border-color: rgba(220,38,38,0.25); background: rgba(220,38,38,0.1); }

.app-button {
  border: none;
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  font-weight: 600;
  cursor: pointer;
  background: var(--accent);
  color: #ffffff;
  box-shadow: var(--shadow-soft);
  transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
}
.app-button:hover { background: var(--accent-strong); transform: translateY(-1px); }
.app-button:active { transform: translateY(0); box-shadow: none; }
.app-button.ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }

.app-skeleton {
  background: linear-gradient(90deg, rgba(0,0,0,0.04) 25%, rgba(0,0,0,0.08) 50%, rgba(0,0,0,0.04) 75%);
  background-size: 400% 100%;
  animation: shimmer 1.4s ease infinite;
  border-radius: var(--radius-sm);
}

@keyframes shimmer {
  0% { background-position: 100% 0; }
  100% { background-position: 0 0; }
}



============================================================
FILE: C:\src\apgms-final\webapp\src\styles\tokens.css
============================================================
:root {
  color-scheme: light;

  --color-background: #f4f6fb;
  --color-surface: #ffffff;
  --color-surface-muted: #eef1f8;
  --color-border: #d6dcea;
  --color-border-strong: #b5c2dd;
  --color-text: #1c1f2a;
  --color-text-muted: #566079;
  --color-primary: #005ad6;
  --color-primary-soft: rgba(0, 90, 214, 0.12);
  --color-primary-contrast: #ffffff;
  --color-success: #0a7d57;
  --color-warning: #b97318;
  --color-danger: #c44747;
  --color-focus: #8aa8ff;

  --spacing-3xs: 0.125rem;
  --spacing-2xs: 0.25rem;
  --spacing-xs: 0.5rem;
  --spacing-sm: 0.75rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  --spacing-2xl: 3rem;

  --radius-sm: 0.375rem;
  --radius-md: 0.75rem;
  --radius-lg: 1.25rem;
  --radius-pill: 999px;

  --font-family-sans: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
  --font-size-xs: 0.75rem;
  --font-size-sm: 0.875rem;
  --font-size-md: 1rem;
  --font-size-lg: 1.25rem;
  --font-size-xl: 1.75rem;
  --font-size-2xl: 2.5rem;
  --font-weight-regular: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-lineheight-tight: 1.2;
  --font-lineheight-cozy: 1.4;
  --font-lineheight-relaxed: 1.6;

  --shadow-sm: 0 6px 18px rgba(15, 23, 42, 0.08);
  --shadow-md: 0 16px 35px rgba(15, 23, 42, 0.15);

  /* ---- Status badge tokens (WCAG AA) ---- */
  /* Active (green) */
  --status-active-fg: #075a42;          /* darker for contrast */
  --status-active-hint-fg: #0a5a3f;     /* hint text (smaller size) */
  --status-active-bg: #eaf5f1;          /* lighter background */

  /* Monitoring (blue) */
  --status-monitor-fg: #1b57b8;         /* darker for contrast */
  --status-monitor-hint-fg: #184da3;
  --status-monitor-bg: #eef4fe;         /* lighter background */

  /* Pending (orange) */
  --status-pending-fg: #7a4900;         /* much darker for contrast */
  --status-pending-hint-fg: #6a3f00;
  --status-pending-bg: #fbefdb;         /* lighter background */
}

[data-theme='dark'] {
  color-scheme: dark;

  --color-background: #060912;
  --color-surface: #121829;
  --color-surface-muted: #111321;
  --color-border: #1f263a;
  --color-border-strong: #2d3753;
  --color-text: #ecf1ff;
  --color-text-muted: #9ca8c9;
  --color-primary: #7aa5ff;
  --color-primary-soft: rgba(122, 165, 255, 0.16);
  --color-primary-contrast: #0a101f;
  --color-success: #33d89a;
  --color-warning: #ffc35f;
  --color-danger: #ff897d;
  --color-focus: #a4c2ff;

  --shadow-sm: 0 6px 18px rgba(5, 11, 25, 0.5);
  --shadow-md: 0 20px 40px rgba(3, 8, 18, 0.6);
}



============================================================
FILE: C:\src\apgms-final\webapp\src\theme.tsx
============================================================
import React, { createContext, useContext, useEffect, useState } from "react";

export type ThemeName = "navy" | "sunset" | "forest";

type ThemeContextValue = {
  theme: ThemeName;
  setTheme: (t: ThemeName) => void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: "navy",
  setTheme: () => {},
});

const STORAGE_KEY = "apgms-theme";
const THEMES: ThemeName[] = ["navy", "sunset", "forest"];

export function ThemeProvider({ children }: { children: React.ReactNode }) {
  const [theme, setTheme] = useState<ThemeName>(() => {
    const stored = localStorage.getItem(STORAGE_KEY) as ThemeName | null;
    return stored && THEMES.includes(stored) ? stored : "navy";
  });

  useEffect(() => {
    const cls = `theme-${theme}`;
    document.body.classList.remove(
      ...THEMES.map((t) => `theme-${t}`),
    );
    document.body.classList.add(cls);
    localStorage.setItem(STORAGE_KEY, theme);
  }, [theme]);

  return (
    <ThemeContext.Provider value={{ theme, setTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}

export function useTheme() {
  return useContext(ThemeContext);
}



============================================================
FILE: C:\src\apgms-final\webapp\src\vite-env.d.ts
============================================================
/// <reference types="vite/client" />



============================================================
FILE: C:\src\apgms-final\webapp\tests\a11y.spec.ts
============================================================
import { test, expect } from "@playwright/test";
import AxeBuilder from "@axe-core/playwright";

//
// Update this if your preview server runs somewhere else in CI.
// In local dev you'd hit Vite at :5173, in CI maybe it's served differently.
// This constant is what replaces the hardcoded page.goto("http://localhost:5173/")
// from the single-page version.
//
const BASE_URL = "http://localhost:5173";

// Add every route in the web UI you consider user-facing / important.
const ROUTES = ["/", "/bank-lines"] as const;

test.describe("Accessibility regression checks (WCAG 2.1 A/AA)", () => {
  for (const route of ROUTES) {
    test(`route ${route} has no WCAG 2.1 A/AA violations of serious/critical impact`, async ({
      page,
    }, testInfo) => {
      // Navigate to full URL so we're not depending on playwright.config.ts baseURL
      await page.goto(`${BASE_URL}${route}`);
      await page.waitForLoadState("networkidle");

      // Run axe against this page
      const results = await new AxeBuilder({ page })
        // Enforce WCAG 2.0/2.1 A + AA rulesets. This matches common compliance targets.
        .withTags(["wcag2a", "wcag2aa"])
        .analyze();

      // Attach full axe JSON to the Playwright report/artifacts in CI
      await testInfo.attach(
        `axe-results-${route === "/" ? "home" : route.replace("/", "") || "root"}`,
        {
          body: JSON.stringify(results, null, 2),
          contentType: "application/json",
        }
      );

      //
      // We’ll fail the test if there are any violations that axe thinks are
      // "serious" or "critical". This preserves the intent of your original
      // single-page test.
      //
      const seriousOrWorse = results.violations.filter((v) =>
        ["serious", "critical"].includes(v.impact ?? "")
      );

      expect(
        seriousOrWorse,
        [
          "Found accessibility violations with serious/critical impact.",
          "See attached axe-results-* artifact in CI for details.",
          JSON.stringify(seriousOrWorse, null, 2),
        ].join("\n\n")
      ).toEqual([]);

      //
      // Optional stricter mode:
      // If you want to block on ANY A/AA violation (not just serious/critical),
      // uncomment this block and remove the seriousOrWorse assertion above.
      //
      // expect(
      //   results.violations,
      //   JSON.stringify(results.violations, null, 2)
      // ).toEqual([]);
    });
  }
});



============================================================
FILE: C:\src\apgms-final\webapp\tests\axe.spec.ts
============================================================
import AxeBuilder from '@axe-core/playwright';
import { expect, test } from '@playwright/test';

const routes = ['/', '/bank-lines'] as const;

for (const route of routes) {
  test.describe(`Accessibility for ${route}`, () => {
    test(`should have no detectable Axe violations on ${route}`, async ({ page }) => {
      await page.goto(route);
      await page.waitForLoadState('networkidle');

      const results = await new AxeBuilder({ page })
        .withTags(['wcag2a', 'wcag2aa'])
        .analyze();

      expect(results.violations).toEqual([]);
    });
  });
}



============================================================
FILE: C:\src\apgms-final\webapp\tsconfig.json
============================================================
{
  "compilerOptions": {
    "target": "ESNext",
    "useDefineForClassFields": true,
    "lib": ["DOM", "DOM.Iterable", "ESNext"],
    "module": "ESNext",
    "moduleResolution": "Node",
    "moduleDetection": "force",
    "jsx": "react-jsx",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "isolatedModules": true
  },
  "include": ["src"],
  "exclude": [
    // Legacy/unwired routes that currently break type resolution; keep for reference but exclude from checks
    "src/routes/OnboardingWizard.tsx",
    "src/pages/OnboardingWizard.tsx",
    "src/router.tsx"
  ]
}



============================================================
FILE: C:\src\apgms-final\webapp\types\axe-core.d.ts
============================================================
declare module "axe-core";




============================================================
FILE: C:\src\apgms-final\webapp\vite.config.ts
============================================================
// services/webapp/vite.config.ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    strictPort: true,
    port: 5173,
    host: "0.0.0.0",
  },
});



============================================================
FILE: C:\src\apgms-final\worker\package.json
============================================================
{
    "name":  "@apgms/worker",
    "version":  "0.1.0",
    "type":  "module",
    "main":  "dist/index.js",
    "scripts":  {
                    "build":  "echo build worker",
                    "test":  "echo test worker",
                    "typecheck":  "echo no typecheck for worker"
                }
}



============================================================
FILE: C:\src\apgms-final\worker\src\index.ts
============================================================
import { resolve } from "node:path";
import { fileURLToPath } from "node:url";

import { runNightlyDesignatedAccountReconciliation } from "./jobs/designated-reconciliation.js";

export { runNightlyDesignatedAccountReconciliation } from "./jobs/designated-reconciliation.js";

const modulePath = fileURLToPath(import.meta.url);
const invokedPath = process.argv[1] ? resolve(process.argv[1]) : null;

if (invokedPath && resolve(modulePath) === invokedPath) {
  runNightlyDesignatedAccountReconciliation()
    .then(() => {
      process.stdout.write("Designated account reconciliation completed\n");
    })
    .catch((error) => {
      console.error("Designated account reconciliation failed", error);
      process.exitCode = 1;
    });
}




============================================================
FILE: C:\src\apgms-final\worker\src\jobs\designated-reconciliation.ts
============================================================
import {
  safeLogAttributes,
  safeLogError,
} from "@apgms/shared";
import { prisma } from "@apgms/shared/db.js";
import {
  generateDesignatedAccountReconciliationArtifact,
} from "@apgms/domain-policy";
import {
  applyPendingContributions,
  summarizeContributions,
} from "@apgms/shared/ledger/ingest.js";
import {
  DesignatedAccountType,
  ensureDesignatedAccountCoverage,
} from "@apgms/shared/ledger/designated-account.js";

const SYSTEM_ACTOR = "system";

async function recordAuditLog(entry: {
  orgId: string;
  actorId: string;
  action: string;
  metadata: Record<string, unknown>;
}): Promise<void> {
  await prisma.auditLog.create({
    data: {
      orgId: entry.orgId,
      actorId: entry.actorId,
      action: entry.action,
      metadata: entry.metadata,
    },
  });
}

export async function runNightlyDesignatedAccountReconciliation(): Promise<void> {
  const organisations = await prisma.org.findMany({
    select: { id: true },
  });
  const runStart = Date.now();
  let processed = 0;
  let successes = 0;
  let failures = 0;
  const failureDetails: Array<{ orgId: string; error: string }> = [];

  console.info(
    "designated-account-reconciliation: starting",
    safeLogAttributes({ orgCount: organisations.length }),
  );

  for (const org of organisations) {
    const orgStart = Date.now();
    try {
      await applyPendingContributions({
        prisma,
        orgId: org.id,
        actorId: SYSTEM_ACTOR,
        auditLogger: recordAuditLog,
      });

      const totals = await summarizeContributions(prisma, org.id);
      const latestCycle = await prisma.basCycle.findFirst({
        where: { orgId: org.id },
        orderBy: { periodStart: "desc" },
      });

      if (latestCycle) {
        await ensureDesignatedAccountCoverage(
          prisma,
          org.id,
          "PAYGW_BUFFER",
          Number(latestCycle.paygwRequired),
        );
        await ensureDesignatedAccountCoverage(
          prisma,
          org.id,
          "GST_BUFFER",
          Number(latestCycle.gstRequired),
        );
      }

      const { artifactId, sha256, summary } =
        await generateDesignatedAccountReconciliationArtifact(
          {
            prisma,
            auditLogger: recordAuditLog,
          },
          org.id,
          SYSTEM_ACTOR,
        );
      const durationMs = Date.now() - orgStart;

      successes += 1;
      console.info(
        "designated-account-reconciliation: artifact generated",
        safeLogAttributes({
          orgId: org.id,
          artifactId,
          sha256,
          totals: summary.totals,
          durationMs,
          contributions: totals,
        }),
      );
    } catch (error) {
      failures += 1;
      console.error(
        "designated-account-reconciliation: org failed",
        safeLogError(error),
        safeLogAttributes({ orgId: org.id }),
      );
      failureDetails.push({
        orgId: org.id,
        error:
          error instanceof Error
            ? error.message
            : typeof error === "string"
              ? error
              : (() => {
                try {
                  return JSON.stringify(error);
                } catch {
                  return "unknown_error";
                }
              })(),
      });
    } finally {
      processed += 1;
    }
  }

  console.info(
    "designated-account-reconciliation: run summary",
    safeLogAttributes({
      orgCount: organisations.length,
      processed,
      successes,
      failures,
      failureDetails,
      durationMs: Date.now() - runStart,
    }),
  );
}



