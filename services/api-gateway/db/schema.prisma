// services/api-gateway/db/schema.prisma

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Schedule {
  MONTHLY
  QUARTERLY
}

model Organization {
  id        String @id @default(cuid())
  abn       String @unique
  legalName String

  // Who created this organisation record (onboarding user)
  createdByUserId String?
  createdByUser   User?   @relation("Organization_createdByUserId", fields: [createdByUserId], references: [id])

  // Schedule + shortfall threshold for secured tax buffers
  schedule              Schedule @default(QUARTERLY)
  shortfallThresholdBps Int      @default(500)

  designatedAccounts DesignatedAccount[]
  obligationHistory  ObligationHistory[]
}

model DesignatedAccount {
  id          String @id @default(cuid())
  orgId       String
  type        String
  provider    String
  mandateId   String?
  displayName String?

  organization Organization @relation(fields: [orgId], references: [id])

  // One designated account per org + tax type
  @@unique([orgId, type], name: "orgId_type")
}

model ObligationHistory {
  id        String   @id @default(cuid())
  orgId     String
  type      String   // "GST" | "PAYGW" | "PAYGI"
  period    String   // "YYYY-MM" or "YYYY-Qn"
  cents     Int
  source    String   // "import", "statement", "manual"
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id])

  @@index([orgId, type, period])
}

model User {
  id           String @id @default(cuid())
  email        String @unique
  passwordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationsCreated Organization[] @relation("Organization_createdByUserId")
}

// =============================
// AU Tax Config (versioned, provenance-friendly)
// =============================

enum AuTaxType {
  PAYGW
  GST
  HELP
  STSL
}

enum AuTaxRateTableKind {
  PAYGW_WITHHOLDING
  GST_RULES
  HELP_STSL_SCHEDULE
}

enum TaxConfigStatus {
  DRAFT
  ACTIVE
  RETIRED
}

model AuTaxParameterSet {
  id            String           @id @default(cuid())
  taxType        AuTaxType
  status         TaxConfigStatus @default(ACTIVE)

  /// Inclusive start date for this parameter set.
  effectiveFrom  DateTime
  /// Inclusive end date (optional). When a new set becomes effective, you close the old one.
  effectiveTo    DateTime?

  /// Provenance (ATO source reference + hash for evidence)
  sourceName     String
  sourceRef      String?
  sourceHash     String
  retrievedAt    DateTime?

  tables         AuTaxRateTable[]

  /// Change audit (optional but useful for the rule-update worker)
  changesAsNew   AuTaxRuleChange[] @relation("AuTaxRuleChange_NewSet")
  changesAsOld   AuTaxRuleChange[] @relation("AuTaxRuleChange_OldSet")

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([taxType, effectiveFrom])
  @@index([taxType, effectiveFrom, effectiveTo])
}

model AuTaxRateTable {
  id              String            @id @default(cuid())
  parameterSetId  String
  parameterSet    AuTaxParameterSet @relation(fields: [parameterSetId], references: [id], onDelete: Cascade)

  kind            AuTaxRateTableKind
  name            String?
  /// Canonical table payload (brackets, rates, rules) lives here.
  payload         Json
  /// Optional content hash of the payload for evidence/provenance.
  payloadHash     String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([parameterSetId, kind])
  @@index([kind])
}

model AuTaxRuleChange {
  id                String            @id @default(cuid())
  taxType            AuTaxType
  kind               AuTaxRateTableKind

  oldParameterSetId  String?
  oldParameterSet    AuTaxParameterSet? @relation("AuTaxRuleChange_OldSet", fields: [oldParameterSetId], references: [id])

  newParameterSetId  String
  newParameterSet    AuTaxParameterSet  @relation("AuTaxRuleChange_NewSet", fields: [newParameterSetId], references: [id])

  effectiveFrom      DateTime
  diffSummary        Json?
  sourceRef          String?
  sourceHash         String

  appliedBy          String            @default("system")
  appliedAt          DateTime          @default(now())

  @@index([taxType, kind, effectiveFrom])
}
