#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$ROOT"

PACK_DIR="$ROOT/agent-pack"
PROMPTS_DIR="$PACK_DIR/prompts"
LOG_DIR="$ROOT/artifacts/agent-pack-logs"

rm -rf "$PACK_DIR"
mkdir -p "$PROMPTS_DIR" "$LOG_DIR"

write_b64() {
  local path="$1"
  local b64="$2"
  mkdir -p "$(dirname "$path")"
  printf "%s" "$b64" | base64 -d > "$path"
  sed -i 's/\r$//' "$path" || true
}

# agent-pack/README.md
write_b64 "$PACK_DIR/README.md" "IyBDb2RleCBBZ2VudCBQYWNrOiBBUEdNUyAtIEZpeCBhcGktZ2F0ZXdheSB0ZXN0cyArIHJlYWRpbmVzcwoKIyMgR29hbAojIE1ha2UgdGhlc2UgcGFzczoKLSBgcG5wbSAtLWZpbHRlciBAYXBnbXMvYXBpLWdhdGV3YXkgdGVzdGAgZXMgR1JFRU4uCi0gYHBucG0gdGVzdGAgZnJvbSByZXBvIHJvb3QgaXMgR1JFRU4uCi0gYHBucG0gcmVhZGluZXNzOmFsbGAgKGxvY2FsKSBiZWNvbWVzIEdSRUVOIChyZWFkaW5lc3MgY2hlY2sgc2hvdWxkIGJlIE1BU1QgaW4gc3luYyB3aXRoIHJvdXRlcykuCgojIyBIb3cgdG8gcnVuCjEpIFJ1biB0aGUgcnVubmVyOgogICBgYmFzaCBzY3JpcHRzL2FnZW50L3J1bi1jb2RleC1hZ2VudC1wYWNrLnNoYAoKMikgSWYgeW91IGRvbid0IGhhdmUgdGhlIENvZGV4IENMSSBpbnN0YWxsZWQsIHRoZSBydW5uZXIgcHJpbnRzIHRoZSBleGFjdCBwcm9tcHQgdG8gcGFzdGUgaW50byB5b3VyIENvZGV4IFVJLCBhbmQgdGhlIGV4YWN0IGNvbW1hbmRzIHRvIHJ1biBhZnRlciBjaGFuZ2VzLgo="

# agent-pack/prompts/01-fix-api-gateway-and-readiness.md
write_b64 "$PROMPTS_DIR/01-fix-api-gateway-and-readiness.md" "WW91IGFyZSB3b3JraW5nIGluIHRoZSBBUEdNUyByZXBvc2l0b3J5LgoKUHJpbWFyeSBhY2NlcHRhbmNlIGNyaXRlcmlhIChtdXN0IGFsbCBwYXNzKToKMSkgYHBucG0gLS1maWx0ZXIgQGFwZ21zL2FwaS1nYXRld2F5IHRlc3RgIGlzIEdSRUVOLgoyKSBgcG5wbSB0ZXN0YCBmcm9tIHJlcG8gcm9vdCBpcyBHUkVFTi4KMykgYHBucG0gcmVhZGluZXNzOmFsbGAgKGlmIGl0IHJlcXVpcmVzIGFuIEFQSSBydW5uaW5nLCBlbnN1cmUgdGhlIHJ1bm5lciBjYW4gc3RhcnQgaXQgb3IgZG9jdW1lbnQgb25lIGNvbW1hbmQpIGlzIEdSRUVOLgoyKSBETyBOT1QgZG8gYnJvYWQgcmVmYWN0b3JzLiBNaW5pbWFsLCBzdXJnaWNhbCBjaGFuZ2VzIG9ubHkuIEFTQ0lJIG9ubHkuIEtlZXAgZXhpc3RpbmcgY29udmVudGlvbnMuCgpPYnNlcnZlZCBmYWlsdXJlcyB5b3UgbXVzdCBlbGltaW5hdGUgKGZyb20gY3VycmVudCBKZXN0IG91dHB1dCk6Ci0gTWFueSByb3V0ZXMgcmV0dXJuIDQwNCBhbmQgbXVzdCBleGlzdCB3aXRoIGNvcnJlY3QgYmVoYXZpb3I6CiAgLSBHRVQgYC9oZWFsdGhgIC0+IDIwMCBgeyBvazogdHJ1ZSB9YAogIC0gR0VUIAAvaGVhbHRoL2xpdmUgLT4gMjAwIGB7IG9rOiB0cnVlIH1gCiAgLSBHRVQgYC9oZWFsdGgvcmVhZHlgOgogICAgICAtIDIwMCBgeyBvazogdHJ1ZSwgY2hlY2tzOiB7IGRiOiB0cnVlIH0gfWBgIHdoZW4gREIgaXMgcmVhY2hhYmxlCiAgICAgIC0gNTAzIGB7IG9rOiBmYWxzZSwgY2hlY2tzOiB7IGRiOiBmYWxzZSB9IH1gYCB3aGVuIERCIGlzIHVucmVhY2hhYmxlICh0ZXN0LWNvbnRyb2xsZWQpCiAgLSBHRVQgYC9tZXRyaWNzYCBtdXN0IHJldHVybiBQcm9tZXRoZXVzIHRleHQgdGhhdCBpbmNsdWRlczoKICAgICAgLSBgcHJvY2Vzc19jcHVfdXNlcl9zZWNvbmRzX3RvdGFsYAogICAgICAtIGBhcGdtc19odHRwX3JlcXVlc3RzX3RvdGFsYAogICAgICAtIGBhcGdtc19kYl9xdWVyeV9kdXJhdGlvbl9zZWNvbmRzYAoKLSBSZWFkaW5lc3MgY3VycmVudGx5IGNoZWNrcyBgL3JlYWR5YCBhbmQgZ2V0cyA0MDQgLiBGaXggdmlhIG9uZSBvZjoKICAtIEltcGxlbWVudCBHRVQgYC9yZWFkeWAgKGFsaWFzIHRvIHJlYWR5IGNoZWNrKSwgT1IKICAtIFVwZGF0ZSByZWFkaW5lc3MgY2hlY2sgbG9naWMgdG8gdXNlIGAvaGVhbHRoL3JlYWR5YC4KICBQcmVmZXIgYWRkaW5nIGAvcmVhZHlgIGZvciBjb21wYXRpYmlsaXR5LgoKLSBTZXR0bGVtZW50cyByb3V0ZSBzdWl0ZSBpcyBmYWlsaW5nIGFzIDQwNDoKICAtIFBPU1QgYC9hcGkvc2V0dGxlbWVudHMvYmFzYCBtdXN0IGV4aXN0LgogIC0gV2hlbiBBdXRob3JpemF0aW9uIGhlYWRlciBtaXNzaW5nIC0+IDQwMSAobm90IDQwNCkuCiAgLSBXaGVuIGF1dGhvcml6ZWQgKyB2YWxpZCBwYXlsb2FkIC0+IDIwMSB3aXRoIEpTT04gY29udGFpbmluZyBgSW5zdHJ1Y3Rpb25JZGAgYW5kIGV4cGVjdGVkIGZpZWxkcy4KICAtIElkZW1wb3RlbmN5OgogICAgICAtIER1cGxpY2F0ZSBJZGVtcG90ZW5jeS1LZXkgaWRlbnRpY2FsIHBheWxvYWQgLT4gcmVwbGF5IHNhbWUgMjAxICsgc2FtZSBib2R5LgogICAgICAtIFJldXNlIHNhbWUgSWRlbXBvdGVuY3ktS2V5IHdpdGggZGlmZmVyZW50IHBheWxvYWQgLT4gNDA5LgoKLSBQcm90b3R5cGUgcm91dGVzIGZhaWxpbmc6CiAgLSBgL21vbml0b3Ivcmlzay9zdW1tYXJ5YCBiZWhhdmlvcjoKICAgICAgLSBJbiBwcm9kdWN0aW9uOiBhbHdheXMgNDA0IChldmVuIGFkbWluKS4KICAgICAgLSBJbiBub24tcHJvZDogbm9uLWFkbWluIC0+IDQwMyBgeyBlcnJvcjogImFkbWluX29ubHlfcHJvdG90eXBlIiB9YAogICAgICAtIEluIG5vbi1wcm9kOiBhZG1pbiAtPiAyMDAgKGFueSBzaW1wbGUgSlNPTiBvaykuCgogLSBSZWd1bGF0b3IgY29tcGxpYW5jZSBzdW1tYXJ5IGUyZSBmYWlsaW5nIGJlY2F1c2UgYChhcHAgYXMgYW55KS5kYmAgdW5kZWZpbmVkIGluIHRlc3RzOgogIC0gRW5zdXJlIGJ1aWxkRmFzdGlmeUFwcCAob3Igd2hhdGV2ZXIgZmFjdG9yeSB0ZXN0cyB1c2UpIGF0dGFjaGVzIGBhcHAuZGJgIHdoZW4gYGluTWVtb3J5RGI6IHRydWVgLgogIC0gUHJvdmlkZSBpbi1tZW1vcnkgbW9kZWxzIHVzZWQgYnkgdGhlIHRlc3Q6CiAgICAgIC0gYGRiLnBheXJvbGxJdGVtLmNyZWF0ZSh7IGRhdGE6IC4uLiB9KWAKICAgICAgLSBgZGIuZ3N0VHJhbnNhY3Rpb24uY3JlYXRlKHsgZGF0YTogLi4uIH0pYAogIC0gYC9yZWd1bGF0b3IvY29tcGxpYW5jZS9zdW1tYXJ5YCBtdXN0IHByb2R1Y2UgSElHSCByaXNrIHdoZW4gbGVkZ2VyIGlzIGVtcHR5IGJ1dCBzZWVkZWQgb2JsaWdhdGlvbnMgZXhpc3QgKHBlciB0ZXN0IGV4cGVjdGF0aW9ucykuCgogLSBDT1JTIHByb2R1Y3Rpb24gYWxsb3dsaXN0IHRlc3RzIGZhaWxpbmc6CiAgLSBJbiBwcm9kdWN0aW9uLCBpZiBhbGxvd2xpc3QgaXMgZW1wdHkgLT4gYnVpbGRGYXN0aWZ5QXBwIHNob3VsZCB0aHJvdyBtYXRjaGluZyBgL0NPUlNfQUxMT1dFRF9PUklHSU5TL2AuCiAgLSBJbiBwcm9kdWN0aW9uLCBpZiBPcmlnaW4gbm90IGFsbG93bGlzdGVkIC0+IDQwMyBgeyBlcnJvcjogImNvcnNfb3JpZ2luX2ZvcmJpZGRlbiIgfWAuCiAgLSBJbiBwcm9kdWN0aW9uLCBpZiBPcmlnaW4gYWxsb3dsaXN0ZWQgLT4gYWxsb3cgYW5kIHNldCBgQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luYCB0byBvcmlnaW4uCiAgLSBFbnN1cmUgT1BUSU9OUyBwcmVmbGlnaHQgYWxzbyByZXNwZWN0cyBhbGxvd2xpc3QgKHRlc3RzIHNob3cgMjA0IGN1cnJlbnRseSkuCgpJbXBsZW1lbnRhdGlvbiBndWlkYW5jZToKLSBJZGVudGlmeSB0aGUgYXBwIGZhY3RvcnkgdXNlZCBieSB0ZXN0cyAoZXh0cmVtZWx5IGxpa2VseSBgYnVpbGRGYXN0aWZ5QXBwYCkgYW5kIGVuc3VyZSBpdCByZWdpc3RlcnMgYWxsIHJvdXRlcy9wbHVnaW5zIHVzZWQgaW4gdGVzdHMuCi0gUHJlZmVyIGEgc2luZ2xlIGNvbXBhdCBwbHVnaW4gdGhhdCByZWdpc3RlcnMgbWlzc2luZyBlbmRwb2ludHMgYW5kIHJldXNlcyBleGlzdGluZyBpbnRlcm5hbHMgaWYgcHJlc2VudC4KLSBLZWVwIGJlaGF2aW9yIGRldGVybWluaXN0aWMgYW5kIHRlc3QtZnJpZW5kbHkuIFVzZSBleGlzdGluZyBwYXR0ZXJucyBmb3IgY29uZmlnT3ZlcnJpZGVzL2Vudmlyb25tZW50L2luTWVtb3J5RGIuCgotIEFmdGVyIGNoYW5nZXMsIHJ1bjoKICAtIGBwbm1wIC0tZmlsdGVyIEBhcGdtcy9hcGktZ2F0ZXdheSB0ZXN0YAogIC0gYHBucG0gdGVzdGAKICAtIGBwbm1wIHJlYWRpbmVzczphbGxgCgpEZWxpdmVyYWJsZXM6Ci0gQ29tbWl0LXJlYWR5IGNvZGUgY2hhbmdlcyBvbmx5LiBObyBjb21tZW50YXJ5LiBLZWVwIGRpZmZzIG1pbmltYWwuCg=="

# scripts/agent/run-codex-agent-pack.sh
write_b64 "$ROOT/scripts/agent/run-codex-agent-pack.sh" "IyEvdXNyL2Jpbi9lbnYgYmFzaApzZXQgLWV1byBwaXBlZmFpbAoKUk9PVD0iJChjZCAiJChkaXJuYW1lICIke0JBU0hfU09VUkNFWzBdfSIpLy4uLy4uIiAmJiBwd2QpIgpjZCAiJFJPT1QiCgpMT0dfRElSPSIkUk9PVC9hcnRpZmFjdHMvYWdlbnQtcGFjay1sb2dzIgpta2RpciAtcCAiJExPR19ESVIiClJVTl9JRD0iJChkYXRlIC11ICslWSVtJWQlZEglTSVNWikpIgpMT0c9IiRMT0dfRElSL2NvZGV4LWFnZW50LXBhY2stJFJVTl9JRC5sb2ciCgplY2hvICJbcnVuXSByZXBvPSRST09UIiB8IHRlZSAiJExPRyIKZWNobyAiW3J1bl0gbG9nPSRMT0ciIHwgdGVlIC1hICIkTE9HIgoKUFJPTVBUX0ZJTEU9IiRST09UL2FnZW50LXBhY2svcHJvbXB0cy8wMS1maXgtYXBpLWdhdGV3YXktYW5kLXJlYWRpbmVzcy5tZCIKaWYgW1sgISAtZiAiJFBST01QVF9GSUxFIiBdXTsgdGhlbgogIGVjaG8gIltidW4gRVJST1JdIG1pc3NpbmcgJFBST01QVF9GSUxFIiB8IHRlZSAtYSAiJExPRyIKICBleGl0IDIKZmkKCmlmIGNvbW1hbmQgLXYgY29kZXggPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgZWNobyAiW3J1bl0gY29kZXggQ0xJIGRldGVjdGVkOyBwaXBpbmcgcHJvbXB0LiIgfCB0ZWUgLWEgIiRMT0ciCiAgY29kZXggPCAiJFBST01QVF9GSUxFIiAyPiYxIHwgdGVlIC1hICIkTE9HIiB8fCB0cnVlCiAgZWNobyAiW3J1bl0gY29kZXggZmluaXNoZWQgKG9yIG5vbi16ZXJvKS4gTm93IHJ1biB0ZXN0cy4iIHwgdGVlIC1hICIkTE9HIgplbHNlCiAgZWNobyAiW3J1bl0gQ29kZXggQ0xJIG5vdCBmb3VuZC4gUGFzdGUgdGhpcyBwcm9tcHQgaW50byBDb2RleCBVSToiIHwgdGVlIC1hICIkTE9HIgogIGVjaG8gIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSIgfCB0ZWUgLWEgIiRMT0ciCiAgY2F0ICIkUFJPTVBUX0ZJTEUiIHwgdGVlIC1hICIkTE9HIgogIGVjaG8gIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSIgfCB0ZWUgLWEgIiRMT0ciCmZpCgpjYXQgPDwnQ01EUycgfCB0ZWUgLWEgIiRMT0ciCmNkIH4vc3JjL0FQR01TCnBucG0gLS1maWx0ZXIgQGFwZ21zL2FwaS1nYXRld2F5IHRlc3QKcG5wbSB0ZXN0CnBucG0gcmVhZGluZXNzOmFsbApDTURTCgplY2hvICJbcnVuXSBkb25lIiB8IHRlZSAiJExPRyIK"

chmod +x scripts/agent/run-codex-agent-pack.sh
sed -i 's/\r$//' scripts/agent/run-codex-agent-pack.sh || true

echo "[bootstrap] OK. Next: bash scripts/agent/run-codex-agent-pack.sh"
