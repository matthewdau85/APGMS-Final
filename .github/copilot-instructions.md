# Copilot / AI assistant instructions for APGMS

Keep guidance short and actionable. When making changes, prefer small, testable commits and reference the files noted below.

Key concepts and architecture
- Monorepo managed with pnpm (see `package.json` and `pnpm-workspace.yaml`). Workspaces: `services/*`, `webapp`, `shared`, `worker`.
- API services are Fastify + Prisma (example: `services/api-gateway/src/app.ts`, `services/*/src`). Database models live in `shared/prisma/schema.prisma` and the Prisma client is exposed from `shared/src/db.ts` as `prisma` / `db`.
- Shared utilities (masking, helpers) live in `shared/src` and are imported with the `@apgms/*` path (e.g. `@apgms/shared`).
- Web frontend is a Vite + React/TS app in `webapp/` (entry: `webapp/src/main.tsx`, Playwright tests in `webapp/tests`).

Common developer workflows (commands you should use)
- Install and bootstrap: `pnpm install --frozen-lockfile` (corepack recommended).
- Build all packages: `pnpm -r build` (root `package.json` delegates to workspace scripts).
- Run all tests: `pnpm -r test`.
- Run webapp E2E locally: use `scripts/run-webapp-tests.ps1` which:
  - writes a `playwright.config.ts`, ensures `webapp/package.json` scripts (`dev`, `build`, `preview`) exist, installs deps and Playwright browsers, optionally starts `services/api-gateway` (dev) and runs `pnpm -r test`.
- Quick local dev: `pnpm -w exec playwright test` (root README shows examples) or `pnpm -w exec vite` inside `webapp` for dev server.
- Prisma DB tasks (run from repo root):
  - `pnpm --filter @apgms/shared exec prisma generate --schema prisma/schema.prisma` (db client)
  - `pnpm --filter @apgms/shared exec prisma migrate dev --schema prisma/schema.prisma` (local migrations)
  - `pnpm --filter @apgms/shared exec prisma migrate deploy --schema prisma/schema.prisma` (deploy)

Project-specific conventions and patterns
- Auth: services use a simple base64url-encoded JSON Bearer token for request principal. See `services/api-gateway/src/app.ts` (functions `extractPrincipal` and `PrincipalSchema`) for the exact shape: { id, orgId, role }.
- Admin operations use `ADMIN_TOKEN` environment variable and the header `x-admin-token` (see `requireAdmin`).
- Idempotency: POST /bank-lines supports `Idempotency-Key` header. The DB has a compound unique on `[orgId, idempotencyKey]` to dedupe requests (see `shared/prisma/schema.prisma` and `api-gateway` upsert logic).
- Error & secret handling: use `@apgms/shared/masking.ts` helpers (`maskObject`, `maskError`) before logging or returning structured errors.
- Database URL handling: `shared/src/db.ts` expects `DATABASE_URL` env var and throws if missing â€” when running services in dev ensure `.env` exists at repo root or set process envs. `services/api-gateway/src/index.ts` loads repo-root `.env`.

Integration points & external deps
- Postgres via `DATABASE_URL` (Prisma). See `shared/prisma/schema.prisma` for models.
- Playwright for E2E tests; Playwright browsers are installed by `pnpm exec playwright install --with-deps` (see `scripts/run-webapp-tests.ps1`).
- Docker: `docker-compose.yml` can bootstrap services for integration testing; root README suggests `docker compose up -d` after `pnpm -r build`.

Files to reference when changing behavior
- API routes and auth: `services/api-gateway/src/app.ts`, `services/*/src` for other services.
- DB client and models: `shared/src/db.ts`, `shared/prisma/schema.prisma`.
- Logging and masking: `shared/src/masking.ts`.
- E2E helper script: `scripts/run-webapp-tests.ps1` and `webapp/playwright.config.ts` (generated by the script).
- Workspace config: `package.json`, `pnpm-workspace.yaml`.

Examples (copy/paste ready)
- Start full dev & tests (Windows PS):
  pnpm install --frozen-lockfile; pnpm -r build; docker compose up -d; pnpm -r test
- Run webapp E2E with API start (PS):
  .\scripts\run-webapp-tests.ps1 -StartApi

When editing code
- Keep changes scoped to one package when possible and run that package's tests.
- If you change the Prisma schema, update `@apgms/shared` client: run `pnpm --filter @apgms/shared exec prisma generate --schema shared/prisma/schema.prisma` and run migrations locally (`migrate dev`) when appropriate.

What not to change without human review
- Global workspace scripts/CI, `pnpm-workspace.yaml`, and schema migrations that affect production data.

If anything here is unclear or you need more examples (tests to run, env values to set, or common developer mistakes to avoid), tell me which area to expand and I will iterate.
