};

const designatedBalanceStyle: React.CSSProperties = {
  fontSize: "20px",
  fontWeight: 800,
};

const designatedMetaStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#6b7280",
};

const ledgerCardStyle: React.CSSProperties = {
  backgroundColor: "#ffffff",
  borderRadius: "12px",
  padding: "24px",
  border: "1px solid #e2e8f0",
  boxShadow: "0 1px 2px rgba(15, 23, 42, 0.08)",
  display: "grid",
  gap: "12px",
};

const ledgerHeaderStyle: React.CSSProperties = {
  display: "flex",
  alignItems: "center",
  justifyContent: "space-between",
  gap: "12px",
  flexWrap: "wrap",
};

const ledgerTitleStyle: React.CSSProperties = {
  fontSize: "18px",
  fontWeight: 700,
  margin: 0,
};

const ledgerSubtitleStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#4b5563",
  margin: 0,
};

const tableStyle: React.CSSProperties = {
  borderCollapse: "collapse",
  width: "100%",
};

const thStyle: React.CSSProperties = {
  textAlign: "left",
  padding: "10px 12px",
  fontSize: "12px",
  textTransform: "uppercase",
  letterSpacing: "0.06em",
  color: "#6b7280",
  borderBottom: "1px solid #e5e7eb",
};

const tdStyle: React.CSSProperties = {
  padding: "12px",
  fontSize: "14px",
  borderBottom: "1px solid #f1f5f9",
  color: "#111827",
};

const ledgerFormStyle: React.CSSProperties = {
  display: "grid",
  gap: "12px",
  marginTop: "12px",
};

const formGridStyle: React.CSSProperties = {
  display: "grid",
  gap: "12px",
  gridTemplateColumns: "repeat(auto-fit, minmax(220px, 1fr))",
};

const formLabelStyle: React.CSSProperties = {
  display: "grid",
  gap: "4px",
  fontSize: "14px",
  color: "#111827",
};

const formInputStyle: React.CSSProperties = {
  padding: "10px",
  borderRadius: "8px",
  border: "1px solid #e2e8f0",
  fontSize: "14px",
};

const infoTextStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#6b7280",
};

const errorTextStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#b91c1c",
};



============================================================
FILE: C:\src\apgms-final\webapp\src\DemoPage.tsx
============================================================
import React, { useMemo, useState } from "react";
import {
  compileDemoBas,
  generateDemoBankLines,
  runDemoPayroll,
} from "./api";
import { getToken } from "./auth";
import { ErrorState, SkeletonBlock, StatusChip } from "./components/UI";

type BankFeedState = {
  busy: boolean;
  summary?: string;
  rows?: Array<{ id: string; amount: number; date: string }>;
  error?: string;
};

type PayrollState = {
  busy: boolean;
  summary?: string;
  error?: string;
};

type BasState = {
  busy: boolean;
  summary?: string;
  error?: string;
};

export default function DemoPage() {
  const token = getToken();
  const [bankState, setBankState] = useState<BankFeedState>({ busy: false });
  const [demoDays, setDemoDays] = useState(7);
  const [demoIntensity, setDemoIntensity] = useState<"low" | "high">("low");
  const [payrollState, setPayrollState] = useState<PayrollState>({ busy: false });
  const [includeBank, setIncludeBank] = useState(true);
  const [basState, setBasState] = useState<BasState>({ busy: false });
  const [basPeriod, setBasPeriod] = useState({ year: new Date().getFullYear(), month: new Date().getMonth() + 1 });

  const bankSection = useMemo(() => {
    if (!bankState.summary) return null;
    return <pre style={preStyle}>{bankState.summary}</pre>;
  }, [bankState.summary]);

  const payrollSection = useMemo(() => {
    if (!payrollState.summary) return null;
    return <pre style={preStyle}>{payrollState.summary}</pre>;
  }, [payrollState.summary]);

  const basSection = useMemo(() => {
    if (!basState.summary) return null;
    return <pre style={preStyle}>{basState.summary}</pre>;
  }, [basState.summary]);

  async function handleGenerateBankFeed() {
    if (!token) return;
    setBankState({ busy: true });
    try {
      const response = await generateDemoBankLines(token, {
        daysBack: demoDays,
        intensity: demoIntensity,
      });
      setBankState({
        busy: false,
        summary: JSON.stringify(response, null, 2),
        rows: response.rows,
      });
    } catch (err) {
      console.error(err);
      setBankState({ busy: false, error: "Unable to generate bank feed" });
    }
  }

  async function handleRunPayroll() {
    if (!token) return;
    setPayrollState({ busy: true });
    try {
      const response = await runDemoPayroll(token, {
        includeBankLines: includeBank,
      });
      setPayrollState({ busy: false, summary: JSON.stringify(response, null, 2) });
    } catch (err) {
      console.error(err);
      setPayrollState({ busy: false, error: "Unable to run demo payroll" });
    }
  }

  async function handleCompileBas() {
    if (!token) return;
    setBasState({ busy: true });
    try {
      const response = await compileDemoBas(token, {
        year: basPeriod.year,
        month: basPeriod.month,
      });
      setBasState({ busy: false, summary: JSON.stringify(response, null, 2) });
    } catch (err) {
      console.error(err);
      setBasState({ busy: false, error: "Unable to compile demo BAS" });
    }
  }

  if (!token) return null;

  return (
    <div style={{ display: "grid", gap: 16 }}>
      <header>
        <h1 style={pageTitleStyle}>Demo mode</h1>
        <p style={pageSubtitleStyle}>
          Generate demo bank feeds, payroll runs, and BAS compiles to populate the dashboard with sample data.
        </p>
      </header>

      <section style={cardStyle}>
        <div style={cardHeaderStyle}>
          <div>
            <h2 style={sectionTitleStyle}>Demo bank feed</h2>
            <p style={sectionSubtitleStyle}>Replay a position/day feed that locks PAYGW & GST capture for the demo organisation.</p>
          </div>
          <StatusChip tone="neutral">Inbound only</StatusChip>
        </div>
        <div style={gridTwoColumns}>
          <label style={labelStyle}>
            <span>Days back</span>
            <input
              type="number"
              min={1}
              max={30}
              value={demoDays}
              onChange={(e) => setDemoDays(Number(e.target.value))}
              style={inputStyle}
            />
          </label>
          <label style={labelStyle}>
            <span>Intensity</span>
            <select
              value={demoIntensity}
              onChange={(e) => setDemoIntensity(e.target.value as any)}
              style={inputStyle}
            >
              <option value="low">Low</option>
              <option value="high">High</option>
            </select>
          </label>
        </div>
        <div style={{ display: "flex", gap: 8 }}>
          <button type="button" className="app-button" onClick={handleGenerateBankFeed} disabled={bankState.busy}>
            {bankState.busy ? "Generating..." : "Generate demo bank feed"}
          </button>
        </div>
        {bankState.busy && <SkeletonBlock width="100%" height={60} />}
        {bankState.error && <ErrorState message={bankState.error} />}
        {bankSection}
      </section>

      <section style={cardStyle}>
        <div style={cardHeaderStyle}>
          <div>
            <h2 style={sectionTitleStyle}>Demo payroll run</h2>
            <p style={sectionSubtitleStyle}>Create a payroll run and optionally mirror it in the bank feed.</p>
          </div>
          <StatusChip tone="neutral">Demo org</StatusChip>
        </div>
        <label style={checkboxStyle}>
          <input
            type="checkbox"
            checked={includeBank}
            onChange={(e) => setIncludeBank(e.target.checked)}
          />
          Create linked bank line
        </label>
        <div style={{ display: "flex", gap: 8 }}>
          <button type="button" className="app-button" onClick={handleRunPayroll} disabled={payrollState.busy}>
            {payrollState.busy ? "Running..." : "Run demo payroll"}
          </button>
        </div>
        {payrollState.busy && <SkeletonBlock width="100%" height={40} />}
        {payrollState.error && <ErrorState message={payrollState.error} />}
        {payrollSection}
      </section>

      <section style={cardStyle}>
        <div style={cardHeaderStyle}>
          <div>
            <h2 style={sectionTitleStyle}>Demo BAS compile</h2>
            <p style={sectionSubtitleStyle}>Compile a mock BAS report for the chosen period.</p>
          </div>
          <StatusChip tone="neutral">Preview only</StatusChip>
        </div>
        <div style={gridTwoColumns}>
          <label style={labelStyle}>
            <span>Year</span>
            <input
              type="number"
              value={basPeriod.year}
              onChange={(e) => setBasPeriod((prev) => ({ ...prev, year: Number(e.target.value) }))}
              style={inputStyle}
            />
          </label>
          <label style={labelStyle}>
            <span>Month</span>
            <input
              type="number"
              min={1}
              max={12}
              value={basPeriod.month}
              onChange={(e) => setBasPeriod((prev) => ({ ...prev, month: Number(e.target.value) }))}
              style={inputStyle}
            />
          </label>
        </div>
        <div style={{ display: "flex", gap: 8 }}>
          <button type="button" className="app-button" onClick={handleCompileBas} disabled={basState.busy}>
            {basState.busy ? "Compiling..." : "Compile demo BAS"}
          </button>
        </div>
        {basState.busy && <SkeletonBlock width="100%" height={40} />}
        {basState.error && <ErrorState message={basState.error} />}
        {basSection}
      </section>
    </div>
  );
}

const pageTitleStyle: React.CSSProperties = {
  fontSize: "24px",
  fontWeight: 700,
  marginBottom: "8px",
};

const pageSubtitleStyle: React.CSSProperties = {
  color: "#4b5563",
  margin: 0,
  fontSize: "14px",
  maxWidth: "700px",
};

const cardStyle: React.CSSProperties = {
  backgroundColor: "#ffffff",
  borderRadius: "12px",
  padding: "20px",
  border: "1px solid #e2e8f0",
  boxShadow: "0 1px 2px rgba(15, 23, 42, 0.08)",
  display: "grid",
  gap: "10px",
};

const cardHeaderStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  gap: 12,
  flexWrap: "wrap",
};

const sectionTitleStyle: React.CSSProperties = {
  fontSize: "18px",
  fontWeight: 600,
  margin: 0,
};

const sectionSubtitleStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#4b5563",
  margin: 0,
};

const gridTwoColumns: React.CSSProperties = {
  display: "grid",
  gap: "12px",
  gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
};

const labelStyle: React.CSSProperties = {
  display: "grid",
  gap: "4px",
  fontSize: "14px",
  color: "#111827",
};

const inputStyle: React.CSSProperties = {
  padding: "10px",
  borderRadius: "8px",
  border: "1px solid #e2e8f0",
  fontSize: "14px",
};

const checkboxStyle: React.CSSProperties = {
  display: "flex",
  alignItems: "center",
  gap: 8,
  fontSize: "14px",
};

const preStyle: React.CSSProperties = {
  background: "#f8fafc",
  border: "1px solid #e2e8f0",
  borderRadius: 8,
  padding: 12,
  fontSize: 12,
  overflow: "auto",
};



============================================================
FILE: C:\src\apgms-final\webapp\src\dev\axe.ts
============================================================
const ensureMounted = () =>
  new Promise<void>((resolve) => {
    if (document.readyState === 'complete') {
      requestAnimationFrame(() => resolve());
      return;
    }

    window.addEventListener(
      'load',
      () => {
        requestAnimationFrame(() => resolve());
      },
      { once: true },
    );
  });

const runAxe = async () => {
  const [{ default: axe }] = await Promise.all([
    import('axe-core'),
    ensureMounted(),
  ]);

  try {
    const { violations } = await axe.run(document);

    if (violations.length > 0) {
      console.warn('[axe] Accessibility violations detected', violations);
    }
  } catch (error) {
    console.warn('[axe] Unable to complete accessibility audit', error);
  }
};

if (import.meta.env.DEV) {
  void runAxe();
}



============================================================
FILE: C:\src\apgms-final\webapp\src\FeedsPage.tsx
============================================================
import React, { useEffect, useState } from "react";
import { fetchGstFeeds, fetchPayrollFeeds, generateDemoBankLines } from "./api";
import { getToken } from "./auth";
import { ErrorState, SkeletonBlock, StatusChip } from "./components/UI";

type PayrollRun = Awaited<ReturnType<typeof fetchPayrollFeeds>>["runs"][number];
type GstDay = Awaited<ReturnType<typeof fetchGstFeeds>>["days"][number];

export default function FeedsPage() {
  const token = getToken();
  const [payrollRuns, setPayrollRuns] = useState<PayrollRun[]>([]);
  const [gstDays, setGstDays] = useState<GstDay[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [demoBusy, setDemoBusy] = useState(false);

  useEffect(() => {
    if (!token) return;
    void loadFeeds();
  }, [token]);

  async function loadFeeds() {
    if (!token) return;
    setLoading(true);
    setError(null);
    try {
      const [payroll, gst] = await Promise.all([
        fetchPayrollFeeds(token),
        fetchGstFeeds(token),
      ]);
      setPayrollRuns(payroll.runs);
      setGstDays(gst.days);
      setSuccess(null);
    } catch (err) {
      console.error(err);
      setError("Unable to load feeds");
    } finally {
      setLoading(false);
    }
  }

  async function handleDemoIngest() {
    if (!token) return;
    setDemoBusy(true);
    setError(null);
    setSuccess(null);
    try {
      await generateDemoBankLines(token, { daysBack: 5, intensity: "low" });
      setSuccess("Demo feed ingested. Refreshing feeds...");
      await loadFeeds();
    } catch (err) {
      console.error(err);
      setError("Unable to ingest demo feed");
    } finally {
      setDemoBusy(false);
    }
  }

  if (!token) return null;

  return (
    <div style={{ display: "grid", gap: "24px" }}>
      <header style={{ display: "flex", justifyContent: "space-between", gap: 12, alignItems: "center", flexWrap: "wrap" }}>
        <div>
          <h1 style={pageTitleStyle}>Payroll & GST Feeds</h1>
          <p style={pageSubtitleStyle}>
            Live data feeds that feed the compliance engine. We surface payroll runs and daily GST summaries to monitor capture.
          </p>
        </div>
        <button type="button" className="app-button" onClick={() => void handleDemoIngest()} disabled={demoBusy}>
          {demoBusy ? "Ingesting demo feed..." : "Reingest demo feed"}
        </button>
      </header>

      {loading && (
        <div style={{ display: "grid", gap: 8 }}>
          <SkeletonBlock width="50%" />
          <SkeletonBlock width="100%" height={120} />
          <SkeletonBlock width="100%" height={120} />
        </div>
      )}
      {error && <ErrorState message={error} onRetry={loadFeeds} detail="We could not load feed ingests." />}
      {success && <div style={successTextStyle}>{success}</div>}

      {!loading && !error && (
        <>
          <section style={cardStyle}>
            <h2 style={sectionTitleStyle}>Payroll Runs</h2>
            <table style={tableStyle}>
              <thead>
                <tr>
                  <th style={thStyle}>Run ID</th>
                  <th style={thStyle}>Date</th>
                  <th style={thStyle}>Gross Wages</th>
                  <th style={thStyle}>PAYGW Calculated</th>
                  <th style={thStyle}>PAYGW Secured</th>
                  <th style={thStyle}>Status</th>
                </tr>
              </thead>
              <tbody>
                {payrollRuns.map((run) => (
                  <tr key={run.id}>
                    <td style={tdStyle}>{run.id}</td>
                    <td style={tdStyle}>{run.date}</td>
                    <td style={tdStyle}>{formatCurrency(run.grossWages)}</td>
                    <td style={tdStyle}>{formatCurrency(run.paygwCalculated)}</td>
                    <td style={tdStyle}>{formatCurrency(run.paygwSecured)}</td>
                    <td style={tdStyle}>
                      <StatusChip tone={statusTone(run.status)}>{run.status}</StatusChip>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {payrollRuns.length === 0 && (
              <div style={infoTextStyle}>No payroll runs recorded yet. Try the demo feed.</div>
            )}
          </section>

          <section style={cardStyle}>
            <h2 style={sectionTitleStyle}>GST Daily Summary</h2>
            <table style={tableStyle}>
              <thead>
                <tr>
                  <th style={thStyle}>Date</th>
                  <th style={thStyle}>Sales Total</th>
                  <th style={thStyle}>GST Calculated</th>
                  <th style={thStyle}>GST Secured</th>
                  <th style={thStyle}>Status</th>
                </tr>
              </thead>
              <tbody>
                {gstDays.map((day) => (
                  <tr key={day.date}>
                    <td style={tdStyle}>{day.date}</td>
                    <td style={tdStyle}>{formatCurrency(day.salesTotal)}</td>
                    <td style={tdStyle}>{formatCurrency(day.gstCalculated)}</td>
                    <td style={tdStyle}>{formatCurrency(day.gstSecured)}</td>
                    <td style={tdStyle}>
                      <StatusChip tone={statusTone(day.status)}>{day.status}</StatusChip>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {gstDays.length === 0 && (
              <div style={infoTextStyle}>No GST feed data captured yet. Try the demo feed.</div>
            )}
          </section>
        </>
      )}
    </div>
  );
}

function statusTone(status: string) {
  const upper = status.toUpperCase();
  if (upper === "READY" || upper === "OK") return "success";
  if (upper === "PARTIAL") return "warning";
  if (upper === "SHORT" || upper === "SHORTFALL") return "danger";
  return "neutral";
}

const currencyFormatter = new Intl.NumberFormat("en-AU", {
  style: "currency",
  currency: "AUD",
});

function formatCurrency(value: number) {
  return currencyFormatter.format(value ?? 0);
}

const pageTitleStyle: React.CSSProperties = {
  fontSize: "24px",
  fontWeight: 700,
  marginBottom: "8px",
};

const pageSubtitleStyle: React.CSSProperties = {
  color: "#4b5563",
  margin: 0,
  fontSize: "14px",
  maxWidth: "620px",
};

const cardStyle: React.CSSProperties = {
  backgroundColor: "#ffffff",
  borderRadius: "12px",
  padding: "24px",
  boxShadow: "0 1px 2px rgba(15, 23, 42, 0.08)",
  border: "1px solid #e2e8f0",
  display: "grid",
  gap: "16px",
};

const sectionTitleStyle: React.CSSProperties = {
  fontSize: "18px",
  fontWeight: 600,
  margin: 0,
};

const tableStyle: React.CSSProperties = {
  borderCollapse: "collapse",
  width: "100%",
};

const thStyle: React.CSSProperties = {
  textAlign: "left",
  padding: "10px 12px",
  fontSize: "12px",
  textTransform: "uppercase",
  letterSpacing: "0.06em",
  color: "#6b7280",
  borderBottom: "1px solid #e5e7eb",
};

const tdStyle: React.CSSProperties = {
  padding: "12px",
  fontSize: "14px",
  borderBottom: "1px solid #f1f5f9",
  color: "#111827",
};

const infoTextStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#6b7280",
};

const successTextStyle: React.CSSProperties = {
  fontSize: "14px",
  color: "#047857",
};



============================================================
FILE: C:\src\apgms-final\webapp\src\Login.tsx
============================================================
// services/webapp/src/Login.tsx
import React, { useState } from "react";
import { login } from "./api";

export default function Login({ onLogin }: { onLogin: (token: string) => void }) {
  const [email, setEmail] = useState("dev@example.com");
  const [password, setPassword] = useState("admin123");
  const [err, setErr] = useState("");

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErr("");
    try {
      const session = await login(email, password);
      onLogin(session.token);
    } catch (e: any) {
      setErr(e.message || "Login failed");
    }
  }

  return (
    <div style={{ maxWidth: 360, margin: "4rem auto", fontFamily: "sans-serif" }}>
      <h2>Sign in</h2>
      <form onSubmit={handleSubmit} style={{ display: "grid", gap: "0.5rem" }}>
        <label>
          Email
          <input
            style={{ width: "100%" }}
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            type="email"
          />
        </label>

        <label>
          Password
          <input
            style={{ width: "100%" }}
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            type="password"
          />
        </label>

        {err && (
          <div style={{ color: "red", fontSize: "0.9rem" }}>{err}</div>
        )}

        <button
          style={{
            padding: "0.5rem 1rem",
            background: "black",
            color: "white",
            borderRadius: 4,
          }}
          type="submit"
        >
          Log in
        </button>
      </form>
    </div>
  );
}



============================================================
FILE: C:\src\apgms-final\webapp\src\LoginPage.tsx
============================================================
// webapp/src/LoginPage.tsx
import React, { useState } from "react";
import { login } from "./api";
import { saveSession } from "./auth";
import { Link, useNavigate } from "react-router-dom";

export default function LoginPage() {
  const nav = useNavigate();
  const [email, setEmail] = useState("dev@example.com");
  const [password, setPassword] = useState("admin123");
  const [error, setError] = useState("");

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError("");

    try {
      const session = await login(email, password);
      saveSession(session);
      nav("/dashboard");
    } catch (_) {
      setError("Login failed");
    }
  }

  return (
    <div style={{
      maxWidth: "360px",
      margin: "80px auto",
      padding: "24px",
      border: "1px solid #ccc",
      borderRadius: "8px",
      fontFamily: "system-ui, sans-serif"
    }}>
      <h1 style={{ fontSize: "20px", marginBottom: "16px" }}>
        APGMS Admin Login
      </h1>

      <form onSubmit={handleSubmit} style={{ display: "grid", gap: "12px" }}>
        <label style={{ display: "grid", gap: "4px" }}>
          <span>Email</span>
          <input
            style={{ padding: "8px", fontSize: "14px" }}
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            autoComplete="username"
          />
        </label>

        <label style={{ display: "grid", gap: "4px" }}>
          <span>Password</span>
          <input
            style={{ padding: "8px", fontSize: "14px" }}
            value={password}
            type="password"
            onChange={(e) => setPassword(e.target.value)}
            autoComplete="current-password"
          />
        </label>

        {error && (
          <div style={{ color: "red", fontSize: "13px" }}>
            {error}
          </div>
        )}

        <button
          type="submit"
          style={{
            background: "black",
            color: "white",
            padding: "10px",
            fontSize: "14px",
            borderRadius: "4px",
            border: "none",
            cursor: "pointer"
          }}
        >
          Sign in
        </button>

        <div style={{ fontSize: "12px", color: "#666" }}>
          (dev@example.com / admin123 in dev)
        </div>
      </form>
      <div style={{ fontSize: "12px", marginTop: "16px" }}>
        Regulator or reviewer?{" "}
        <Link to="/regulator" style={{ color: "#0b5fff" }}>
          Go to the regulator login
        </Link>
        .
      </div>
    </div>
  );
}



============================================================
FILE: C:\src\apgms-final\webapp\src\main.tsx
============================================================
// webapp/src/main.tsx
import React from "react";
import { createRoot } from "react-dom/client";
import App from "./App";
import { ThemeProvider } from "./theme";
import "./styles/themes.css";

const el = document.getElementById("root");
if (!el) {
  throw new Error("no #root element");
}
createRoot(el).render(
  <React.StrictMode>
    <ThemeProvider>
      <App />
    </ThemeProvider>
  </React.StrictMode>
);



============================================================
FILE: C:\src\apgms-final\webapp\src\pages\BankLines.css
============================================================
.bank-lines {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-2xl);
  padding-top: var(--spacing-2xl);
}

.bank-lines__header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: var(--spacing-xl);
}

.bank-lines__header h1 {
  font-size: var(--font-size-2xl);
  letter-spacing: -0.03em;
}

.bank-lines__header p {
  margin-top: var(--spacing-xs);
  color: var(--color-text-muted);
  max-width: 40rem;
}

.bank-lines__cta {
  align-self: flex-start;
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-success) 100%);
  color: var(--color-primary-contrast);
  border: none;
  border-radius: var(--radius-pill);
  padding: var(--spacing-sm) var(--spacing-lg);
  font-weight: var(--font-weight-semibold);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
}

.bank-lines__cta:focus-visible {
  outline: 2px solid var(--color-focus);
  outline-offset: 2px;
}

.bank-lines__table-wrapper {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border);
  box-shadow: var(--shadow-md);
  overflow: hidden;
}

table {
  width: 100%;
}

thead {
  background-color: var(--color-surface-muted);
}

thead th {
  text-align: left;
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--color-text-muted);
  padding: var(--spacing-md) var(--spacing-lg);
}

tbody td,
tbody th {
  padding: var(--spacing-md) var(--spacing-lg);
  vertical-align: top;
  font-size: var(--font-size-sm);
}

tbody tr + tr {
  border-top: 1px solid var(--color-border);
}

.bank-lines__utilization {
  display: grid;
  gap: var(--spacing-xs);
  color: var(--color-text);
}

.bank-lines__utilization-track {
  position: relative;
  height: 0.4rem;
  background-color: var(--color-surface-muted);
  border-radius: var(--radius-pill);
  overflow: hidden;
}

.bank-lines__utilization-fill {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-success) 100%);
}

.status-badge {
  display: inline-flex;
  flex-direction: column;
  gap: var(--spacing-3xs);
  padding: var(--spacing-2xs) var(--spacing-sm);
  border-radius: var(--radius-md);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.status-badge__label {
  font-size: var(--font-size-xs);
}

.status-badge__hint {
  font-size: var(--font-size-xxs, 0.65rem);
  opacity: 0.85;
}

.status-badge--active {
  background-color: rgba(10, 125, 87, 0.16);
  color: var(--color-success);
}

.status-badge--pending {
  background-color: rgba(185, 115, 24, 0.18);
  color: var(--color-warning);
}

.status-badge--monitoring {
  background-color: var(--color-primary-soft);
  color: var(--color-primary);
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  border: 0;
}

@media (max-width: 900px) {
  .bank-lines__header {
    flex-direction: column;
    align-items: flex-start;
  }

  table {
    display: block;
    overflow-x: auto;
  }
}



============================================================
FILE: C:\src\apgms-final\webapp\src\pages\BankLines.tsx
============================================================
import './BankLines.css';

type LineStatus = 'Active' | 'Pending' | 'Monitoring';

type BankLine = {
  bank: string;
  limit: string;
  utilization: string;
  status: LineStatus;
  updated: string;
  notes: string;
};

const bankLines: BankLine[] = [
  {
    bank: 'Commonwealth Bank',
    limit: '$1.2B',
    utilization: '64%',
    status: 'Active',
    updated: 'Today 10:24',
    notes: 'Term sheet expansion approved for Helios storage facility.'
  },
  {
    bank: 'Northwind Credit Union',
    limit: '$820M',
    utilization: '71%',
    status: 'Monitoring',
    updated: 'Yesterday',
    notes: 'Utilization trending upward ahead of portfolio rebalance.'
  },
  {
    bank: 'First Harbor Partners',
    limit: '$640M',
    utilization: '48%',
    status: 'Pending',
    updated: '2 days ago',
    notes: 'Awaiting revised covenants from legal after counterparty feedback.'
  }
];

const statusLabels: Record<LineStatus, string> = {
  Active: 'Operational',
  Pending: 'Requires approval',
  Monitoring: 'Watch closely'
};

export default function BankLinesPage() {
  return (
    <div className="bank-lines">
      <header className="bank-lines__header">
        <div>
          <h1>Bank line visibility</h1>
          <p>
            Stay ahead of liquidity requirements with a consolidated view of commitments, live
            utilization, and watchlist signals across your institutional lenders.
          </p>
        </div>
        <button type="button" className="bank-lines__cta">
          Export exposure report
        </button>
      </header>

      <div className="bank-lines__table-wrapper">
        <table>
          <caption className="sr-only">Breakdown of bank line utilization and statuses</caption>
          <thead>
            <tr>
              <th scope="col">Lender</th>
              <th scope="col">Limit</th>
              <th scope="col">Utilization</th>
              <th scope="col">Status</th>
              <th scope="col">Updated</th>
              <th scope="col">Notes</th>
            </tr>
          </thead>
          <tbody>
            {bankLines.map((line) => (
              <tr key={line.bank}>
                <th scope="row">{line.bank}</th>
                <td>{line.limit}</td>
                <td>
                  <div className="bank-lines__utilization">
                    <span>{line.utilization}</span>
                    <div className="bank-lines__utilization-track" aria-hidden="true">
                      <div
                        className="bank-lines__utilization-fill"
                        style={{ width: line.utilization }}
                      />
                    </div>
                  </div>
                </td>
                <td>
                  <span className={`status-badge status-badge--${line.status.toLowerCase()}`}>
                    <span className="status-badge__label">{line.status}</span>
                    <span className="status-badge__hint">{statusLabels[line.status]}</span>
                  </span>
                </td>
                <td>{line.updated}</td>
                <td>{line.notes}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}



============================================================
FILE: C:\src\apgms-final\webapp\src\pages\Home.css
============================================================
.page {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-2xl);
  padding-top: var(--spacing-2xl);
}

.page__header {
  display: grid;
  gap: var(--spacing-sm);
  max-width: 46rem;
}

.page__header h1 {
  font-size: var(--font-size-2xl);
  letter-spacing: -0.03em;
}

.page__header p {
  font-size: var(--font-size-md);
  color: var(--color-text-muted);
}

.metric-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(16rem, 1fr));
  gap: var(--spacing-xl);
}

.metric-card {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border);
  padding: var(--spacing-xl);
  display: grid;
  gap: var(--spacing-md);
  box-shadow: var(--shadow-sm);
}

.metric-card__header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  font-size: var(--font-size-sm);
  color: var(--color-text-muted);
}

.metric-card__change {
  border-radius: var(--radius-pill);
  background-color: var(--color-primary-soft);
  color: var(--color-primary);
  padding: var(--spacing-3xs) var(--spacing-sm);
  font-weight: var(--font-weight-medium);
}

.metric-card__value {
  font-size: var(--font-size-2xl);
  letter-spacing: -0.04em;
}

.metric-card__description {
  font-size: var(--font-size-sm);
  color: var(--color-text-muted);
}

.activity {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border);
  box-shadow: var(--shadow-sm);
  padding: var(--spacing-xl);
  display: grid;
  gap: var(--spacing-lg);
}

.activity__header {
  display: grid;
  gap: var(--spacing-xs);
}

.activity__subtitle {
  font-size: var(--font-size-sm);
  color: var(--color-text-muted);
}

.activity__list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: var(--spacing-md);
}

.activity__item {
  display: flex;
  justify-content: space-between;
  gap: var(--spacing-lg);
  align-items: baseline;
}

.activity__name {
  font-size: var(--font-size-lg);
}

.activity__detail {
  font-size: var(--font-size-sm);
  color: var(--color-text-muted);
}

.activity__status {
  font-size: var(--font-size-sm);
  color: var(--color-primary);
  font-weight: var(--font-weight-medium);
}

@media (max-width: 700px) {
  .activity__item {
    flex-direction: column;
    align-items: flex-start;
  }
}



============================================================
FILE: C:\src\apgms-final\webapp\src\pages\Home.tsx
============================================================
import './Home.css';

const metrics = [
  {
    title: 'Active mandates',
    value: '24',
    change: '+3.4% vs last week',
    description:
      'Structured credit and private equity deals currently tracked in the Pro+ workspace.'
  },
  {
    title: 'Total committed capital',
    value: '$4.8B',
    change: '+$180M new commitments',
    description: 'Aggregate bank and fund lines allocated across open portfolios.'
  },
  {
    title: 'Average utilization',
    value: '67%',
    change: '-5.3% risk exposure',
    description: 'Weighted utilization across all active bank lines for the current quarter.'
  }
];

const activities = [
  {
    name: 'GreenRidge solar expansion',
    detail: 'Closing diligence with Commonwealth Bank',
    status: 'Due tomorrow'
  },
  {
    name: 'Helios storage facility',
    detail: 'Amended terms shared with syndicate partners',
    status: 'Updated 2h ago'
  },
  {
    name: 'Urban mobility fund II',
    detail: 'Capital call scheduled for Monday',
    status: 'Action needed'
  }
];

export default function HomePage() {
  return (
    <div className="page">
      <header className="page__header">
        <h1>Portfolio pulse</h1>
        <p>
          Monitor capital utilization, track live mandates, and surface emerging risk signals
          across your institutional banking relationships.
        </p>
      </header>

      <section aria-label="Key metrics" className="metric-grid">
        {metrics.map((metric) => (
          <article className="metric-card" key={metric.title}>
            <header className="metric-card__header">
              <h2>{metric.title}</h2>
              <span className="metric-card__change">{metric.change}</span>
            </header>
            <p className="metric-card__value">{metric.value}</p>
            <p className="metric-card__description">{metric.description}</p>
          </article>
        ))}
      </section>

      <section aria-label="Latest activity" className="activity">
        <div className="activity__header">
          <h2>Workflow alerts</h2>
          <p className="activity__subtitle">Curated tasks across deal teams and syndicate partners</p>
        </div>
        <ul className="activity__list">
          {activities.map((activity) => (
            <li className="activity__item" key={activity.name}>
              <div>
                <p className="activity__name">{activity.name}</p>
                <p className="activity__detail">{activity.detail}</p>
              </div>
              <span className="activity__status">{activity.status}</span>
            </li>
          ))}
        </ul>
      </section>
    </div>
  );
}



============================================================
FILE: C:\src\apgms-final\webapp\src\pages\OnboardingWizard.tsx
============================================================
import { useState } from "react";
import { Box, Button, TextField, Select, MenuItem, Stepper, Step, StepLabel } from "@mui/material";

export default function OnboardingWizard() {
  const [step, setStep] = useState(0);
  const [abn, setAbn] = useState("");
  const [tfn, setTfn] = useState("");
  const [obligations, setObligations] = useState<string[]>([]);
  // other state: bank, accounts, scheduleâ€¦

  async function handleValidate() {
    const res = await fetch(`/onboarding/validate?abn=${abn}&tfn=${tfn}`, { credentials: "include" });
    const data = await res.json();
    setObligations(data.obligations);  // e.g. ["PAYGW", "GST"]
    setStep(1);
  }

  // â€¦ handlers for schedule & bank selection â€¦

  async function handleSubmit() {
    await fetch("/onboarding/setup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        abn, tfn,
        bankProvider,
        schedule,
        accounts: { paygw: paygwAccount, gst: gstAccount, paygi: paygiAccount },
      }),
    });
    // redirect to dashboard
  }

  return (
    <Box>
      <Stepper activeStep={step}>
        <Step><StepLabel>Verify ABN/TFN</StepLabel></Step>
        <Step><StepLabel>Bank & Schedules</StepLabel></Step>
        <Step><StepLabel>Summary</StepLabel></Step>
      </Stepper>
      {step === 0 && (
        <Box>
          <TextField label="ABN" value={abn} onChange={e => setAbn(e.target.value)} />
          <TextField label="TFN" value={tfn} onChange={e => setTfn(e.target.value)} />
          <Button onClick={handleValidate}>Next</Button>
        </Box>
      )}
      {/* Implement other steps similarly */}
    </Box>
  );
}



============================================================
FILE: C:\src\apgms-final\webapp\src\ProtectedLayout.tsx
============================================================
import React, { useEffect, useMemo, useState } from "react";
import { NavLink, Outlet, useLocation, useNavigate } from "react-router-dom";
import { clearToken, getToken } from "./auth";
import {
  fetchAlerts,
  fetchCurrentObligations,
  fetchEvidenceArtifacts,
} from "./api";
import { useTheme, type ThemeName } from "./theme";

const navItems: Array<{ to: string; label: string }> = [
  { to: "/dashboard", label: "Dashboard" },
  { to: "/feeds", label: "Payroll & GST Feeds" },
  { to: "/alerts", label: "Alerts" },
  { to: "/bas", label: "BAS Lodgment" },
  { to: "/compliance", label: "Compliance" },
  { to: "/demo", label: "Demo mode" },
  { to: "/security", label: "Security / Access" },
];

export default function ProtectedLayout() {
  const navigate = useNavigate();
  const location = useLocation();
  const token = getToken();
  const { theme, setTheme } = useTheme();
  const [summaryLoading, setSummaryLoading] = useState(false);
  const [summaryError, setSummaryError] = useState<string | null>(null);
  const [summary, setSummary] = useState<{
    paygwStatus: string;
    gstStatus: string;
    nextBasDue: string | null;
    alerts: Array<{
      id: string;
      severity: string;
      message: string;
      createdAt: string;
    }>;
    evidence: Array<{
      id: string;
      createdAt: string;
      wormUri: string;
    }>;
  } | null>(null);

  useEffect(() => {
    if (!token) {
      navigate("/", { replace: true, state: { from: location.pathname } });
    }
  }, [token, navigate, location.pathname]);

  if (!token) {
    return null;
  }

  function handleLogout() {
    clearToken();
    navigate("/", { replace: true });
  }

  useEffect(() => {
    if (!token) return;
    setSummaryLoading(true);
    setSummaryError(null);
    (async () => {
      try {
        const [obligations, alerts, evidence] = await Promise.all([
          fetchCurrentObligations(token),
          fetchAlerts(token),
          fetchEvidenceArtifacts(token),
        ]);

        setSummary({
          paygwStatus: obligations.paygw.status,
          gstStatus: obligations.gst.status,
          nextBasDue: obligations.nextBasDue,
          alerts: alerts.alerts.slice(0, 5),
          evidence: evidence.artifacts.slice(0, 3),
        });
      } catch (err) {
        console.error(err);
        setSummaryError("Unable to load summary");
      } finally {
        setSummaryLoading(false);
      }
    })();
  }, [token]);

  const summaryChips = [
    summary?.paygwStatus
      ? { label: `PAYGW ${summary.paygwStatus}`, tone: summary.paygwStatus === "ok" ? "success" : "warning" }
      : null,
    summary?.gstStatus
      ? { label: `GST ${summary.gstStatus}`, tone: summary.gstStatus === "ok" ? "success" : "warning" }
      : null,
    summary?.nextBasDue
      ? { label: `Next BAS due ${new Date(summary.nextBasDue).toLocaleDateString()}`, tone: "neutral" }
      : { label: "Next BAS not scheduled", tone: "neutral" },
  ];

  const activityItems = useMemo(() => {
    const alertItems =
      summary?.alerts.map((a) => ({
        title: a.message,
        meta: `${a.severity.toUpperCase()} â€¢ ${new Date(a.createdAt).toLocaleTimeString()}`,
      })) ?? [];
    const evidenceItems =
      summary?.evidence.map((e) => ({
        title: `Evidence pack ${e.id}`,
        meta: new Date(e.createdAt).toLocaleTimeString(),
      })) ?? [];
    return [...alertItems, ...evidenceItems].slice(0, 6);
  }, [summary]);

  return (
    <div style={outerShellStyle}>
      <aside style={sidebarStyle}>
        <div>
          <div style={brandStyle}>
            <div>APGMS Admin</div>
            <div style={envBadgeStyle}>Sandbox</div>
          </div>
          <div style={orgStyle}>Org: demo-org</div>
          <div style={{ margin: "12px 0" }}>
            <label style={themeLabelStyle}>
              Theme
              <select
                value={theme}
                onChange={(e) => setTheme(e.target.value as ThemeName)}
                style={themeSelectStyle}
              >
                <option value="navy">Navy</option>
                <option value="sunset">Sunset</option>
                <option value="forest">Forest</option>
              </select>
            </label>
          </div>
          <nav style={{ display: "grid", gap: "8px" }}>
            {navItems.map((item) => (
              <NavLink
                key={item.to}
                to={item.to}
                style={({ isActive }) => ({
                  display: "block",
                  padding: "10px 12px",
                  fontSize: "14px",
                  borderRadius: "6px",
                  color: isActive ? "var(--accent)" : "var(--nav-text)",
                  backgroundColor: isActive ? "rgba(255,255,255,0.08)" : "transparent",
                  textDecoration: "none",
                  fontWeight: isActive ? 700 : 500,
                })}
              >
                {item.label}
              </NavLink>
            ))}
          </nav>
          <div style={quickActionsStyle}>
            <button type="button" className="app-button" style={{ width: "100%" }}>
              Run precheck
            </button>
            <button type="button" className="app-button ghost" style={{ width: "100%" }}>
              Generate evidence
            </button>
            <button type="button" className="app-button ghost" style={{ width: "100%" }}>
              Trigger demo feed
            </button>
          </div>
        </div>
        <button type="button" onClick={handleLogout} style={logoutButtonStyle}>
          Log out
        </button>
      </aside>

      <main style={mainAreaStyle}>
        <div style={summaryRibbonStyle}>
          <div style={summaryLeftStyle}>
            <div style={summaryTitleStyle}>Compliance Control Room</div>
            <div style={summarySubStyle}>
              PAYGW/GST coverage, BAS readiness, and evidence status at a glance.
            </div>
            <div style={chipRowStyle}>
              {summaryLoading && <div className="app-skeleton" style={{ width: 220, height: 16 }} />}
              {summaryError && (
                <div style={{ color: "var(--danger)", fontSize: 13, fontWeight: 600 }}>
                  {summaryError}{" "}
                  <button
                    type="button"
                    className="app-button ghost"
                    style={{ padding: "4px 8px", fontSize: 12, marginLeft: 6 }}
                    onClick={() => setSummaryError(null)}
                  >
                    Retry
                  </button>
                </div>
              )}
              {!summaryLoading &&
                !summaryError &&
                summaryChips
                  .filter(Boolean)
                  .map((chip) => (
                    <span
                      key={chip!.label}
                      className={`app-chip ${chip!.tone === "neutral" ? "" : chip!.tone}`}
                    >
                      {chip!.label}
                    </span>
                  ))}
            </div>
          </div>
          <div style={summaryActionsStyle}>
            <button type="button" className="app-button">
              Run pre-check
            </button>
            <button type="button" className="app-button ghost">
              Download evidence
            </button>
          </div>
        </div>
        <div style={contentShellStyle}>
          <div style={contentStyle}>
            <Outlet />
          </div>
          <aside style={activityRailStyle}>
            <div style={railHeaderStyle}>Activity / Alerts</div>
            {summaryLoading && <div className="app-skeleton" style={{ width: "100%", height: 160 }} />}
            {summaryError && (
              <div style={{ color: "var(--danger)", fontSize: 13, fontWeight: 600 }}>{summaryError}</div>
            )}
            {!summaryLoading && !summaryError && (
              <div style={railListStyle}>
                {activityItems.length === 0 && (
                  <div style={{ fontSize: 13, color: "var(--muted)" }}>
                    No recent activity. Run a pre-check or generate evidence to populate.
                  </div>
                )}
                {activityItems.map((item) => (
                  <div key={`${item.title}-${item.meta}`} style={railItemStyle}>
                    <div style={{ fontWeight: 600 }}>{item.title}</div>
                    <div style={{ fontSize: 12, color: "var(--muted)" }}>{item.meta}</div>
                  </div>
                ))}
              </div>
            )}
          </aside>
        </div>
      </main>
    </div>
  );
}

const outerShellStyle: React.CSSProperties = {
  display: "flex",
  minHeight: "100vh",
  fontFamily: "var(--font-body)",
  backgroundColor: "var(--bg)",
};

const sidebarStyle: React.CSSProperties = {
  width: "240px",
  padding: "24px 20px",
  display: "flex",
  flexDirection: "column",
  justifyContent: "space-between",
  borderRight: "1px solid var(--border)",
  backgroundColor: "var(--nav-bg)",
  color: "var(--nav-text)",
};

const brandStyle: React.CSSProperties = {
  fontSize: "18px",
  fontWeight: 700,
  marginBottom: "24px",
  color: "var(--nav-text)",
  display: "flex",
  alignItems: "center",
  gap: "8px",
};

const mainAreaStyle: React.CSSProperties = {
  flex: 1,
  padding: "24px 32px 32px",
  overflowY: "auto",
};

const contentStyle: React.CSSProperties = {
  maxWidth: "980px",
  display: "grid",
  gap: "20px",
};

const logoutButtonStyle: React.CSSProperties = {
  marginTop: "24px",
  padding: "10px 12px",
  fontSize: "14px",
  borderRadius: "6px",
  border: "1px solid rgba(255,255,255,0.3)",
  background: "transparent",
  color: "var(--nav-text)",
  cursor: "pointer",
};

const envBadgeStyle: React.CSSProperties = {
  background: "rgba(255,255,255,0.08)",
  color: "var(--nav-text)",
  fontSize: 12,
  padding: "4px 8px",
  borderRadius: 999,
  border: "1px solid rgba(255,255,255,0.2)",
};

const orgStyle: React.CSSProperties = {
  fontSize: 13,
  color: "var(--nav-text)",
  marginBottom: 16,
};

const themeLabelStyle: React.CSSProperties = {
  display: "flex",
  flexDirection: "column",
  gap: 6,
  color: "var(--nav-text)",
  fontSize: 13,
  fontWeight: 600,
};

const themeSelectStyle: React.CSSProperties = {
  padding: "8px 10px",
  borderRadius: 6,
  border: "1px solid rgba(255,255,255,0.2)",
  background: "rgba(255,255,255,0.06)",
  color: "var(--nav-text)",
};

const quickActionsStyle: React.CSSProperties = {
  display: "grid",
  gap: 8,
  marginTop: 16,
};

const summaryRibbonStyle: React.CSSProperties = {
  background: "var(--surface)",
  border: "1px solid var(--border)",
  borderRadius: "10px",
  padding: "16px 18px",
  boxShadow: "var(--shadow-soft)",
  display: "flex",
  alignItems: "center",
  justifyContent: "space-between",
  gap: 16,
};

const summaryLeftStyle: React.CSSProperties = {
  display: "grid",
  gap: 8,
};

const summaryTitleStyle: React.CSSProperties = {
  fontFamily: "var(--font-heading)",
  fontSize: 18,
  fontWeight: 700,
  margin: 0,
};

const summarySubStyle: React.CSSProperties = {
  margin: 0,
  color: "var(--muted)",
  fontSize: 14,
};

const chipRowStyle: React.CSSProperties = {
  display: "flex",
  gap: 8,
  flexWrap: "wrap",
};

const summaryActionsStyle: React.CSSProperties = {
  display: "flex",
  gap: 10,
  alignItems: "center",
};

const contentShellStyle: React.CSSProperties = {
  display: "grid",
  gridTemplateColumns: "1fr 280px",
  gap: 16,
  alignItems: "start",
};

const activityRailStyle: React.CSSProperties = {
  background: "var(--surface)",
  border: "1px solid var(--border)",
  borderRadius: "10px",
  padding: 14,
  boxShadow: "var(--shadow-soft)",
  position: "sticky",
  top: 20,
  height: "fit-content",
  minHeight: 240,
};

const railHeaderStyle: React.CSSProperties = {
  fontWeight: 700,
  marginBottom: 10,
};

const railListStyle: React.CSSProperties = {
  display: "grid",
  gap: 10,
};

const railItemStyle: React.CSSProperties = {
  padding: 10,
  borderRadius: 8,
  border: "1px solid var(--border)",
  background: "var(--surface-alt)",
  boxShadow: "var(--shadow-soft)",
};



============================================================
FILE: C:\src\apgms-final\webapp\src\regulatorAuth.ts
============================================================
const REGULATOR_SESSION_KEY = "apgms_regulator_session";

export type RegulatorSession = {
  token: string;
  orgId: string;
  session: {
    id: string;
    issuedAt: string;
    expiresAt: string;
    sessionToken: string;
  };
};

function readSession(): RegulatorSession | null {
  const raw = localStorage.getItem(REGULATOR_SESSION_KEY);
  if (!raw) {
    return null;
  }
  try {
    return JSON.parse(raw) as RegulatorSession;
  } catch {
    localStorage.removeItem(REGULATOR_SESSION_KEY);
    return null;
  }
}

export function saveRegulatorSession(session: RegulatorSession) {
  localStorage.setItem(REGULATOR_SESSION_KEY, JSON.stringify(session));
}

export function getRegulatorSession(): RegulatorSession | null {
  return readSession();
}

export function getRegulatorToken(): string | null {
  return readSession()?.token ?? null;
}

export function clearRegulatorSession() {
  localStorage.removeItem(REGULATOR_SESSION_KEY);
}



============================================================
FILE: C:\src\apgms-final\webapp\src\RegulatorEvidencePage.tsx
============================================================
import React, { useEffect, useMemo, useState } from "react";
import {
  fetchRegulatorEvidenceDetail,
  fetchRegulatorEvidenceList,
} from "./api";
import { getRegulatorToken } from "./regulatorAuth";

type EvidenceList = Awaited<ReturnType<typeof fetchRegulatorEvidenceList>>;
type EvidenceDetail = Awaited<ReturnType<typeof fetchRegulatorEvidenceDetail>>;

type ListState = {
  loading: boolean;
  error: string | null;
  artifacts: EvidenceList["artifacts"];
};

type DetailState = {
  loading: boolean;
  error: string | null;
  artifact: EvidenceDetail["artifact"] | null;
  verification: {
    status: "idle" | "busy" | "match" | "mismatch" | "unavailable";
    computedHash?: string;
  };
};

const initialListState: ListState = {
  loading: true,
  error: null,
  artifacts: [],
};

const initialDetailState: DetailState = {
  loading: false,
  error: null,
  artifact: null,
  verification: { status: "idle" },
};

export default function RegulatorEvidencePage() {
  const token = getRegulatorToken();
  const [listState, setListState] = useState(initialListState);
  const [detailState, setDetailState] = useState(initialDetailState);
  const [selectedId, setSelectedId] = useState<string | null>(null);

  useEffect(() => {
    if (!token) {
      setListState({ loading: false, error: "Session expired", artifacts: [] });
      return;
    }
    const authToken = token;

    let cancelled = false;
    async function loadList() {
      setListState(initialListState);
      try {
        const data = await fetchRegulatorEvidenceList(authToken);
        if (cancelled) return;
        setListState({ loading: false, error: null, artifacts: data.artifacts });
        if (data.artifacts.length > 0) {
          setSelectedId(data.artifacts[0].id);
        }
      } catch (error) {
        if (cancelled) return;
        const message = error instanceof Error ? error.message : "failed_evidence_list";
        setListState({ loading: false, error: message, artifacts: [] });
      }
    }
    loadList();
    return () => {
      cancelled = true;
    };
  }, [token]);

  useEffect(() => {
    if (!token || !selectedId) {
      setDetailState(initialDetailState);
      return;
    }
    const authToken = token;
    const artifactId = selectedId;
    let cancelled = false;
    async function loadDetail() {
      setDetailState({
        loading: true,
        error: null,
        artifact: null,
        verification: { status: "idle" },
      });
      try {
        const data = await fetchRegulatorEvidenceDetail(authToken, artifactId);
        if (cancelled) return;
        setDetailState({
          loading: false,
          error: null,
          artifact: data.artifact,
          verification: { status: "idle" },
        });
      } catch (error) {
        if (cancelled) return;
        const message = error instanceof Error ? error.message : "failed_evidence_detail";
        setDetailState({
          loading: false,
          error: message,
          artifact: null,
          verification: { status: "idle" },
        });
      }
    }
    loadDetail();
    return () => {
      cancelled = true;
    };
  }, [token, selectedId]);

  const sortedArtifacts = useMemo(() => {
    return [...listState.artifacts].sort((a, b) => (a.createdAt < b.createdAt ? 1 : -1));
  }, [listState.artifacts]);

  async function handleVerify() {
    if (!detailState.artifact) {
      return;
    }
    if (!window.crypto?.subtle) {
      setDetailState((prev) => ({
        ...prev,
        verification: { status: "unavailable" },
      }));
      return;
    }
    setDetailState((prev) => ({
      ...prev,
      verification: { status: "busy" },
    }));
    const payloadJson = JSON.stringify(detailState.artifact.payload ?? null);
    const encoder = new TextEncoder();
    const digest = await window.crypto.subtle.digest("SHA-256", encoder.encode(payloadJson));
    const computed = Array.from(new Uint8Array(digest))
      .map((byte) => byte.toString(16).padStart(2, "0"))
      .join("");
    const matches = computed.toLowerCase() === detailState.artifact.sha256.toLowerCase();
    setDetailState((prev) => ({
      ...prev,
      verification: {
        status: matches ? "match" : "mismatch",
        computedHash: computed,
      },
    }));
  }

  if (!token) {
    return renderPanel("Session expired", "Please sign in again to review evidence.");
  }

  if (listState.loading) {
    return renderPanel("Loading evidence library...", null);
  }

  if (listState.error) {
    return renderPanel("Unable to load evidence", listState.error);
  }

  return (
    <div style={pageLayoutStyle}>
      <aside style={sidebarStyle}>
        <div>
          <h2 style={sidebarTitleStyle}>Evidence library</h2>
          <p style={sidebarSubtitleStyle}>
            Append-only package of regulator evidence stored with hash digests.
          </p>
        </div>
        <div style={listStyle}>
          {sortedArtifacts.length === 0 ? (
            <div style={emptyStateStyle}>No artifacts generated yet.</div>
          ) : (
            sortedArtifacts.map((artifact) => {
              const isSelected = artifact.id === selectedId;
              return (
                <button
                  key={artifact.id}
                  type="button"
                  onClick={() => setSelectedId(artifact.id)}
                  style={{
                    ...artifactButtonStyle,
                    borderColor: isSelected ? "#0b5fff" : "transparent",
                    backgroundColor: isSelected ? "rgba(11, 95, 255, 0.1)" : "transparent",
                  }}
                >
                  <div style={artifactTitleStyle}>{artifact.kind}</div>
                  <div style={artifactMetaStyle}>{formatDate(artifact.createdAt)}</div>
                  <code style={artifactHashStyle}>{artifact.sha256.slice(0, 12)}...</code>
                </button>
              );
            })
          )}
        </div>
      </aside>

      <section style={detailPaneStyle}>
        {detailState.loading ? (
          <div style={emptyStateStyle}>Loading artifact details...</div>
        ) : detailState.error ? (
          <div style={emptyStateStyle}>Failed to load artifact: {detailState.error}</div>
        ) : detailState.artifact ? (
          <ArtifactDetailView
            artifact={detailState.artifact}
            verification={detailState.verification}
            onVerify={handleVerify}
          />
        ) : (
          <div style={emptyStateStyle}>Select an artifact to inspect the payload.</div>
        )}
      </section>
    </div>
  );
}

function ArtifactDetailView({
  artifact,
  verification,
  onVerify,
}: {
  artifact: EvidenceDetail["artifact"];
  verification: DetailState["verification"];
  onVerify: () => void;
}) {
  return (
    <div style={detailContentStyle}>
      <header style={detailHeaderStyle}>
        <div>
          <div style={detailTitleStyle}>{artifact.kind}</div>
          <div style={detailMetaStyle}>Captured {formatDate(artifact.createdAt)}</div>
        </div>
        <button
          type="button"
          onClick={onVerify}
          style={verifyButtonStyle}
          disabled={verification.status === "busy"}
        >
          {verification.status === "busy" ? "Verifying..." : "Verify hash"}
        </button>
      </header>

      <div style={hashSectionStyle}>
        <div style={hashLabelStyle}>Recorded SHA-256 digest</div>
        <code style={hashValueStyle}>{artifact.sha256}</code>
        {verification.status === "match" && (
          <div style={{ color: "#166534", fontSize: "13px" }}>
            Payload matches recorded hash ({verification.computedHash}).
          </div>
        )}
        {verification.status === "mismatch" && (
          <div style={{ color: "#b91c1c", fontSize: "13px" }}>
            Computed hash {verification.computedHash} does not match the stored digest.
          </div>
        )}
        {verification.status === "unavailable" && (
          <div style={{ color: "#92400e", fontSize: "13px" }}>
            This browser cannot access SubtleCrypto. Re-run the smoke script to verify offline.
          </div>
        )}
      </div>

      <div style={payloadWrapperStyle}>
        <div style={payloadHeaderStyle}>
          Payload snapshot
          <span style={payloadHintStyle}>
            Hash computed over JSON.stringify(payload ?? null)
          </span>
        </div>
        <pre style={payloadBodyStyle}>
          {JSON.stringify(artifact.payload ?? null, null, 2)}
        </pre>
      </div>

      {artifact.wormUri ? (
        <div style={wormHintStyle}>
          WORM storage reference:{" "}
          <a href={artifact.wormUri} target="_blank" rel="noreferrer">
            {artifact.wormUri}
          </a>
        </div>
      ) : null}
    </div>
  );
}

function renderPanel(title: string, subtitle: string | null) {
  return (
    <div style={panelStyle}>
      <h2 style={panelTitleStyle}>{title}</h2>
      {subtitle ? <p style={panelSubtitleStyle}>{subtitle}</p> : null}
    </div>
  );
}

function formatDate(value: string) {
  return new Date(value).toLocaleString("en-AU", {
    dateStyle: "medium",
    timeStyle: "short",
  });
}

const pageLayoutStyle: React.CSSProperties = {
  display: "grid",
  gridTemplateColumns: "260px 1fr",
  gap: "24px",
};

const sidebarStyle: React.CSSProperties = {
  background: "#ffffff",
  borderRadius: "12px",
  padding: "20px",
  boxShadow: "0 10px 24px rgba(15, 23, 42, 0.05)",
  display: "grid",
  gap: "16px",
  height: "fit-content",
};

const sidebarTitleStyle: React.CSSProperties = {
  fontSize: "18px",
  margin: 0,
  fontWeight: 600,
};

const sidebarSubtitleStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#64748b",
  margin: "8px 0 0",
};

const listStyle: React.CSSProperties = {
  display: "grid",
  gap: "10px",
  maxHeight: "520px",
  overflowY: "auto",
  paddingRight: "4px",
};

const artifactButtonStyle: React.CSSProperties = {
  border: "2px solid transparent",
  borderRadius: "10px",
  padding: "12px",
  textAlign: "left",
  cursor: "pointer",
  display: "grid",
  gap: "6px",
  background: "transparent",
};

const artifactTitleStyle: React.CSSProperties = {
  fontSize: "14px",
  fontWeight: 600,
  color: "#0f172a",
};

const artifactMetaStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#475569",
};

const artifactHashStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#6366f1",
  wordBreak: "break-all",
};

const detailPaneStyle: React.CSSProperties = {
  background: "#ffffff",
  borderRadius: "12px",
  padding: "28px",
  boxShadow: "0 14px 32px rgba(15, 23, 42, 0.05)",
  minHeight: "520px",
};

const detailContentStyle: React.CSSProperties = {
  display: "grid",
  gap: "20px",
};

const detailHeaderStyle: React.CSSProperties = {
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  gap: "16px",
  flexWrap: "wrap",
};

const detailTitleStyle: React.CSSProperties = {
  fontSize: "20px",
  fontWeight: 600,
};

const detailMetaStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#64748b",
};

const verifyButtonStyle: React.CSSProperties = {
  background: "#0b5fff",
  color: "#ffffff",
  border: "none",
  borderRadius: "8px",
  padding: "10px 16px",
  fontSize: "14px",
  fontWeight: 600,
  cursor: "pointer",
};

const hashSectionStyle: React.CSSProperties = {
  display: "grid",
  gap: "8px",
};

const hashLabelStyle: React.CSSProperties = {
  fontSize: "13px",
  color: "#475569",
};

const hashValueStyle: React.CSSProperties = {
  fontSize: "13px",
  wordBreak: "break-all",
  background: "#f1f5f9",
  padding: "12px",
  borderRadius: "8px",
};

const payloadWrapperStyle: React.CSSProperties = {
  border: "1px solid #e2e8f0",
  borderRadius: "12px",
  overflow: "hidden",
};

const payloadHeaderStyle: React.CSSProperties = {
  padding: "12px 16px",
  background: "#f8fafc",
  fontSize: "13px",
  color: "#475569",
  display: "flex",
  justifyContent: "space-between",
};

const payloadHintStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#94a3b8",
};

const payloadBodyStyle: React.CSSProperties = {
  margin: 0,
  padding: "16px",
  background: "#0f172a",
  color: "#e2e8f0",
  fontSize: "12px",
  lineHeight: 1.5,
  maxHeight: "320px",
  overflow: "auto",
};

const wormHintStyle: React.CSSProperties = {
  fontSize: "12px",
  color: "#475569",
};

const panelStyle: React.CSSProperties = {
  background: "#ffffff",
  borderRadius: "12px",
  padding: "32px",
  boxShadow: "0 12px 28px rgba(15, 23, 42, 0.06)",
};

const panelTitleStyle: React.CSSProperties = {
  margin: 0,
  fontSize: "20px",
  fontWeight: 600,
};

const panelSubtitleStyle: React.CSSProperties = {
  marginTop: "8px",
  fontSize: "14px",
  color: "#475569",
};

const emptyStateStyle: React.CSSProperties = {
  background: "#f1f5f9",
  borderRadius: "10px",
  padding: "16px",
  fontSize: "13px",
  color: "#475569",
  textAlign: "center",
};



============================================================
FILE: C:\src\apgms-final\webapp\src\RegulatorLayout.tsx
============================================================
import React, { useEffect } from "react";
import { NavLink, Outlet, useLocation, useNavigate } from "react-router-dom";
import {
  clearRegulatorSession,
  getRegulatorSession,
} from "./regulatorAuth";

const navItems: Array<{ to: string; label: string }> = [
  { to: "/regulator/portal/overview", label: "Overview" },
  { to: "/regulator/portal/evidence", label: "Evidence Library" },
  { to: "/regulator/portal/monitoring", label: "Monitoring" },
];

export default function RegulatorLayout() {
  const navigate = useNavigate();
  const location = useLocation();
  const session = getRegulatorSession();

  useEffect(() => {
    if (!session) {
      navigate("/regulator", {
        replace: true,
        state: { from: location.pathname },
      });
    }
  }, [session, navigate, location.pathname]);

  if (!session) {
    return null;
  }

  function handleLogout() {
    clearRegulatorSession();
    navigate("/regulator", { replace: true });
  }

  return (
    <div style={outerStyle}>
      <aside style={sidebarStyle}>
        <div style={{ display: "grid", gap: "24px" }}>
          <div>
            <div style={brandStyle}>APGMS</div>
            <div style={portalTitleStyle}>Regulator Portal</div>
            <div style={orgBadgeStyle}>
              Reviewing <strong>{session.orgId}</strong>
            </div>
          </div>
          <nav style={{ display: "grid", gap: "8px" }}>
            {navItems.map((item) => (
              <NavLink
                key={item.to}
                to={item.to}
                style={({ isActive }) => ({
                  display: "block",
                  padding: "10px 12px",
                  borderRadius: "8px",
                  fontSize: "14px",
                  fontWeight: isActive ? 600 : 500,
                  color: isActive ? "#0b5fff" : "#1e293b",
                  backgroundColor: isActive ? "rgba(11, 95, 255, 0.1)" : "transparent",
                  textDecoration: "none",
                })}
              >
                {item.label}
              </NavLink>
            ))}
          </nav>
        </div>
        <button type="button" onClick={handleLogout} style={logoutButtonStyle}>
          Sign out
        </button>
      </aside>
      <main style={contentShellStyle}>
        <div style={contentInnerStyle}>
          <Outlet />
        </div>
      </main>
    </div>
  );
}

const outerStyle: React.CSSProperties = {
  display: "flex",
  minHeight: "100vh",
  backgroundColor: "#f8fafc",
  fontFamily: "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
};

const sidebarStyle: React.CSSProperties = {
  width: "260px",
  background: "#ffffff",
  borderRight: "1px solid #e2e8f0",
  padding: "28px 22px",
  display: "flex",
  flexDirection: "column",
  justifyContent: "space-between",
};

const brandStyle: React.CSSProperties = {
  fontSize: "14px",
  textTransform: "uppercase",
  letterSpacing: "0.12em",
  fontWeight: 700,
  color: "#6366f1",
};

const portalTitleStyle: React.CSSProperties = {
  marginTop: "6px",
  fontSize: "20px",
  fontWeight: 700,
  color: "#0f172a",
};

const orgBadgeStyle: React.CSSProperties = {
  marginTop: "12px",
  fontSize: "13px",
  color: "#475569",
  background: "#e2e8f0",
  borderRadius: "999px",
  padding: "6px 12px",
  display: "inline-block",
};

const contentShellStyle: React.CSSProperties = {
  flex: 1,
  padding: "36px",
  overflowY: "auto",
};

const contentInnerStyle: React.CSSProperties = {
  maxWidth: "1200px",
  margin: "0 auto",
  display: "grid",
  gap: "24px",
};

const logoutButtonStyle: React.CSSProperties = {
  marginTop: "32px",
  padding: "10px 12px",
  fontSize: "14px",
  borderRadius: "8px",
  border: "1px solid #cbd5f5",
  background: "transparent",
  color: "#1e293b",
  cursor: "pointer",
  fontWeight: 500,
};



============================================================
FILE: C:\src\apgms-final\webapp\src\RegulatorLoginPage.tsx
============================================================
import React, { useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import { regulatorLogin } from "./api";
import { saveRegulatorSession } from "./regulatorAuth";

export default function RegulatorLoginPage() {
  const navigate = useNavigate();
  const [accessCode, setAccessCode] = useState("");
  const [orgId, setOrgId] = useState("dev-org");
  const [error, setError] = useState<string | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(event: React.FormEvent) {
    event.preventDefault();
    setError(null);
    setIsSubmitting(true);
    try {
      const result = await regulatorLogin(accessCode, orgId);
      saveRegulatorSession({
        token: result.token,
        orgId: result.orgId,
        session: result.session,
      });
      navigate("/regulator/portal/overview", { replace: true });
    } catch (err) {
      const message =
        err instanceof Error ? err.message.replace(/_/g, " ") : "login_failed";
      setError(message);
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <div style={containerStyle}>
      <div style={cardStyle}>
        <h1 style={titleStyle}>APGMS Regulator Login</h1>
        <p style={subtitleStyle}>
          Use the short-lived access code issued for sandbox review.
        </p>
        <form onSubmit={handleSubmit} style={formStyle}>
          <label style={labelStyle}>
            <span>Access code</span>
            <input
              type="password"
              value={accessCode}
              onChange={(event) => setAccessCode(event.target.value)}
              placeholder="Enter access code"
              style={inputStyle}
              autoComplete="one-time-code"
              required
            />
          </label>
          <label style={labelStyle}>
            <span>Organisation ID</span>
            <input
              value={orgId}
              onChange={(event) => setOrgId(event.target.value)}
              placeholder="dev-org"
              style={inputStyle}
            />
            <span style={helperTextStyle}>
              Default is <code>dev-org</code>; override to inspect another tenant.
            </span>
          </label>
          {error ? (
            <div style={errorStyle}>
              {error}
            </div>
          ) : null}
          <button
            type="submit"
            disabled={isSubmitting}
            style={{
              ...submitButtonStyle,
              opacity: isSubmitting ? 0.7 : 1,
              cursor: isSubmitting ? "not-allowed" : "pointer",
            }}
          >
            {isSubmitting ? "Signing in..." : "Sign in"}
          </button>
        </form>
        <div style={footerStyle}>
          <Link to="/" style={linkStyle}>
            Back to admin portal
          </Link>
        </div>
      </div>
    </div>
  );
}

