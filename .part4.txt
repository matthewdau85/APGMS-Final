                <span class="quiet">Statements</span>
                <span class='fraction'>6/19</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>0/11</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>0/5</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">31.57% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>6/19</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line low'></div>
    <div class="pad1">
<table class="coverage-summary">
<thead>
<tr>
   <th data-col="file" data-fmt="html" data-html="true" class="file">File</th>
   <th data-col="pic" data-type="number" data-fmt="html" data-html="true" class="pic"></th>
   <th data-col="statements" data-type="number" data-fmt="pct" class="pct">Statements</th>
   <th data-col="statements_raw" data-type="number" data-fmt="html" class="abs"></th>
   <th data-col="branches" data-type="number" data-fmt="pct" class="pct">Branches</th>
   <th data-col="branches_raw" data-type="number" data-fmt="html" class="abs"></th>
   <th data-col="functions" data-type="number" data-fmt="pct" class="pct">Functions</th>
   <th data-col="functions_raw" data-type="number" data-fmt="html" class="abs"></th>
   <th data-col="lines" data-type="number" data-fmt="pct" class="pct">Lines</th>
   <th data-col="lines_raw" data-type="number" data-fmt="html" class="abs"></th>
</tr>
</thead>
<tbody><tr>
	<td class="file low" data-value="errors.ts"><a href="errors.ts.html">errors.ts</a></td>
	<td data-value="31.57" class="pic low">
	<div class="chart"><div class="cover-fill" style="width: 31%"></div><div class="cover-empty" style="width: 69%"></div></div>
	</td>
	<td data-value="31.57" class="pct low">31.57%</td>
	<td data-value="19" class="abs low">6/19</td>
	<td data-value="0" class="pct low">0%</td>
	<td data-value="11" class="abs low">0/11</td>
	<td data-value="0" class="pct low">0%</td>
	<td data-value="5" class="abs low">0/5</td>
	<td data-value="31.57" class="pct low">31.57%</td>
	<td data-value="19" class="abs low">6/19</td>
	</tr>

</tbody>
</table>
</div>
                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-11-24T09:45:15.412Z
            </div>
        <script src="../../../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../../../sorter.js"></script>
        <script src="../../../../block-navigation.js"></script>
    </body>
</html>
    


============================================================
FILE: C:\src\apgms-final\coverage\lcov-report\services\api-gateway\src\observability\index.html
============================================================

<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for services/api-gateway/src/observability</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../../prettify.css" />
    <link rel="stylesheet" href="../../../../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../../../../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../../../../index.html">All files</a> services/api-gateway/src/observability</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">80.43% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>37/46</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">40% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>4/10</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">57.14% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>4/7</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">80.43% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>37/46</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line high'></div>
    <div class="pad1">
<table class="coverage-summary">
<thead>
<tr>
   <th data-col="file" data-fmt="html" data-html="true" class="file">File</th>
   <th data-col="pic" data-type="number" data-fmt="html" data-html="true" class="pic"></th>
   <th data-col="statements" data-type="number" data-fmt="pct" class="pct">Statements</th>
   <th data-col="statements_raw" data-type="number" data-fmt="html" class="abs"></th>
   <th data-col="branches" data-type="number" data-fmt="pct" class="pct">Branches</th>
   <th data-col="branches_raw" data-type="number" data-fmt="html" class="abs"></th>
   <th data-col="functions" data-type="number" data-fmt="pct" class="pct">Functions</th>
   <th data-col="functions_raw" data-type="number" data-fmt="html" class="abs"></th>
   <th data-col="lines" data-type="number" data-fmt="pct" class="pct">Lines</th>
   <th data-col="lines_raw" data-type="number" data-fmt="html" class="abs"></th>
</tr>
</thead>
<tbody><tr>
	<td class="file high" data-value="metrics.ts"><a href="metrics.ts.html">metrics.ts</a></td>
	<td data-value="80.43" class="pic high">
	<div class="chart"><div class="cover-fill" style="width: 80%"></div><div class="cover-empty" style="width: 20%"></div></div>
	</td>
	<td data-value="80.43" class="pct high">80.43%</td>
	<td data-value="46" class="abs high">37/46</td>
	<td data-value="40" class="pct low">40%</td>
	<td data-value="10" class="abs low">4/10</td>
	<td data-value="57.14" class="pct medium">57.14%</td>
	<td data-value="7" class="abs medium">4/7</td>
	<td data-value="80.43" class="pct high">80.43%</td>
	<td data-value="46" class="abs high">37/46</td>
	</tr>

</tbody>
</table>
</div>
                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-11-24T09:45:15.412Z
            </div>
        <script src="../../../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../../../sorter.js"></script>
        <script src="../../../../block-navigation.js"></script>
    </body>
</html>
    


============================================================
FILE: C:\src\apgms-final\coverage\lcov-report\services\api-gateway\src\observability\metrics.ts.html
============================================================

<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for services/api-gateway/src/observability/metrics.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../../prettify.css" />
    <link rel="stylesheet" href="../../../../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../../../../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../../../../index.html">All files</a> / <a href="index.html">services/api-gateway/src/observability</a> metrics.ts</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">80.43% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>37/46</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">40% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>4/10</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">57.14% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>4/7</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">80.43% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>37/46</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line high'></div>
    <pre><table class="coverage">
<tr><td class="line-count quiet"><a name='L1'></a><a href='#L1'>1</a>
<a name='L2'></a><a href='#L2'>2</a>
<a name='L3'></a><a href='#L3'>3</a>
<a name='L4'></a><a href='#L4'>4</a>
<a name='L5'></a><a href='#L5'>5</a>
<a name='L6'></a><a href='#L6'>6</a>
<a name='L7'></a><a href='#L7'>7</a>
<a name='L8'></a><a href='#L8'>8</a>
<a name='L9'></a><a href='#L9'>9</a>
<a name='L10'></a><a href='#L10'>10</a>
<a name='L11'></a><a href='#L11'>11</a>
<a name='L12'></a><a href='#L12'>12</a>
<a name='L13'></a><a href='#L13'>13</a>
<a name='L14'></a><a href='#L14'>14</a>
<a name='L15'></a><a href='#L15'>15</a>
<a name='L16'></a><a href='#L16'>16</a>
<a name='L17'></a><a href='#L17'>17</a>
<a name='L18'></a><a href='#L18'>18</a>
<a name='L19'></a><a href='#L19'>19</a>
<a name='L20'></a><a href='#L20'>20</a>
<a name='L21'></a><a href='#L21'>21</a>
<a name='L22'></a><a href='#L22'>22</a>
<a name='L23'></a><a href='#L23'>23</a>
<a name='L24'></a><a href='#L24'>24</a>
<a name='L25'></a><a href='#L25'>25</a>
<a name='L26'></a><a href='#L26'>26</a>
<a name='L27'></a><a href='#L27'>27</a>
<a name='L28'></a><a href='#L28'>28</a>
<a name='L29'></a><a href='#L29'>29</a>
<a name='L30'></a><a href='#L30'>30</a>
<a name='L31'></a><a href='#L31'>31</a>
<a name='L32'></a><a href='#L32'>32</a>
<a name='L33'></a><a href='#L33'>33</a>
<a name='L34'></a><a href='#L34'>34</a>
<a name='L35'></a><a href='#L35'>35</a>
<a name='L36'></a><a href='#L36'>36</a>
<a name='L37'></a><a href='#L37'>37</a>
<a name='L38'></a><a href='#L38'>38</a>
<a name='L39'></a><a href='#L39'>39</a>
<a name='L40'></a><a href='#L40'>40</a>
<a name='L41'></a><a href='#L41'>41</a>
<a name='L42'></a><a href='#L42'>42</a>
<a name='L43'></a><a href='#L43'>43</a>
<a name='L44'></a><a href='#L44'>44</a>
<a name='L45'></a><a href='#L45'>45</a>
<a name='L46'></a><a href='#L46'>46</a>
<a name='L47'></a><a href='#L47'>47</a>
<a name='L48'></a><a href='#L48'>48</a>
<a name='L49'></a><a href='#L49'>49</a>
<a name='L50'></a><a href='#L50'>50</a>
<a name='L51'></a><a href='#L51'>51</a>
<a name='L52'></a><a href='#L52'>52</a>
<a name='L53'></a><a href='#L53'>53</a>
<a name='L54'></a><a href='#L54'>54</a>
<a name='L55'></a><a href='#L55'>55</a>
<a name='L56'></a><a href='#L56'>56</a>
<a name='L57'></a><a href='#L57'>57</a>
<a name='L58'></a><a href='#L58'>58</a>
<a name='L59'></a><a href='#L59'>59</a>
<a name='L60'></a><a href='#L60'>60</a>
<a name='L61'></a><a href='#L61'>61</a>
<a name='L62'></a><a href='#L62'>62</a>
<a name='L63'></a><a href='#L63'>63</a>
<a name='L64'></a><a href='#L64'>64</a>
<a name='L65'></a><a href='#L65'>65</a>
<a name='L66'></a><a href='#L66'>66</a>
<a name='L67'></a><a href='#L67'>67</a>
<a name='L68'></a><a href='#L68'>68</a>
<a name='L69'></a><a href='#L69'>69</a>
<a name='L70'></a><a href='#L70'>70</a>
<a name='L71'></a><a href='#L71'>71</a>
<a name='L72'></a><a href='#L72'>72</a>
<a name='L73'></a><a href='#L73'>73</a>
<a name='L74'></a><a href='#L74'>74</a>
<a name='L75'></a><a href='#L75'>75</a>
<a name='L76'></a><a href='#L76'>76</a>
<a name='L77'></a><a href='#L77'>77</a>
<a name='L78'></a><a href='#L78'>78</a>
<a name='L79'></a><a href='#L79'>79</a>
<a name='L80'></a><a href='#L80'>80</a>
<a name='L81'></a><a href='#L81'>81</a>
<a name='L82'></a><a href='#L82'>82</a>
<a name='L83'></a><a href='#L83'>83</a>
<a name='L84'></a><a href='#L84'>84</a>
<a name='L85'></a><a href='#L85'>85</a>
<a name='L86'></a><a href='#L86'>86</a>
<a name='L87'></a><a href='#L87'>87</a>
<a name='L88'></a><a href='#L88'>88</a>
<a name='L89'></a><a href='#L89'>89</a>
<a name='L90'></a><a href='#L90'>90</a>
<a name='L91'></a><a href='#L91'>91</a>
<a name='L92'></a><a href='#L92'>92</a>
<a name='L93'></a><a href='#L93'>93</a>
<a name='L94'></a><a href='#L94'>94</a>
<a name='L95'></a><a href='#L95'>95</a>
<a name='L96'></a><a href='#L96'>96</a>
<a name='L97'></a><a href='#L97'>97</a>
<a name='L98'></a><a href='#L98'>98</a>
<a name='L99'></a><a href='#L99'>99</a>
<a name='L100'></a><a href='#L100'>100</a>
<a name='L101'></a><a href='#L101'>101</a>
<a name='L102'></a><a href='#L102'>102</a>
<a name='L103'></a><a href='#L103'>103</a>
<a name='L104'></a><a href='#L104'>104</a>
<a name='L105'></a><a href='#L105'>105</a>
<a name='L106'></a><a href='#L106'>106</a>
<a name='L107'></a><a href='#L107'>107</a>
<a name='L108'></a><a href='#L108'>108</a>
<a name='L109'></a><a href='#L109'>109</a>
<a name='L110'></a><a href='#L110'>110</a>
<a name='L111'></a><a href='#L111'>111</a>
<a name='L112'></a><a href='#L112'>112</a>
<a name='L113'></a><a href='#L113'>113</a>
<a name='L114'></a><a href='#L114'>114</a>
<a name='L115'></a><a href='#L115'>115</a>
<a name='L116'></a><a href='#L116'>116</a>
<a name='L117'></a><a href='#L117'>117</a>
<a name='L118'></a><a href='#L118'>118</a>
<a name='L119'></a><a href='#L119'>119</a>
<a name='L120'></a><a href='#L120'>120</a>
<a name='L121'></a><a href='#L121'>121</a>
<a name='L122'></a><a href='#L122'>122</a>
<a name='L123'></a><a href='#L123'>123</a>
<a name='L124'></a><a href='#L124'>124</a>
<a name='L125'></a><a href='#L125'>125</a>
<a name='L126'></a><a href='#L126'>126</a>
<a name='L127'></a><a href='#L127'>127</a>
<a name='L128'></a><a href='#L128'>128</a>
<a name='L129'></a><a href='#L129'>129</a>
<a name='L130'></a><a href='#L130'>130</a>
<a name='L131'></a><a href='#L131'>131</a>
<a name='L132'></a><a href='#L132'>132</a>
<a name='L133'></a><a href='#L133'>133</a>
<a name='L134'></a><a href='#L134'>134</a>
<a name='L135'></a><a href='#L135'>135</a>
<a name='L136'></a><a href='#L136'>136</a>
<a name='L137'></a><a href='#L137'>137</a>
<a name='L138'></a><a href='#L138'>138</a>
<a name='L139'></a><a href='#L139'>139</a>
<a name='L140'></a><a href='#L140'>140</a>
<a name='L141'></a><a href='#L141'>141</a>
<a name='L142'></a><a href='#L142'>142</a>
<a name='L143'></a><a href='#L143'>143</a>
<a name='L144'></a><a href='#L144'>144</a>
<a name='L145'></a><a href='#L145'>145</a>
<a name='L146'></a><a href='#L146'>146</a>
<a name='L147'></a><a href='#L147'>147</a>
<a name='L148'></a><a href='#L148'>148</a>
<a name='L149'></a><a href='#L149'>149</a>
<a name='L150'></a><a href='#L150'>150</a>
<a name='L151'></a><a href='#L151'>151</a>
<a name='L152'></a><a href='#L152'>152</a>
<a name='L153'></a><a href='#L153'>153</a>
<a name='L154'></a><a href='#L154'>154</a>
<a name='L155'></a><a href='#L155'>155</a>
<a name='L156'></a><a href='#L156'>156</a>
<a name='L157'></a><a href='#L157'>157</a>
<a name='L158'></a><a href='#L158'>158</a>
<a name='L159'></a><a href='#L159'>159</a>
<a name='L160'></a><a href='#L160'>160</a>
<a name='L161'></a><a href='#L161'>161</a>
<a name='L162'></a><a href='#L162'>162</a>
<a name='L163'></a><a href='#L163'>163</a>
<a name='L164'></a><a href='#L164'>164</a>
<a name='L165'></a><a href='#L165'>165</a>
<a name='L166'></a><a href='#L166'>166</a>
<a name='L167'></a><a href='#L167'>167</a>
<a name='L168'></a><a href='#L168'>168</a>
<a name='L169'></a><a href='#L169'>169</a>
<a name='L170'></a><a href='#L170'>170</a>
<a name='L171'></a><a href='#L171'>171</a>
<a name='L172'></a><a href='#L172'>172</a>
<a name='L173'></a><a href='#L173'>173</a>
<a name='L174'></a><a href='#L174'>174</a>
<a name='L175'></a><a href='#L175'>175</a>
<a name='L176'></a><a href='#L176'>176</a>
<a name='L177'></a><a href='#L177'>177</a>
<a name='L178'></a><a href='#L178'>178</a>
<a name='L179'></a><a href='#L179'>179</a>
<a name='L180'></a><a href='#L180'>180</a>
<a name='L181'></a><a href='#L181'>181</a>
<a name='L182'></a><a href='#L182'>182</a>
<a name='L183'></a><a href='#L183'>183</a>
<a name='L184'></a><a href='#L184'>184</a>
<a name='L185'></a><a href='#L185'>185</a>
<a name='L186'></a><a href='#L186'>186</a>
<a name='L187'></a><a href='#L187'>187</a>
<a name='L188'></a><a href='#L188'>188</a>
<a name='L189'></a><a href='#L189'>189</a>
<a name='L190'></a><a href='#L190'>190</a>
<a name='L191'></a><a href='#L191'>191</a>
<a name='L192'></a><a href='#L192'>192</a>
<a name='L193'></a><a href='#L193'>193</a>
<a name='L194'></a><a href='#L194'>194</a>
<a name='L195'></a><a href='#L195'>195</a></td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import type { FastifyInstance, FastifyReply, FastifyRequest } from 'fastify';
import {
  Counter,
  Histogram,
  Gauge,
  collectDefaultMetrics,
  register as promRegister,
} from 'prom-client';
&nbsp;
// ---- Registry &amp; default process metrics ----
collectDefaultMetrics({ register: promRegister });
&nbsp;
// ---- HTTP metrics ----
const httpRequestTotal = new Counter({
  name: 'apgms_http_requests_total',
  help: 'Total HTTP requests by method, route, and status code',
  labelNames: ['method', 'route', 'status'] as const,
});
&nbsp;
const httpRequestDuration = new Histogram({
  name: 'apgms_http_request_duration_seconds',
  help: 'HTTP request duration histogram',
  labelNames: ['method', 'route', 'status'] as const,
  buckets: [0.025, 0.05, 0.1, 0.25, 0.5, 1, 2, 5, 10],
});
&nbsp;
// ---- DB metrics (use from your Prisma middleware) ----
const dbQueryDuration = new Histogram({
  name: 'apgms_db_query_duration_seconds',
  help: 'Prisma query duration by model and operation',
  labelNames: ['model', 'operation'] as const,
  buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1],
});
&nbsp;
const dbQueryTotal = new Counter({
  name: 'apgms_db_queries_total',
  help: 'Total Prisma queries by model, operation, and status',
  labelNames: ['model', 'operation', 'status'] as const,
});
&nbsp;
// ---- Background job metrics ----
const jobDuration = new Histogram({
  name: 'apgms_job_duration_seconds',
  help: 'Background job duration histogram',
  labelNames: ['job'] as const,
  buckets: [0.1, 0.25, 0.5, 1, 2, 5, 10, 30],
});
&nbsp;
const integrationEventDuration = new Histogram({
  name: 'apgms_integration_event_duration_seconds',
  help: 'Time to process payroll / POS integration events',
  labelNames: ['tax_type', 'status'] as const,
  buckets: [0.01, 0.05, 0.1, 0.25, 0.5, 1],
});
&nbsp;
const integrationEventsTotal = new Counter({
  name: 'apgms_integration_events_total',
  help: 'Total payroll / POS integration events processed',
  labelNames: ['tax_type', 'status'] as const,
});
&nbsp;
const integrationDiscrepanciesTotal = new Counter({
  name: 'apgms_integration_discrepancies_total',
  help: 'Discrepancy alerts raised when amounts mismatch expected values',
  labelNames: ['tax_type', 'severity'] as const,
});
&nbsp;
const obligationsTotal = new Gauge({
  name: 'apgms_integration_pending_obligation_amount',
  help: 'Current pending obligations per tax type',
  labelNames: ['tax_type'] as const,
});
&nbsp;
const integrationAnomalyScore = new Gauge({
  name: 'apgms_integration_anomaly_score',
  help: 'Heuristic anomaly score ([-1,1]) for integration feeds',
  labelNames: ['tax_type', 'severity'] as const,
});
&nbsp;
const basLodgmentsTotal = new Counter({
  name: 'apgms_bas_lodgments_total',
  help: 'Total BAS lodgment attempts',
  labelNames: ['status'] as const,
});
&nbsp;
const transferInstructionTotal = new Counter({
  name: 'apgms_transfer_instructions_total',
  help: 'Transfer instructions generated for BAS lodgments',
  labelNames: ['tax_type', 'status'] as const,
});
&nbsp;
const transferExecutionTotal = new Counter({
  name: 'apgms_transfer_execution_total',
  help: 'Execution attempts for transfer instructions',
  labelNames: ['status'] as const,
});
&nbsp;
const paymentPlanRequestsTotal = new Counter({
  name: 'apgms_payment_plan_requests_total',
  help: 'Payment plan requests created after failed BAS lodgments',
  labelNames: ['status'] as const,
});
&nbsp;
const atoReportsTotal = new Counter({
  name: 'apgms_ato_reports_total',
  help: 'ATO compliance reports submitted',
  labelNames: ['status'] as const,
});
&nbsp;
const riskEventsTotal = new Counter({
  name: 'apgms_risk_events_total',
  help: 'Risk events recorded',
  labelNames: ['severity'] as const,
});
&nbsp;
// ---- Public API for DB/jobs instrumentation ----
export const metrics = {
  httpRequestTotal,
  httpRequestDuration,
  dbQueryDuration,
  dbQueryTotal,
  jobDuration,
  integrationEventDuration,
  integrationEventsTotal,
  integrationDiscrepanciesTotal,
  obligationsTotal,
  integrationAnomalyScore,
  basLodgmentsTotal,
  transferInstructionTotal,
  transferExecutionTotal,
  paymentPlanRequestsTotal,
  atoReportsTotal,
  riskEventsTotal,
&nbsp;
<span class="fstat-no" title="function not covered" >  async </span>observeJob&lt;T&gt;(job: string, fn: () =&gt; Promise&lt;T&gt;): Promise&lt;T&gt; {
    const stop = <span class="cstat-no" title="statement not covered" >jobDuration.startTimer({ job });</span>
<span class="cstat-no" title="statement not covered" >    try {</span>
      const result = <span class="cstat-no" title="statement not covered" >await fn();</span>
<span class="cstat-no" title="statement not covered" >      stop();</span>
<span class="cstat-no" title="statement not covered" >      return result;</span>
    } catch (err) {
<span class="cstat-no" title="statement not covered" >      stop();</span>
<span class="cstat-no" title="statement not covered" >      throw err;</span>
    }
  },
};
&nbsp;
export { <span class="fstat-no" title="function not covered" >promRegister </span>};
&nbsp;
// ---- /metrics route (Prometheus text format) ----
export function registerMetricsRoute(app: FastifyInstance) {
  app.get('/metrics', <span class="fstat-no" title="function not covered" >async </span>(_req, reply) =&gt; {
<span class="cstat-no" title="statement not covered" >    reply.header('Content-Type', promRegister.contentType);</span>
<span class="cstat-no" title="statement not covered" >    return promRegister.metrics();</span>
  });
}
&nbsp;
// ---- Optional Fastify hooks to auto-collect HTTP metrics ----
type ReqWithStart = FastifyRequest &amp; { _apgmsStartNs?: bigint };
&nbsp;
export function installHttpMetrics(app: FastifyInstance) {
  app.addHook('onRequest', (req: ReqWithStart, _reply, done) =&gt; {
    // monotonic clock for duration
    req._apgmsStartNs = process.hrtime.bigint();
    done();
  });
&nbsp;
  app.addHook('onResponse', (req: ReqWithStart, reply: FastifyReply, done) =&gt; {
    try {
      const endNs = process.hrtime.bigint();
      const startNs = req._apgmsStartNs ?? <span class="branch-1 cbranch-no" title="branch not covered" >endNs;</span>
      const durSeconds = Number(endNs - startNs) / 1e9;
&nbsp;
      const method = (req.method || <span class="branch-1 cbranch-no" title="branch not covered" >'GET')</span>.toUpperCase();
      const status = String(reply.statusCode || <span class="branch-1 cbranch-no" title="branch not covered" >0)</span>;
&nbsp;
      // Try to get a stable route template; fall back to raw URL
      // Fastify v4: request.routeOptions.url is usually present for registered routes
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const route =
        (req as any).routeOptions?.url ||
        // older plugin contexts sometimes expose routerPath
        (<span class="branch-1 cbranch-no" title="branch not covered" >req as any).routerPath </span>||
<span class="branch-2 cbranch-no" title="branch not covered" >        req.url </span>||
<span class="branch-3 cbranch-no" title="branch not covered" >        'unknown';</span>
&nbsp;
      httpRequestTotal.inc({ method, route, status }, 1);
      httpRequestDuration.observe({ method, route, status }, durSeconds);
    } catch {
      // never block responses on metrics errors
    }
    done();
  });
}
&nbsp;</pre></td></tr></table></pre>

                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-11-24T09:45:15.412Z
            </div>
        <script src="../../../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../../../sorter.js"></script>
        <script src="../../../../block-navigation.js"></script>
    </body>
</html>
    


============================================================
FILE: C:\src\apgms-final\coverage\lcov-report\services\api-gateway\src\security-headers.ts.html
============================================================

<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for services/api-gateway/src/security-headers.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../../../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../../../index.html">All files</a> / <a href="index.html">services/api-gateway/src</a> security-headers.ts</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">100% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>2/2</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">100% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>0/0</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">100% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>1/1</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">100% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>2/2</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line high'></div>
    <pre><table class="coverage">
<tr><td class="line-count quiet"><a name='L1'></a><a href='#L1'>1</a>
<a name='L2'></a><a href='#L2'>2</a>
<a name='L3'></a><a href='#L3'>3</a>
<a name='L4'></a><a href='#L4'>4</a>
<a name='L5'></a><a href='#L5'>5</a>
<a name='L6'></a><a href='#L6'>6</a>
<a name='L7'></a><a href='#L7'>7</a>
<a name='L8'></a><a href='#L8'>8</a>
<a name='L9'></a><a href='#L9'>9</a>
<a name='L10'></a><a href='#L10'>10</a>
<a name='L11'></a><a href='#L11'>11</a>
<a name='L12'></a><a href='#L12'>12</a>
<a name='L13'></a><a href='#L13'>13</a>
<a name='L14'></a><a href='#L14'>14</a>
<a name='L15'></a><a href='#L15'>15</a>
<a name='L16'></a><a href='#L16'>16</a>
<a name='L17'></a><a href='#L17'>17</a>
<a name='L18'></a><a href='#L18'>18</a>
<a name='L19'></a><a href='#L19'>19</a>
<a name='L20'></a><a href='#L20'>20</a>
<a name='L21'></a><a href='#L21'>21</a>
<a name='L22'></a><a href='#L22'>22</a>
<a name='L23'></a><a href='#L23'>23</a>
<a name='L24'></a><a href='#L24'>24</a>
<a name='L25'></a><a href='#L25'>25</a>
<a name='L26'></a><a href='#L26'>26</a>
<a name='L27'></a><a href='#L27'>27</a>
<a name='L28'></a><a href='#L28'>28</a>
<a name='L29'></a><a href='#L29'>29</a>
<a name='L30'></a><a href='#L30'>30</a>
<a name='L31'></a><a href='#L31'>31</a>
<a name='L32'></a><a href='#L32'>32</a>
<a name='L33'></a><a href='#L33'>33</a>
<a name='L34'></a><a href='#L34'>34</a>
<a name='L35'></a><a href='#L35'>35</a>
<a name='L36'></a><a href='#L36'>36</a>
<a name='L37'></a><a href='#L37'>37</a>
<a name='L38'></a><a href='#L38'>38</a>
<a name='L39'></a><a href='#L39'>39</a></td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import type { FastifyHelmetOptions } from "@fastify/helmet";
import type { AppConfig } from "./config.js";
&nbsp;
/**
 * Extracted helmet configuration to keep security policy testable.
 */
export function helmetConfigFor(cfg: AppConfig): FastifyHelmetOptions {
  return {
    hidePoweredBy: true,
    frameguard: { action: "deny" },
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        baseUri: ["'self'"],
        connectSrc: ["'self'", ...cfg.cors.allowedOrigins],
        scriptSrc: [
          "'self'",
          // Inline boot script hash â€“ keep this in sync with the webapp if changed
          "'sha256-+Ul8C6HpBvEV0hgFekKPKiEh0Ug3SIn50SjA+iyTNHo='",
        ],
        styleSrc: ["'self'", "'unsafe-inline'"],
        imgSrc: ["'self'", "data:"],
        objectSrc: ["'none'"],
        frameAncestors: ["'none'"],
      },
    },
    crossOriginEmbedderPolicy: false,
    crossOriginResourcePolicy: { policy: "same-site" as const },
    dnsPrefetchControl: { allow: false },
    referrerPolicy: { policy: "no-referrer" as const },
    xssFilter: true,
    hsts: {
      maxAge: 15_552_000, // 180 days
      includeSubDomains: true,
      preload: true,
    },
  };
}
&nbsp;</pre></td></tr></table></pre>

                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-11-24T09:45:15.412Z
            </div>
        <script src="../../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../../sorter.js"></script>
        <script src="../../../block-navigation.js"></script>
    </body>
</html>
    


============================================================
FILE: C:\src\apgms-final\coverage\lcov-report\sorter.js
============================================================
/* eslint-disable */
var addSorting = (function() {
    'use strict';
    var cols,
        currentSort = {
            index: 0,
            desc: false
        };

    // returns the summary table element
    function getTable() {
        return document.querySelector('.coverage-summary');
    }
    // returns the thead element of the summary table
    function getTableHeader() {
        return getTable().querySelector('thead tr');
    }
    // returns the tbody element of the summary table
    function getTableBody() {
        return getTable().querySelector('tbody');
    }
    // returns the th element for nth column
    function getNthColumn(n) {
        return getTableHeader().querySelectorAll('th')[n];
    }

    function onFilterInput() {
        const searchValue = document.getElementById('fileSearch').value;
        const rows = document.getElementsByTagName('tbody')[0].children;

        // Try to create a RegExp from the searchValue. If it fails (invalid regex),
        // it will be treated as a plain text search
        let searchRegex;
        try {
            searchRegex = new RegExp(searchValue, 'i'); // 'i' for case-insensitive
        } catch (error) {
            searchRegex = null;
        }

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            let isMatch = false;

            if (searchRegex) {
                // If a valid regex was created, use it for matching
                isMatch = searchRegex.test(row.textContent);
            } else {
                // Otherwise, fall back to the original plain text search
                isMatch = row.textContent
                    .toLowerCase()
                    .includes(searchValue.toLowerCase());
            }

            row.style.display = isMatch ? '' : 'none';
        }
    }

    // loads the search box
    function addSearchBox() {
        var template = document.getElementById('filterTemplate');
        var templateClone = template.content.cloneNode(true);
        templateClone.getElementById('fileSearch').oninput = onFilterInput;
        template.parentElement.appendChild(templateClone);
    }

    // loads all columns
    function loadColumns() {
        var colNodes = getTableHeader().querySelectorAll('th'),
            colNode,
            cols = [],
            col,
            i;

        for (i = 0; i < colNodes.length; i += 1) {
            colNode = colNodes[i];
            col = {
                key: colNode.getAttribute('data-col'),
                sortable: !colNode.getAttribute('data-nosort'),
                type: colNode.getAttribute('data-type') || 'string'
            };
            cols.push(col);
            if (col.sortable) {
                col.defaultDescSort = col.type === 'number';
                colNode.innerHTML =
                    colNode.innerHTML + '<span class="sorter"></span>';
            }
        }
        return cols;
    }
    // attaches a data attribute to every tr element with an object
    // of data values keyed by column name
    function loadRowData(tableRow) {
        var tableCols = tableRow.querySelectorAll('td'),
            colNode,
            col,
            data = {},
            i,
            val;
        for (i = 0; i < tableCols.length; i += 1) {
            colNode = tableCols[i];
            col = cols[i];
            val = colNode.getAttribute('data-value');
            if (col.type === 'number') {
                val = Number(val);
            }
            data[col.key] = val;
        }
        return data;
    }
    // loads all row data
    function loadData() {
        var rows = getTableBody().querySelectorAll('tr'),
            i;

        for (i = 0; i < rows.length; i += 1) {
            rows[i].data = loadRowData(rows[i]);
        }
    }
    // sorts the table using the data for the ith column
    function sortByIndex(index, desc) {
        var key = cols[index].key,
            sorter = function(a, b) {
                a = a.data[key];
                b = b.data[key];
                return a < b ? -1 : a > b ? 1 : 0;
            },
            finalSorter = sorter,
            tableBody = document.querySelector('.coverage-summary tbody'),
            rowNodes = tableBody.querySelectorAll('tr'),
            rows = [],
            i;

        if (desc) {
            finalSorter = function(a, b) {
                return -1 * sorter(a, b);
            };
        }

        for (i = 0; i < rowNodes.length; i += 1) {
            rows.push(rowNodes[i]);
            tableBody.removeChild(rowNodes[i]);
        }

        rows.sort(finalSorter);

        for (i = 0; i < rows.length; i += 1) {
            tableBody.appendChild(rows[i]);
        }
    }
    // removes sort indicators for current column being sorted
    function removeSortIndicators() {
        var col = getNthColumn(currentSort.index),
            cls = col.className;

        cls = cls.replace(/ sorted$/, '').replace(/ sorted-desc$/, '');
        col.className = cls;
    }
    // adds sort indicators for current column being sorted
    function addSortIndicators() {
        getNthColumn(currentSort.index).className += currentSort.desc
            ? ' sorted-desc'
            : ' sorted';
    }
    // adds event listeners for all sorter widgets
    function enableUI() {
        var i,
            el,
            ithSorter = function ithSorter(i) {
                var col = cols[i];

                return function() {
                    var desc = col.defaultDescSort;

                    if (currentSort.index === i) {
                        desc = !currentSort.desc;
                    }
                    sortByIndex(i, desc);
                    removeSortIndicators();
                    currentSort.index = i;
                    currentSort.desc = desc;
                    addSortIndicators();
                };
            };
        for (i = 0; i < cols.length; i += 1) {
            if (cols[i].sortable) {
                // add the click event handler on the th so users
                // dont have to click on those tiny arrows
                el = getNthColumn(i).querySelector('.sorter').parentElement;
                if (el.addEventListener) {
                    el.addEventListener('click', ithSorter(i));
                } else {
                    el.attachEvent('onclick', ithSorter(i));
                }
            }
        }
    }
    // adds sorting functionality to the UI
    return function() {
        if (!getTable()) {
            return;
        }
        cols = loadColumns();
        loadData();
        addSearchBox();
        addSortIndicators();
        enableUI();
    };
})();

window.addEventListener('load', addSorting);



============================================================
FILE: C:\src\apgms-final\db\payroll.sql
============================================================
-- Employees table
CREATE TABLE "Employee" (
  "id" TEXT PRIMARY KEY,
  "orgId" TEXT NOT NULL REFERENCES "Org"("id") ON DELETE CASCADE,
  "fullNameCiphertext" TEXT NOT NULL,
  "fullNameKid" TEXT NOT NULL,
  "tfnProvided" BOOLEAN NOT NULL DEFAULT false,
  "employmentType" TEXT NOT NULL,
  "baseRate" NUMERIC(12,2) NOT NULL DEFAULT 0,
  "superRate" NUMERIC(5,2) NOT NULL DEFAULT 11.0,
  "status" TEXT NOT NULL DEFAULT 'active',
  "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- PayRun table
CREATE TABLE "PayRun" (
  "id" TEXT PRIMARY KEY,
  "orgId" TEXT NOT NULL REFERENCES "Org"("id") ON DELETE CASCADE,
  "periodStart" TIMESTAMP WITH TIME ZONE NOT NULL,
  "periodEnd" TIMESTAMP WITH TIME ZONE NOT NULL,
  "paymentDate" TIMESTAMP WITH TIME ZONE NOT NULL,
  "status" TEXT NOT NULL DEFAULT 'draft',
  "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Payslip table
CREATE TABLE "Payslip" (
  "id" TEXT PRIMARY KEY,
  "payRunId" TEXT NOT NULL REFERENCES "PayRun"("id") ON DELETE CASCADE,
  "employeeId" TEXT NOT NULL REFERENCES "Employee"("id") ON DELETE CASCADE,

  "grossPay" NUMERIC(12,2) NOT NULL,
  "paygWithheld" NUMERIC(12,2) NOT NULL,
  "superAccrued" NUMERIC(12,2) NOT NULL,

  "notesCiphertext" TEXT NOT NULL,
  "notesKid" TEXT NOT NULL,

  "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- helpful indexes
CREATE INDEX "Employee_orgId_idx" ON "Employee"("orgId");
CREATE INDEX "PayRun_orgId_idx" ON "PayRun"("orgId");
CREATE INDEX "Payslip_payRunId_idx" ON "Payslip"("payRunId");
CREATE INDEX "Payslip_employeeId_idx" ON "Payslip"("employeeId");



============================================================
FILE: C:\src\apgms-final\docker-compose.nats.yml
============================================================
version: "3.9"

services:
  nats:
    image: nats:2.10-alpine
    command:
      - "-js"
      - "-sd"
      - "/data"
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats-data:/data
    restart: unless-stopped

volumes:
  nats-data:



============================================================
FILE: C:\src\apgms-final\docker-compose.yml
============================================================
services:
  db:
    image: postgres:16
    container_name: apgms-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: apgms
    ports:
      - "5432:5432"
    volumes:
      - apgms-final_pgdata:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - apgmsnet

  redis:
    image: redis:7
    container_name: apgms-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - apgmsnet

  tax-engine:
    image: apgms-tax-engine
    container_name: apgms-tax-engine
    restart: unless-stopped
    networks:
      - apgmsnet

  api-gateway:
    image: apgms-final-api-gateway
    container_name: apgms-api-gateway
    depends_on:
      - db
      - redis
      - tax-engine
    restart: unless-stopped
    environment: &gateway_env
      # --- Database URLs ---
      DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"
      SHADOW_DATABASE_URL: "postgresql://postgres:postgres@db:5432/apgms?schema=public"

      # --- Auth / JWT config ---
      AUTH_AUDIENCE: "apgms-local"
      AUTH_ISSUER: "http://auth.local.test"
      AUTH_DEV_SECRET: "local-dev-shared-secret-change-me"
      AUTH_JWKS: >-
        {"keys":[{"kid":"dev-key-1","alg":"RS256"}]}

      # --- PII crypto material ---
      PII_KEYS: >-
        [{"kid":"dev-key-1","material":"GPHZGdDjE+r7X6S6zQA8KRU34GRXPeePjRGN8dkgk00="}]
      PII_ACTIVE_KEY: "dev-key-1"

      PII_SALTS: >-
        [{"sid":"dev-salt-1","secret":"BN10EUaMmjdthpHf3WGjdHrBuXNL4TkzQNg0KALHEB4="}]
      PII_ACTIVE_SALT: "dev-salt-1"

      # --- Rate limit / security knobs ---
      API_RATE_LIMIT_MAX: "60"
      API_RATE_LIMIT_WINDOW: "1 minute"
      AUTH_FAILURE_THRESHOLD: "5"

      # --- CORS for webapp ---
      CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://localhost:3000"

      # --- Internal service URLs ---
      TAX_ENGINE_URL: "http://tax-engine:8000"

      # --- Redis config (important: use the redis service, not localhost) ---
      REDIS_URL: "redis://redis:6379"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

    ports:
      - "3000:3000"
    networks:
      - apgmsnet

  worker:
    image: apgms-final-worker
    container_name: apgms-worker
    depends_on:
      - db
      - redis
      - tax-engine
    restart: on-failure
    environment: *gateway_env
    command: pnpm --filter worker exec tsx src/index.ts
    networks:
      - apgmsnet

networks:
  apgmsnet:
    driver: bridge

volumes:
  apgms-final_pgdata:



============================================================
FILE: C:\src\apgms-final\docs\a11y-statement.md
============================================================
# Accessibility Statement

APGMS is committed to providing a digital experience that is accessible to the widest possible audience, regardless of technology or ability. We actively work toward conforming with the Web Content Accessibility Guidelines (WCAG) version 2.1 Level AA across the primary customer- facing experiences delivered through the APGMS web application.

## Scope

This commitment covers the authenticated and unauthenticated surfaces of the APGMS marketing and account management flows, including the public home page, eligibility journeys, and the `/bank-lines` experience used to manage banking relationships.

## Ongoing Efforts

- Integrating automated accessibility checks powered by Playwright and axe to detect WCAG 2.1 AA issues in critical user journeys.
- Reviewing new UI components during design and development for keyboard operability, color contrast, and assistive technology support.
- Providing internal training and documentation so engineers, designers, and content authors can incorporate accessibility best practices into their work.

## Feedback

We welcome your feedback on the accessibility of APGMS. If you encounter barriers or have suggestions for improvement, please contact our accessibility team at [accessibility@apgms.example](mailto:accessibility@apgms.example). We aim to respond to feedback within five business days and will work with you to provide the information you need in an accessible format.

## Future Improvements

We are continuing to expand manual and assistive technology testing coverage, enhance semantic structure in complex data views, and improve documentation for third-party integrations so all users can complete key tasks without impediment.



============================================================
FILE: C:\src\apgms-final\docs\accessibility\report.md
============================================================
# WCAG audit report

- Playwright @axe runs (pnpm -w exec playwright test webapp/tests/a11y.spec.ts) cover / and /bank-lines.
- No serious/critical violations were detected; full JSON artifacts attach to the CI build for review.




============================================================
FILE: C:\src\apgms-final\docs\accessibility\smoke.md
============================================================
# Accessibility Smoke Tests

Run the Playwright accessibility suite headlessly:

```
pnpm -r test --filter @apgms/webapp test:axe
```

CI executes `pnpm -r test` which includes `webapp/test:axe`; ensure Chromium dependencies are installed with `pnpm exec playwright install --with-deps` locally.




============================================================
FILE: C:\src\apgms-final\docs\accessibility-statement.md
============================================================
# Accessibility Statement

## Our Commitment

APGMS is committed to delivering a digital experience that is inclusive and usable for everyone. Our goal is to conform to the [Web Content Accessibility Guidelines (WCAG) 2.1](https://www.w3.org/TR/WCAG21/) Level AA across our customer and partner experiences.

## Scope

This statement covers the APGMS public marketing site, authenticated customer experiences, and supporting documentation delivered through the APGMS web application. Automated accessibility tests are executed on key user journeys, including the home page and bank lines workflow.

## Testing Approach

We evaluate accessibility on an ongoing basis using automated testing (Playwright with axe-core) and manual review. Automated checks are part of our continuous integration pipeline and run on every change. Failures block deployment until resolved.

## Known Limitations

* Some legacy marketing content may lack complete alternative text or descriptive captions. We are actively auditing and remediating these issues.
* User-generated documents uploaded to the platform may not yet meet WCAG 2.1 AA standards. We provide guidance to authors and continue to improve document templates.
* Third-party widgets embedded in dashboards may not fully support keyboard navigation. We are collaborating with providers to enhance accessibility or identify alternatives.

If you encounter an issue that is not listed above, please let us know so that we can address it promptly.

## Feedback and Contact

We welcome your feedback on the accessibility of APGMS. Please contact the APGMS Accessibility team at [accessibility@apgms.example](mailto:accessibility@apgms.example) with questions, suggestions, or to request alternate formats for any content.

## Statement Updates

This statement was last reviewed in October 2024. We review and update it at least annually, or sooner if significant changes are made to our products.



============================================================
FILE: C:\src\apgms-final\docs\architecture\ADR-001-platform-architecture.md
============================================================
# ADR-001: Platform Architecture & Tenancy

## Status
Accepted â€“ 2025-10-24

## Context
The APGMS platform requires a modular architecture that supports secure ingestion of payroll, POS, and banking data, reconciles obligations in near real-time, and exposes auditable services that satisfy ATO DSP obligations. The existing monorepo already contains an API gateway (`services/api-gateway`) and shared libraries (`shared`). We need a lightweight backbone that can evolve towards the fully featured system outlined in the multi-phase rollout plan without blocking ongoing development.

## Decision
We will adopt a service-oriented topology composed of:

1. **Ingestion Adapters** (`@apgms/ingestion-adapters`) â€“ capture external events, apply deterministic calculations (e.g., PAYGW, GST), and publish normalised events to an internal event bus. Initially the bus is in-memory (for demos/tests) but the service boundary is designed for Kafka/NATS later.
2. **Ledger & Reconciliation Service** (future) â€“ consumes ingestion events, persists to an append-only ledger, and raises discrepancy alerts. This will reuse the shared messaging primitives added in this ADR.
3. **BAS Orchestrator** (future) â€“ reads ledger state and initiates BAS workflows, integrating with the banking adapter for fund releases.
4. **API Gateway** â€“ remains the entry point for UI and partner integrations, reusing shared modules for masking, authentication, and tax calculations.
5. **Shared Library Enhancements** â€“ new reusable modules (`@apgms/shared/tax`, `@apgms/shared/messaging`) provide deterministic calculation helpers and a typed event bus abstraction.

Tenancy is enforced through the event payloads: every emitted event carries an `orgId`, and downstream services must validate scope before mutating state. The simulation sandbox (planned Phase 4) will run in isolated tenants using the same primitives.

## Consequences

- Enables incremental delivery: services can subscribe to ingestion events without tight coupling.
- Shared tax logic ensures PAYGW/GST calculations stay consistent across services and the gateway.
- The in-memory bus keeps local development and tests self-contained while providing a pathway to a production-grade broker.
- Future services (ledger, orchestrator) can be scaffolded rapidly because message contracts and helper utilities already exist.
- We must harden event schemas and introduce schema registry tooling in later phases when moving to a distributed message broker.

## Follow-up

- Implement ledger persistence and schema validation (Phase 1/2).
- Replace in-memory bus with Kafka/NATS bindings once infrastructure is provisioned.
- Extend ADR catalogue with decisions on vault integration, reconciliation storage, and orchestrator workflow engine when those components are implemented.



============================================================
FILE: C:\src\apgms-final\docs\architecture\README.md
============================================================
# C4 + Sequences



============================================================
FILE: C:\src\apgms-final\docs\compliance\checklist.md
============================================================
# Compliance Checklist

Run these checks before each release and record evidence in the release ticket:

- [ ] `pnpm compliance:evidence --tag <release-tag>` (store evidence file under `artifacts/compliance/<release-tag>.md`)
- [ ] Investigate and document any failing command results from the evidence run
- [ ] Exercise the connectors capture endpoints (e.g., `/connectors/capture/payroll`) to deposit test PAYGW/GST funds and verify the generated evidence artifact is available to regulators (see docs/ops/regulator-portal.md).
- [ ] Confirm DPIA/ASVS documentation is current (`docs/privacy/dpia.md`, `docs/security/ASVS-mapping.md`)
- [ ] Ensure the security workflow (SBOM/SCA/Trivy/Gitleaks) succeeded in CI
- [ ] `pnpm smoke:regulator` and capture the console output in the release ticket (proves regulator portal endpoints respond with expected evidence).
- [ ] Capture monitoring evidence (run `node scripts/collect-monitoring-evidence.mjs` with `APGMS_MONITORING_TOKEN`, save artifacts/monitoring/<timestamp>) and link it from the release notes.

Attach the generated evidence file and notes to the release artefact.



============================================================
FILE: C:\src\apgms-final\docs\compliance\designated-accounts.md
============================================================
# Designated Account Controls

APGMS enforces the “deposit only” mandate for GST and PAYGW holding accounts.
The controls added in Phase 4.5 cover three pillars:

- **Provider abstraction**  
  The banking layer now routes through provider adapters (`providers/banking/*`),
  enforcing per-integration rate caps. NAB and ANZ adapters share a common policy
  surface so we can register new institutions without touching downstream code.

- **One-way policy engine**  
  The domain policy (`packages/domain-policy/src/designated-accounts.ts`) only permits credits
  from whitelisted capture sources: `PAYROLL_CAPTURE`, `GST_CAPTURE`, or
  `BAS_ESCROW`. Any debit attempt is rejected, logged, and automatically produces
  a HIGH severity `DESIGNATED_WITHDRAWAL_ATTEMPT` alert for regulator review.
  Alerts carry the pre-defined message `Designated accounts are deposit-only; debits are prohibited`,
  matching the policy violation so regulators can immediately understand why the transfer failed.

- **Nightly reconciliation artefact**  
  A worker job emits a `designated-reconciliation` evidence artefact, including
  24‑hour inflow deltas and a SHA‑256 hash. Regulator portal users can download
  the artefact from the normal evidence listing, providing auditable proof that
  the holding accounts remained ringfenced.

Regulators can open the evidence center (webapp/src/RegulatorEvidencePage.tsx) to browse designated-reconciliation entries sorted by createdAt, view the persisted SHA-256 and wormUri, and click the built-in Verify button (which recomputes the hash client-side) before handing the artefact to auditors.

## Operational Checklist

1. Ensure the following environment variables are set on the API gateway:

   | Variable                        | Purpose                                      |
   | ------------------------------- | -------------------------------------------- |
   | `BANKING_PROVIDER`              | Adapter ID (`nab`, `anz`, `mock`)            |
   | `BANKING_MAX_READ_TRANSACTIONS` | Max transactions fetched per polling window  |
   | `BANKING_MAX_WRITE_CENTS`       | Maximum credit per call (cents)              |

2. Schedule the worker entry point `worker/src/index.ts` to run nightly (e.g. via
   `cron`). The job iterates all organisations and records the reconciliation
   artefact plus audit log entries under `designatedAccount.reconciliation`.

3. Monitor for `DESIGNATED_WITHDRAWAL_ATTEMPT` alerts on the regulator portal.
   Each alert includes metadata describing the blocked request, satisfying the
   “no withdrawals from designated accounts” patent control.

## Phase 4: Nightly Reconciliation Artefact

| Task | Description |
| --- | --- |
| Task 1 | `worker/src/jobs/designated-reconciliation.ts` logs start/end metrics plus per-org artifact hashes, and each run emits `banking-provider` info/warn events so operations can track which adapter processed which organisation. |
| Task 2 | `generateDesignatedAccountReconciliationArtifact` stores the full SHA-256 + totals metadata (`summary`) for the evidence entry; end-to-end tests (e.g., `services/api-gateway/test/designated.policy.spec.ts`) continue to assert the artifact payload, hash, and audit log details. |
| Task 3 | `scripts/verify-designated-reconciliation.mjs` can be executed nightly (via cron or scheduler) against the production database to ensure a `designated-reconciliation` artefact was created in the previous 24 hours, printing the latest `artifactId` and SHA-256 for auditors. |

Runbook: add the verification script to your monitoring cron (or alert pipeline) and point stakeholders at the `RegulatorEvidencePage.tsx` evidence center so they can fetch the `designated-reconciliation` entry, inspect the stored SHA-256, and click “Verify” before handing it to auditors.

## Phase 1: Pillar Baseline

| Pillar | Success Criteria | Phase 1 Tasks |
| --- | --- | --- |
| Provider abstraction | Every banking adapter (`providers/banking/*`) implements the shared interface, respects per-provider rate caps, and can register without downstream changes. | Audit `providers/banking` and the connector wiring for caps/ratios, add a regression test that exercises a mock provider to prove the shared surface is reusable, log per-provider credit attempts plus capped warnings via the new `banking-provider` events, and coordinate a compliance/ops/engineering checkpoint so stakeholders agree when the pillar is “5/5”. |
| One-way policy engine | `@apgms/domain-policy` is the sole enforcement point for deposits, only allows `PAYROLL_CAPTURE`, `GST_CAPTURE`, and `BAS_ESCROW`, and logs the documented `DESIGNATED_WITHDRAWAL_ATTEMPT` message. | Review `packages/domain-policy/src/designated-accounts.ts` plus every caller to ensure the policy is always invoked, extend policy unit tests to cover each violation path, and verify alerts contain the metadata regulators expect. |
| Nightly reconciliation artefact | The nightly worker (`worker/src/jobs/designated-reconciliation.ts`) runs for all orgs, emits a `designated-reconciliation` evidence entry with SHA-256 hash, and records audit log entries for traceability. | Confirm the worker job writes the audit log entries, ensure `generateDesignatedAccountReconciliationArtifact` persists the hash/payload, and document how to retrieve the artefact from the evidence listing. |

Phase 1 completes once these audits/tests have produced measurable indicators that can be reviewed when rating each pillar 5/5.

## Phase 5: Governance & Validation

| Task | Description |
| --- | --- |
| Task 1 | Compliance checks now span logs, alerts, and artefacts: the worker logs (`designated-account-reconciliation:*`) are collected centrally; alert dashboards monitor `DESIGNATED_WITHDRAWAL_ATTEMPT` metadata; evidence endpoints log SHA-256 and metadata via `generateDesignatedAccountReconciliationArtifact`; and `scripts/verify-designated-reconciliation.mjs` runs nightly (or in CI) to ensure an artefact was generated within 24 hours. |
| Task 2 | Lessons per phase are documented above (provider cap guards, policy engine coverage, reconciliation artefact logging) so auditors can trace each pillar’s “5/5” evidence. Update this file whenever a new lesson arises, keeping the compliance story aligned with the living architecture. |
| Task 3 | Retrospectives are scheduled quarterly with compliance/ops/engineering stakeholders to review the logged metrics (cap warnings, alerts, reconciliation success/failure counts) and tune automation; add the retrospective cadence to your runbook or sprint ritual so these governance checkpoints stay on the calendar. |

Phase 5 is now codified in `docs/runbooks/designated-accounts-governance.md`, which ties together the nightly worker logs, the governance channel notifications, and the `scripts/verify-designated-reconciliation.mjs` job so you can show auditors that each artefact is created, verified, and documented. Keep the runbook linked from this file so regulators know where to look when they request evidence.

Runbooks should link to this file plus `scripts/verify-designated-reconciliation.mjs`, `.github/workflows/verify-designated-reconciliation.yml`, and the root `worker` logs, ensuring any new regulator or engineer knows where to confirm the pillars remain hardened.





============================================================
FILE: C:\src\apgms-final\docs\compliance\dsp-operational-framework.md
============================================================
# DSP Operational Framework Control Matrix

| Requirement | Control Summary | Evidence Source | Owner | Status |
| --- | --- | --- | --- | --- |
| MFA for privileged access | Enforce WebAuthn/TOTP in API gateway and admin portal | Phase 2 stories, auth configuration | Security | Planned |
| Security posture & incident response | Incident runbook (`runbooks/ndb.md`), audit logging, 24h notification commitment | Runbook updates, audit log pipeline | Security/Ops | Planned |
| Penetration testing | Annual API/application pen test with remediation tracking | Pen test report, ticket references | Security | Planned |
| Data residency (AU) | Deploy production infrastructure in AU regions; restrict data export | Infra IaC, environment configs | Ops | Planned |
| TFN protections | Masking library, vault secrets, TFN SOP (`docs/security/TFN-SOP.md`) | Code references, SOP | Privacy | In progress |
| Logging & evidence | Immutable audit log pipeline + nightly evidence job (`pnpm compliance:evidence`) | Evidence artifacts | Ops | Planned |
| Change management | Feature freeze policy, blue/green deploy documentation | Release checklist | Product/Ops | Planned |
| Support & SLAs | Pilot support playbook, status site updates (`status/README.md`) | Support SOP | Customer Success | Planned |



============================================================
FILE: C:\src\apgms-final\docs\compliance-and-patent-mapping.md
============================================================
# APGMS Compliance and Patent Mapping (Australia Only)

## 1. Scope and Positioning

The Automated PAYGW & GST Management System (APGMS) is an **Australia-only** platform
designed to:

- Secure PAYGW and GST liabilities in real time into **designated one-way accounts**.
- Support accurate and auditable **BAS lodgment**.
- Manage **shortfalls, payment plans and remissions** in line with ATO practice.
- Provide **regulator-grade views** for the Australian Taxation Office (ATO).

Current scope:

- Australian BAS only.
- Australian PAYGW and GST only (with clearly-defined extension points for PAYGI, FBT and
  company tax).
- Australian entities only; multi-jurisdiction logic is out of scope.

All tax logic, tests and integrations are aligned with **ATO legislation, practice
statements and DSP Operational Security Framework (DSP OSF)** expectations.

---

## 2. One-Way Designated Accounts

### Patent-Aligned Feature

- Dedicated **designated accounts** for PAYGW and GST.
- **Deposit-only** semantics enforced at the application layer.
- Lifecycle management from **activation through sunsetting and closure**.

### Implementation

- Domain model in `packages/domain-policy/src/designated-accounts`:
  - `DesignatedAccountType`, `DesignatedAccountLifecycle`,
    `DesignatedAccount` interface.
- Guard logic in `guards.ts`:
  - Rejects non-positive amounts.
  - Forbids movements on `PENDING_ACTIVATION` and `CLOSED` accounts.
  - For `SUNSETTING` accounts, permits deposits only.
  - For all one-way accounts, forbids withdrawals and internal transfers.
- Persistence via Prisma models (not shown in this doc) that tie accounts to:
  - An `Org` (entity).
  - A banking provider account identifier.

This delivers the â€œdesignated, one-way accountâ€ behaviour described in the patent
without relying on bank-side controls alone.

---

## 3. Real-Time PAYGW and GST Securing

### Patent-Aligned Feature

- Continuous securing of PAYGW and GST into designated accounts based on:
  - **STP / payroll events** for PAYGW.
  - **POS / transaction feeds** for GST.
- Final remittance occurs at **BAS lodgment**, not at the point of sale/payroll.

### Implementation

- PAYGW and GST obligations are persisted as AU-specific domain records tied to:
  - Payroll / STP feeds (PAYGW).
  - Transaction feeds and journal entries (GST).
- The AU tax engine in `packages/domain-policy/src/au-tax` is entirely
  **data-driven**:
  - `TaxParameterSet` and `TaxRateSchedule` tables define rate sets and brackets.
  - `PaygwEngine` resolves the active parameter set by jurisdiction, tax type and
    date, then applies brackets to calculate withholding.
  - A separate GST config maps financial years to a **single rate in basis points**.
- BAS cycle records capture:
  - Required vs secured PAYGW and GST for each BAS period.
  - JSON breakdowns that can be surfaced directly in regulator views.

No PAYGW, GST or HELP/STSL rates are hard-coded in the engine; they are
maintained in versioned configuration tables.

---

## 4. BAS Lodgment and Remittance

### Patent-Aligned Feature

- Correct and traceable lodgment of Australian BAS periods.
- Handling of **shortfalls** and **refund BAS** scenarios.

### Implementation

- A `BasCycle` state machine (domain-level) tracks:
  - Period status: `DRAFT` â†’ `READY` â†’ `LODGED` / `REFUND_DUE`.
  - Coverage ratios (secured vs required PAYGW and GST).
  - Shortfall detection when secured amounts undershoot obligations.
- Lodgment logic:
  - Uses only the AU configuration tables and engines for calculations.
  - Stores lodgment metadata and any ATO reference identifiers.
- Connectors (planned / stubbed):
  - Adapter for ATO BAS lodgment (e.g. via SBR).
  - Storage of ATO confirmations as evidence artefacts.

---

## 5. Shortfall Detection and Alerts

### Patent-Aligned Feature

- Early detection of likely BAS shortfalls.
- Monitoring and alerting for both the business and the regulator.

### Implementation

- Domain models for:
  - `Alert` and `MonitoringSnapshot` (e.g. â€œPAYGW shortfall projected for this BAS
    periodâ€, â€œDesignated account not funded for X daysâ€).
- Regulator routes (demo / stub level):
  - `/regulator/compliance/report`
  - `/regulator/alerts`
  - `/regulator/monitoring/snapshots`
- Outputs:
  - Per-org shortfall warnings.
  - Coverage ratios and basic risk bands.
  - Aggregated views that can be used for ATO portfolio-level analysis.

---

## 6. Payment Plans, Penalties and Evidence

### Patent-Aligned Feature

- Structured payment plans for BAS-related debts.
- GIC / penalty modelling and remission workflows.
- Rich, auditable evidence trails.

### Implementation

- Domain models:
  - `PaymentPlanSchedule` / `PaymentPlanInstalment` for structured arrangements.
  - `PenaltyEvent` and `RemissionRequest` for GIC/penalty activity.
  - `EvidenceArtifact` for:
    - Bank statements.
    - STP snapshots.
    - ATO account statements and notices.
- APIs:
  - `/payment-plans/*` for creating and updating plans.
  - `/regulator/evidence/*` for ATO-facing evidence views.
- The ledger component provides an immutable journal underpinning
  reconciliations between:
  - Source transactions.
  - Designated accounts.
  - ATO running balance accounts.

---

## 7. AU Tax Configuration Tables

### Patent-Aligned Feature

- Central, versioned Australian tax configuration.
- No hard-coded PAYGW, GST or other rates.

### Implementation

- Prisma models for:
  - `TaxParameterSet` (jurisdiction, tax type, financial year, validity window).
  - `TaxRateSchedule` (brackets for PAYGW, simple rate rows for GST).
- Repository implementation (`PrismaTaxConfigRepository`):
  - Resolves the active parameter set per `(jurisdiction, taxType, date)`.
  - Shapes rows into typed AU config objects (`PaygwConfig`, `GstConfig`).
  - Performs a soft check for overlapping parameter windows (enforced properly by
    migrations and the rule-update worker).
- A rule-update worker (planned / stubbed):
  - Upserts new parameter sets.
  - Validates non-overlapping windows per tax type.
  - Logs changes for audit.

---

## 8. Regulator Views, Risk Scoring and Projections

### Patent-Aligned Feature

- Regulator-level views of risk and projected impact on collectable debt.

### Implementation

- Regulator domain module computes:
  - Per-organisation compliance summaries and risk scores.
  - Simple portfolio-level projections of collectable-debt reduction under
    different APGMS adoption scenarios.
- Routes:
  - `/regulator/compliance/report`
  - `/regulator/simulations/debt-reduction` (planned/demo).

---

## 9. Security and Privacy (ATO / DSP OSF Context)

APGMS is being built as a **DSP-grade product**, not a generic app:

- HTTP security:
  - Fastify with `@fastify/helmet`:
    - CSP with `default-src 'self'`.
    - HSTS (production only).
    - Referrer-Policy, X-Content-Type-Options, X-Frame-Options, etc.
  - Centralised security header configuration in the API gateway.
- Data protection:
  - AES-256-GCM envelope encryption for PII and banking identifiers.
  - Key management via environment/KMS-backed providers.
- Logging and observability:
  - Structured logging with redaction of TFNs, ABNs, BSBs, account numbers and
    authorisation headers.
  - Audit logs for all mutating actions.
- DSP OSF alignment:
  - Strong authentication and authorisation layers.
  - Isolation of production environments and secrets.
  - Support for regulator-only access paths and views.

---

## 10. Extensibility and Limits

The system is **deliberately constrained** to the Australian regime:

- All tax logic and configuration are AU-only and linked to ATO rules.
- Future extensions (PAYGI, FBT, company tax) remain AU-centric.
- No cross-jurisdiction or multi-regime logic is in scope for this codebase.

This narrow scope makes the compliance story clearer for both patent purposes
and ATO DSP OSF assessment.



============================================================
FILE: C:\src\apgms-final\docs\dsp-osf\evidence-index.md
============================================================
# DSP OSF evidence index



============================================================
FILE: C:\src\apgms-final\docs\ip\guardrails.md
============================================================
# IP guardrails



============================================================
FILE: C:\src\apgms-final\docs\launch\pricing-page-draft.md
============================================================
# Pricing copy



============================================================
FILE: C:\src\apgms-final\docs\legal\Privacy-Policy-draft.md
============================================================
# Privacy Policy draft



============================================================
FILE: C:\src\apgms-final\docs\legal\ToS-draft.md
============================================================
# Terms of Service draft



============================================================
FILE: C:\src\apgms-final\docs\ops\alerts.md
============================================================
# Alerting Guide

## Alertmanager Routing
- Fast burn alert (vailability_fast_burn) pages Platform Ops via PagerDuty.
- Slow burn alert (vailability_slow_burn) notifies Slack channel #ops.
- security_events_total{event="anomaly.auth"} > 0 for 5m sends alert to Security Engineering.

## Testing Alerts
1. Trigger readiness failure by pointing DATABASE_URL to an invalid host; confirm 
eadiness.fail metric increments and Alertmanager fires.
2. Run promtool test rules with ops/promql.rules.yml (to be added) before deploying new rules.

## Runbooks
- Follow API Gateway Operations Runbook for resolution steps.
- Document alert IDs, timestamps, and remediation in status/README.md.



============================================================
FILE: C:\src\apgms-final\docs\ops\chaos.md
============================================================
# Chaos Testing Playbook

## Scope
- Simulate database outages, elevated latency, and Redis/KMS failures against the API gateway.
- Validate readiness endpoints, k6 smoke, and alerting respond within defined SLOs.

## Prerequisites
- Local environment or staging cluster with observability stack.
- `pnpm k6:smoke` and compliance scripts available.

## Experiments
1. **Database interruption**
   - Stop Postgres container or revoke network access for 5 minutes.
   - Expected: `/ready` returns 503, anomaly events logged, CI smoke fails.
   - Recovery: restore DB, rerun `pnpm k6:smoke`.
2. **Latency injection**
   - Use `toxiproxy` or `tc` to add 300ms latency on DB transport.
   - Monitor `http_request_duration_seconds` p95; alert should cross 500ms.
   - Remove latency after 10 minutes and confirm metrics recover.
3. **KMS key rotation during load**
   - Run `pnpm security:rotate-keys` (dry run) to simulate new keys, then deploy.
   - Ensure decrypt/export endpoints continue to succeed.

## Reporting
- Document results under `status/incidents/<yyyy-mm-dd>-chaos.md`.
- Attach compliance evidence (`pnpm compliance:evidence --tag chaos-<date>`).
- File tickets for any SLO violations or missing alerts.



============================================================
FILE: C:\src\apgms-final\docs\ops\dashboards.md
============================================================
# Dashboards

## Prometheus/Grafana Panels
- **Request volume**: Chart `sum by (route) (rate(apgms_api_requests_total[5m]))` to spot traffic spikes per Fastify route.
- **Error ratio**: Single-stat on `sum(rate(apgms_api_requests_total{status=~"5.."}[5m])) / sum(rate(apgms_api_requests_total[5m]))`.
- **Readiness failures**: Alert on `sum_over_time((probe_success == 0)[15m])` or scrape gaps. Pair with `/ready` probe in blackbox exporter.
- **Auth anomalies**: Track `sum(rate(apgms_api_requests_total{route="/alerts/:id/resolve",status="401"}[5m]))` to catch repeated MFA denials.

Store exported dashboards in `artifacts/dashboards/` for versioned sharing.



============================================================
FILE: C:\src\apgms-final\docs\ops\load-testing.md
============================================================
# Load & Monitoring Validation

Use the existing Prometheus metrics plus targeted synthetic traffic to verify that the APGMS observability pipeline holds under real work loads (BAS lodgment â†’ transfer â†’ ATO reporting â†’ monitoring).

1. **Install dependencies**

   ```bash
   pnpm install --frozen-lockfile
   pnpm exec playwright install --with-deps  # already invoked by CI
   pnpm exec k6 version
   ```

2. **Run the k6 smoke/load scenario**

   Use the existing `k6/smoke.js` and extend it as needed:

   ```bash
   pnpm k6:smoke --env BASE_URL=http://localhost:3000
   ```

   For more targeted validation, create a supplemental script (e.g., `k6/load.js`) that hits the new BAS/transfer/ATO/monitoring endpoints once you have a working auth token and MFA code (see `BAS_MFA_CODE` env). The script can batch:

   * Authenticated POSTs to `/bas/lodgment` and `/bas/transfer`.
   * POST `/ato/report` with real compliance payloads.
   * GET `/monitor/compliance` and `/monitor/risk` to verify snapshots.

   Keep the header/auth handling consistent with the fastify guards; use the same bearer token as your integration tests.

3. **Observe metrics**

   Use `http://localhost:3000/metrics` to ensure counters increment (`apgms_bas_lodgments_total`, `apgms_transfer_instruction_total`, `apgms_ato_reports_total`, `apgms_risk_events_total`). Build Grafana panels:

   * BAS lodgment success rate gauge (`apgms_bas_lodgments_total{status="success"}` vs `status="failed"`).
   * Transfer queue/dequeue trend (`apgms_transfer_instructions_total`, `apgms_transfer_execution_total`).
   * Payment-plan spike alert (`apgms_payment_plan_requests_total` > 0 within 1h).
   * Risk burst alert on `apgms_risk_events_total{severity="high"}`.

4. **Alert thresholds**

   Configure alerts (Prometheus rules or Grafana) for:

   * High anomaly score (`apgms_integration_anomaly_score{severity="high"}`) sustained > 5m.
   * BAS lodgment failures > 5%; use `apgms_bas_lodgments_total` rate.
   * Transfer instructions pending > 3 without send events.

5. **Document results**

  Capture the run output/metrics screenshot in `artifacts/monitoring/<timestamp>/` and link it from the release ticket.

6. **Automate compliance snapshot evidence**

   Run `node scripts/collect-monitoring-evidence.mjs` (requires `APGMS_MONITORING_TOKEN` pointing to a valid test session); it hits `/monitor/compliance` and `/monitor/risk` to capture JSON snapshots under `artifacts/monitoring/<timestamp>/`. Attach those files to the release artefact alongside the k6 output.



============================================================
FILE: C:\src\apgms-final\docs\ops\logging.md
============================================================
# Logging Standard

## Format
- JSON logs emitted by Fastify/Pino. Each entry includes `level`, `time`, `msg`, and `reqId` (Fastify request identifier).
- Request hooks attach x-request-id header with the same ID for end-to-end correlation (services/api-gateway/src/app.ts:204).
- Audit and security events append contextual objects (orgId, actorId, mode) for searchability (services/api-gateway/src/app.ts:268).

## Levels
- info: normal lifecycle messages (api-gateway listening, audit successes).
- warn: anomalies like repeated auth failures, readiness flaps.
- error: failed shutdown, unhandled exceptions, audit persistence failures.

## Context
- Request scoped log fields: 
eqId, method, url, statusCode.
- Domain fields: orgId, principal, action for audit logs.
- Security events use security_event structure in services/api-gateway/src/routes/admin.data.ts:74.

## Correlation
- Clients should propagate the x-request-id header; gateway reuses existing value when present (future work) or generates one via Fastify.
- Tracing spans emit OpenTelemetry trace_id and span_id enabling distributed tracing integration.

## Retention & Shipping
- Logs are structured and ready for shipping to ELK/Datadog/Splunk.
- Ensure downstream log pipeline preserves JSON (no line wrapping).

## Validation
- Run local requests and verify logs contain 
eqId and JSON structure: pnpm --filter @apgms/api-gateway dev followed by curl http://localhost:3000/health.
- Security events can be located via security_event key in logs.


















============================================================
FILE: C:\src\apgms-final\docs\ops\promql.md
============================================================
# PromQL Alerts & Dashboards

## Availability Burn Rate
- Fast burn (1h):
  `
  sum(rate(apgms_api_requests_total{status=~"5.."}[5m]))
    / sum(rate(apgms_api_requests_total[5m]))
  > 0.02
  `
- Slow burn (6h): same query with [30m] window and threshold 0.05.

## Latency
- P95 latency (requires histogram instrumentation â€“ TODO):
  `
  histogram_quantile(
    0.95,
    sum(rate(http_request_duration_seconds_bucket[5m])) by (le, route)
  ) // placeholder until Fastify histogram is wired
  `

## Auth anomaly
- Detect repeated auth failures via counter derivative:
  `
  sum(rate(apgms_api_requests_total{route="/alerts/:id/resolve",status="401"}[5m])) > 0
  `

## Notebooks
- Record queries in Grafana or Prometheus UI and store screenshots in docs/ops/dashboards/.



============================================================
FILE: C:\src\apgms-final\docs\ops\regulator-portal.md
============================================================
# Regulator Portal Operations

## Purpose
- Read-only surface for Treasury / ATO sandbox reviewers.
- Authenticated via short-lived access code, issues dedicated JWT audience (`REGULATOR_JWT_AUDIENCE`).
- All requests recorded via `recordAuditLog` with action prefix `regulator.*` and chained hashes.

## Login Flow
1. POST `/regulator/login` with `{ accessCode, orgId }`.
2. Access code lives in `REGULATOR_ACCESS_CODE` secret; rotate via secret manager and restart gateway.
3. Successful login issues JWT + session token stored in `RegulatorSession` table with TTL (`REGULATOR_SESSION_TTL_MINUTES`).
4. Session guard (`createAuthGuard`) checks expiry on every `/regulator/*` hit; expired sessions return 401.

## Portal Pages (webapp)
- **Overview**: Calls `/regulator/compliance/report`, `/regulator/alerts`, `/regulator/monitoring/snapshots`, `/regulator/bank-lines/summary`.
- **Evidence Library**: GET `/regulator/evidence` (list) + `/regulator/evidence/:id` (detail). UI can re-hash payload client-side to prove tamper-evidence.
- **Monitoring**: Lists recent snapshots (`/regulator/monitoring/snapshots`) and renders raw payload JSON for export.

## Connectors automation
- Use `/connectors/capture/payroll` or `/connectors/capture/pos` to inject PAYGW/GST captures for an org while authenticated as an admin; include `{ orgId, amount }` in the body.
- Connectors responses include the transfer metadata plus the reconciliation artifact (`artifactId`, `sha256`, `summary`) that the regulator evidence endpoints surface.
- These endpoints exercise the designated-account policy, generate alerts if policy violations occur, and feed the regulator portal so `compliance/report` reflects the most recent totals.

## Health & Monitoring
- `/regulator/health` is a dedicated probe target (mirrors `/health` but tagged for regulator metrics).
- Metrics captured through default Prometheus handler with `route="/regulator/..."` labels; add Grafana panel filtered by that prefix to watch regulator usage separately.
- Scheduled smoke (`pnpm smoke:regulator`) hits login + critical read endpoints; wire into nightly job or on-demand when rotating credentials.

## Audit & Evidence
- Each regulator action writes to `auditLog` table with hash chaining (`hash` + `prevHash` columns).
- Evidence payloads stored in `EvidenceArtifact.payload` (JSON) and `wormUri` (immutable store reference). SHA-256 digest persisted for external verification.
- For regulator exports, instruct reviewers to download from Evidence Library UI or hit `/regulator/evidence/:id` via script.

## Troubleshooting
- **401 on portal**: verify access code rotation, session TTL, and `REGULATOR_JWT_AUDIENCE` match between API + webapp env.
- **Hash mismatch**: confirm payload JSON matches the stored artifact (no whitespace trimming), recompute via `node -e "console.log(crypto.createHash('sha256').update(JSON.stringify(payload)).digest('hex'))"`.
- **Missing snapshots**: run `pnpm compliance:evidence` or trigger `createMonitoringSnapshot` via `/compliance/evidence` generation to seed new entries.

## Change Control
- Any update that touches `/regulator/*` endpoints requires audit note in change request.
- Document new artifacts or schema changes in `docs/ops/runbook.md` and update `scripts/regulator-smoke.mjs` accordingly.



============================================================
FILE: C:\src\apgms-final\docs\ops\runbook.md
============================================================
# API Gateway Operations Runbook

## Service Overview
- Fastify-based HTTP gateway exposing authenticated APIs.
- Dependencies: Postgres (DATABASE_URL), Redis (if configured), PII KMS providers.

## Start/Stop Procedures
- **Start**: pnpm --filter @apgms/api-gateway dev
- **Graceful shutdown**: send SIGTERM/SIGINT; handler drains and calls fastify.close() (services/api-gateway/src/index.ts).
- Verify shutdown by checking logs api-gateway shut down cleanly.

## Health & Readiness
- GET /health returns { ok: true } - liveness only.
- GET /ready performs DB connectivity check; returns 503 on failure.
- GET /regulator/health exposes the read-only portal health (same process, but logged separately for regulator traffic probes).

## Logs & Correlation
- Structured logs emitted with JSON, request IDs attached in Fastify hooks (services/api-gateway/src/app.ts).
- Security events & audit trails log under security_event and audit_failed.
- Search by x-request-id header.

## Metrics
- Prometheus endpoint at `/metrics` exposes `apgms_api_requests_total{method,route,status}` plus the default `prom-client` process/runtime gauges.
- Alert on unexpected growth in `apgms_api_requests_total{status="5xx"}` or missing scrapes.
- Check anomaly counter `apgms_api_requests_total{route="/alerts/:id/resolve",status="401"}` for MFA denials and repeated auth failures.

## Alerts & SLOs
- Targets: 99.5% availability, p95 latency < 500ms on /bank-lines.
- Burn-rate alerts: fast (1h) & slow (6h) availability SLO breaches (see `docs/ops/promql.md`).
- Alert triggers on readiness flaps (>=3 failures/5m) and anomaly auth events.
- Monitor `security_events_total{event="anomaly.auth"}` and audit failures.

## Incident Response
1. Confirm scope from /metrics and logs.
2. If DB connectivity is failing, run pnpm --filter @apgms/shared exec prisma migrate status and verify credentials.
3. For repeated auth failures, rotate credentials and review audit logs (AuditLog table).
4. Escalate via on-call Slack/PagerDuty channel.

## Post-Incident
- Record incident in status/README.md with timeline and resolution.
- File follow-up tasks to improve automation or documentation.
- Capture command evidence with `pnpm compliance:evidence --tag <incident-id>` and archive the output in `artifacts/compliance/`.
- Populate `status/incidents/<incident-id>.md` using the template provided to keep public status in sync.
- Run `pnpm backup:evidence-pack -- --base-url http://localhost:3000 --org <org> --token <jwt>` against the affected environment to snapshot export/compliance JSON.
- Run applicable chaos experiment from `docs/ops/chaos.md` after remediation to validate fixes.

## Contact
- Primary: Platform Ops (ops@apgms.example)
- Secondary: Security Engineering (security@apgms.example)

## Smoke Test Checklist
- [ ] `pnpm --filter @apgms/api-gateway dev` boots, logs listening message.
- [ ] `curl http://localhost:3000/ready` returns 200 under normal conditions.
- [ ] `curl http://localhost:3000/regulator/health` returns 200 to prove regulator portal guard rails are active.
- [ ] Kill process with CTRL+C and confirm graceful shutdown log.
- [ ] Bring DB down, `/ready` returns 503.
- [ ] curl http://localhost:3000/metrics outputs Prometheus counters.
- [ ] pnpm k6:smoke -- --env BASE_URL=http://localhost:3000 passes (requires k6).
- [ ] Generate an evidence pack with `curl -X POST -H "Authorization: Bearer $TOKEN" http://localhost:3000/compliance/evidence` and confirm it appears in `/compliance/evidence`.
- [ ] `pnpm smoke:regulator` logs in with the regulator access code and exercises `/regulator/*` endpoints end-to-end.


See `docs/ops/logging.md` for structured logging guidance.





## Incident Drills
- Quarterly incident rehearsal covering DB outage, auth anomaly, and deployment rollback.
- Record outcomes in `status/README.md` with follow-up tasks.


See docs/ops/alerts.md for alert routing and testing details.



============================================================
FILE: C:\src\apgms-final\docs\ops\slo.md
============================================================
# Service Level Objectives

## Availability
- **SLO**: 99.5% monthly availability for the API gateway.
- **Metric**: (1 - sum(rate(http_requests_total{status!~"5.."}[5m])) / sum(rate(http_requests_total[5m])))
- **Alert**: Fast burn (>2% error budget burn in 1 hour), slow burn (>5% in 6 hours).

## Latency
- **SLO**: p95 latency = 500ms and p99 = 1s on /bank-lines, /users.
- **Metric**: Prometheus histogram http_request_duration_seconds_bucket (to be instrumented in Phase 3) or fallback log-based percentiles.
- **Alert**: Trigger when p95 > 500ms for 10 minutes.

## Error Budget
- 0.5% monthly downtime = ~3.65 hours; track remaining budget in Grafana dashboard.

## Observability Links
- Prometheus queries defined in ops/slo/promql.md (to be created).
- Grafana dashboard API Gateway SLO displays availability, latency, anomaly counts.

## Review Cadence
- Monthly SLO review; escalate breaches to Platform Ops + Security.

## Alert Implementation
- See `docs/ops/promql.md` for PromQL queries. Configure Alertmanager to route fast/slow burn alerts to on-call distribution.
- Mirror anomaly alerts (`security_events_total{event="anomaly.auth"}`) to Security team.



============================================================
FILE: C:\src\apgms-final\docs\partners\bank-packet.md
============================================================
# Bank partner packet



============================================================
FILE: C:\src\apgms-final\docs\privacy.md
============================================================
# APP 12/13 Request Handling

This document outlines how Birchal satisfies Australian Privacy Principles (APP) 12 and 13 covering access to, and correction of, personal information.

## Overview
- **APP 12** gives individuals the right to access personal information we hold about them.
- **APP 13** requires us to correct personal information to ensure it is accurate, up-to-date, and complete.
- All requests are tracked in the Privacy ServiceDesk queue with the label `app-12-13`.

## Intake process
1. Requests may arrive via support@birchal.com, the privacy webform, or regulator correspondence.
2. Support triages within one business day and escalates to the Privacy Officer.
3. The Privacy Officer logs the request with: requester name, contact details, relationship to Birchal, verification status, and due date.

## Identity verification
- For customers, request confirmation from the registered email or phone on file.
- For authorised representatives, obtain a signed authority letter less than 12 months old.
- Log verification steps in the request ticket. If identity cannot be verified, respond with refusal citing APP 12.3.

## Locating information
1. Query the data inventory for systems tagged with the requester's organisation ID.
2. Run `/admin/export/:orgId` in the API Gateway (with an approved admin token) to gather structured exports.
3. Collect additional artefacts: audit logs, support transcripts, manual files stored in Google Drive.
4. Store copies in the encrypted privacy evidence folder with restricted permissions.

## Responding to access requests (APP 12)
- Default timeframe: 30 calendar days.
- Provide a summary report including:
  - Data sources accessed.
  - Categories of personal information (contact details, transaction history, audit events).
  - Any redactions and the reason for withholding (e.g. another individual's privacy).
- Use the customer notification template in `runbooks/ndb.md` if the request stems from a breach incident.
- Deliver securely via the customer portal or encrypted email (password shared via phone).

## Responding to correction requests (APP 13)
1. Validate the requested changes and supporting evidence.
2. Update authoritative systems (CRM, registry, billing) and log the fields changed.
3. Issue a confirmation email detailing the updates made.
4. If refusing to correct, provide written reasons, available complaint mechanisms, and contact information for the OAIC.

## Escalation and reporting
- Notify the Chief Privacy Officer if the request relates to more than 100 individuals or involves regulator oversight.
- Breach the timeframe? file an incident and inform the requester of the delay and revised completion date.
- Quarterly metrics: number of APP 12 requests, response time distribution, number of corrections, and refusals with reasons.

## Record keeping
- Retain all correspondence, exports, and correction evidence for seven years.
- Store final responses in the Privacy ServiceDesk ticket and tag with `closed-app-12-13`.
- Update this procedure annually or after any significant regulatory change.



============================================================
FILE: C:\src\apgms-final\docs\privacy\dpia.md
============================================================
# Data Protection Impact Assessment

## Overview
- **Processing**: APGMS ingests organisation metadata, admin user accounts, and ciphertext summaries of bank-line movements. Plaintext conversion is performed by clients; the API stores only the encrypted fields that are supplied.
- **Lawful basis**: Customer contracts plus TFN handling consent; audit logging captures minimal metadata for compliance evidence.

## Data Inventory & Flow
- User credentials are hashed with bcrypt via `verifyCredentials` before comparison and are never stored or logged in plaintext (`services/api-gateway/src/auth.ts`).
- `/bank-lines` accepts ciphertext for payee/description fields and persists them verbatim; only redacted metadata is returned to callers (`services/api-gateway/src/routes/bank-lines.ts`).
- Auth and regulator actions append entries through `recordAuditLog`, providing actor, action, and timestamps in the shared Prisma schema (`services/api-gateway/src/lib/audit.ts`, `shared/prisma/schema.prisma`).

## Risk Assessment
- **Unauthorised access**: Fastify `authGuard` enforces HS256 JWTs with issuer/audience validation and populates `request.user`, while `assertOrgAccess` and `assertRoleForBankLines` ensure requests stay within the caller's org and role (`services/api-gateway/src/auth.ts`, `services/api-gateway/src/utils/orgScope.ts`).
- **Data leakage**: Bank-line responses intentionally drop ciphertext fields, but the admin data route is an in-memory stub and will lose context across restarts; sensitive exports are therefore not yet supported and are flagged as a compliance gap.
- **Key compromise**: Encryption keys, redis/nats URLs, and JWT secrets are validated through the config loader which enforces encoding, length, and URL constraints before boot succeeds (`services/api-gateway/src/config.ts`).

## Controls & Monitoring
- Helmet CSP, deny-by-default CORS, and rate limiting are installed on every request path in `buildServer`.
- `/bank-lines` enforces idempotency keys (`orgId_idempotencyKey` constraint) and emits `idempotent-replay` headers to simplify replay detection.
- `/metrics` exposes the actual Prometheus counters and histograms available today: `apgms_http_requests_total`, `apgms_http_request_duration_seconds`, `apgms_db_query_duration_seconds`, `apgms_db_queries_total`, and `apgms_job_duration_seconds` (`services/api-gateway/src/observability/metrics.ts`).
- Health/readiness endpoints run direct Postgres/Redis/NATS checks before advertising readiness so resiliency tooling can gate deployments.

## Residual Risk & Actions
- The admin deletion/export workflows described in older guidance are not implemented; all such requests must go through manual support until a durable route is delivered (tracked in the compliance backlog).
- Regulator evidence routes beyond authentication are still TODO. DPIA reviewers should verify the backlog before closing audits.
- Re-review this DPIA whenever new data categories are introduced or after significant auth/ledger changes.



============================================================
FILE: C:\src\apgms-final\docs\risk\register.md
============================================================
# Risk Register

| ID | Risk Statement | Impact | Mitigation | Owner | Status |
| --- | --- | --- | --- | --- | --- |
| R-001 | Synthetic demo data leaks into production tenants | High | Isolate simulation tenants, prefix synthetic metrics, purge data on disable | Engineering Lead | Open |
| R-002 | Bank API outage during BAS window delays remittance | High | Queue retries, readiness pre-checks, manual override runbook | Ops Lead | Open |
| R-003 | Tax tables drift from ATO published rates | Medium | Automate rate ingestion, add regression tests, monthly SME review | Tax SME | Open |
| R-004 | DSP admin account compromise | High | Enforce MFA, anomaly detection, credential rotation, session revocation tooling | Security Lead | Planned |
| R-005 | TFN storage breaches Privacy/TFN Rule obligations | Medium | Vault-managed secrets, periodic audits, masking enforcement | Privacy Officer | Planned |



============================================================
FILE: C:\src\apgms-final\docs\runbooks\admin-controls.md
============================================================
# Admin Controls Runbook

## Purpose
Record every administrator mutation (delete/export) with a correlated, redacted audit trail so you can prove TFN/PII controls to regulators.

## Logging & correlation
- The gateway uses `@apgms/shared/security-log` to build `SecurityLogEntry` objects when `secLog` is called in `services/api-gateway/src/routes/admin.data.js`.
- Each log entry includes `event`, `orgId`, `principal`, the `subjectUserId`/`subjectEmail`, and the new `occurredAt` timestamp.  It also records whichever correlation ID accompanies the inbound HTTP request: `x-correlation-id` first, falling back to Fastifyâ€™s `request.id`.
- The default `secLog` implementation writes the sanitized entry via `logSecurityEvent(app.log, entry)`, so you can filter `security_event` log lines by `security.event` and correlation ID before showing them to auditors.

## Auditing & redaction
- In addition to the log entry, each admin action creates an `AuditLog` row via `logAuditEvent` that stores hashed metadata (e.g., subject IDs/emails). Use the linked hash chain (`recordAuditLog`) to prove tamper resistance.
- To investigate requests, arm your SIEM with a dashboard that joins `security_event` entries with their `correlationId` and the matching audit log `hash`. The runbookâ€™s `Designated Accounts Governance` file links to the nightly reconciliation artefact; this file now links back so regulators can trace from audit log â†’ security log â†’ evidence artefact.

## Operations
1. When troubleshooting an admin delete/export, capture the `x-correlation-id` header (or Fastify `req.id`) and query the centralized logs for `1 security_event` entries with that ID.
2. Confirm `security.event` log entries show sanitized values (no raw TFNs) by checking they pass through `shared/src/redaction.ts` and `shared/src/logging.ts`.
3. Verify a matching row in `AuditLog` exists with the same `orgId` and `action` (e.g., `data_delete` or `data_export`), then note the `hash` value so auditors can confirm chain integrity.
4. If a log entry lacks `correlationId`, ensure the client now sends `x-correlation-id` or fix the Fastify middleware to inject new IDs before hitting the admin routes; the default helper already falls back to `request.id`.

## Review
- Include this runbook in quarterly compliance reviews alongside the `designated accounts governance` runbook so executives can see that both admin and automated processes are fully traceable.



============================================================
FILE: C:\src\apgms-final\docs\runbooks\compliance-monitoring.md
============================================================
# Compliance Monitoring and Dashboard Runbook

This runbook notes the safeguards that surround the designated one-way accounts, the payroll/POS ingestion paths, and the alerting/penalty flows that support the APGMS vision.

## Data Ingestion & Reconciliation
- The ingestion helpers (`shared/src/ledger/ingest.ts`) capture payroll contributions and POS transactions into the `PayrollContribution` and `PosTransaction` tables. They rely on the shared idempotency guard so duplicate submissions (from retries or manual overrides) cannot be replayed.
- The nightly `worker/src/jobs/designated-reconciliation.ts` job applies pending contributions to the `PAYGW_BUFFER` and `GST_BUFFER` ledgers before BAS lodgment, then validates the balances against the latest `BasCycle` obligations through `ensureDesignatedAccountCoverage`. If the buffers do not cover the required funds, the job raises a `DESIGNATED_FUNDS_SHORTFALL` alert and does not proceed with the transfer artefact until the discrepancy is resolved.

## Alert/Ticket Handling
1. When the shortfall alert appears, check the dashboard for missing contributions and reconcile the relevant payroll or POS ingestion records. Investigate whether the business replayed the same data, missed a payroll run, or forwarded incomplete POS batches.
2. If data is missing, re-ingest the batch via the ingestion helpers, ensure the contributions appear in the ledger tables, and rerun the reconciliation worker so the contributions are applied before BAS lodgment.
3. If the business is still short, log the shortfall in the dashboard, notify Finance/Tax Ops of the potential penalty or interest, and open a remediation ticket in the incident tracker so ATO-facing teams can surface the issue to the customer.

## Penalty & Remission Workflow
- The dashboard exposes recent penalties/interest notices that can accrue when BAS lodgments fail to fire. For large shortfalls, document the timeline, evidence of calculation corrections, and any communications with the business in the audit log.
- Once the business provides proof of compliance/proactive remediation, update the dashboard status to `remission_requested` and attach study evidence (contributions logs, updated `DesignatedTransfer` entries, alerts resolved). This metadata is used to support penalty remission requests or payment-plan negotiations.
- After the ATO approves a remission, update the dashboard entry to `remission_verified`, include the official reference number, and note any follow-up reminders (e.g., verifying the next BAS posted the funds on time).

## Dashboard Signals
- Surface the following cards on the compliance dashboard:
  * Pending contributions (count per org, last ingestion timestamp, ingestion source). Use `/compliance/status` and `/compliance/pending` to populate these views.
  * Alerts (shortfall and violation IDs, severity, outstanding actions) pulled from the `DESIGNATED_FUNDS_SHORTFALL` alerts recorded by `ensureDesignatedAccountCoverage`.
  * Penalties/Remissions (status, documentation links, next expected BAS).
  * Payment-plan discussions (current status, ratio of outstanding obligations to buffer balance).
- Link each card to the relevant audit log entries produced by the enforced `applyDesignatedAccountTransfer`/`logSecurityEvent` pipeline so you can arm security/compliance teams with evidence during reviews.

## Phase 1 Callouts
- The compliance monitor API exposes `/ingest/payroll`, `/ingest/pos`, `/compliance/precheck`, `/compliance/pending`, and `/compliance/status`. Use these endpoints to feed payroll/POS webhooks (include Idempotency-Key headers), validate balances before BAS lodgment, and surface pending contributions plus remediation hints.
- The `configureBankingAdapter` hook in `shared/src/ledger/designated-account.ts` lets you swap in a sandbox ADI/banking partner adapter later. For now the Prisma adapter reports deposit-only balances and logs shortfalls; document when you replace it with a real banking integration (include adapter name, endpoint, and required certificates in `status/` or `artifacts/compliance/`).

## Phase 2 Readiness
- The BAS precheck route (`/compliance/precheck`) now compares buffers with the current `BasCycle` and rejects transfers with shortfall alerts (response `status: shortfall`). Use the responseâ€™s `pendingContributions` and `remediation` guidance before retrying. When the alert is resolved, mark it through `/compliance/alerts/:id/resolve` and include the resolution proof inside `artifacts/compliance/`.
- `/compliance/reminders` surfaces upcoming BAS cycles (due in days, status), so operations teams can schedule reminders and understand whether a payment plan is already in place. Cite these endpoints when discussing remedial notifications in your compliance dashboard.
- Document your ATO DSP application timeline, OSF questionnaire status, product IDs, and any AUSTRAC/ASIC/AFSL discussions on `docs/runbooks/admin-controls.md` (or a dedicated status file) so referees can see evidence of regulatory preparation. Keep scanned copies in `artifacts/compliance/` alongside the alert/remediation records for audit verifiers.

## Regulatory Path & DSP Readiness
- Track the ATO DSP application (OSF questionnaire, product registration, STP/BAS entitlement) in parallel with this code work. Log the submitted product ID, scope of services, and the readiness checklist inside this runbook so audits can see the progress. Document whether you plan to act as a software-only adviser (no fund movement) or to layer onto a licensed banking partner or restricted ADI.
- Before any real fund movement: confirm whether AFSL/ADI/ASIC/AUSTRAC registration is required, engage legal counsel, and note the chosen path in the repository with the key dates/status. Maintain an evidence folder (`artifacts/compliance/`) that captures the OSF questionnaire export plus any banking partner contracts so you can prove compliance during reviews.

-## Phase 3 Partnering & Pilots
- Swap in a sandboxed ADI/banking adapter by setting `DESIGNATED_BANKING_URL`/`DESIGNATED_BANKING_TOKEN` (or call `configureBankingAdapter`) so the compliance ledger queries a sandbox endpoint. Record the partner API spec, certificate fingerprint, and contract in `artifacts/compliance/`.
- Capture the ATO DSP Product ID, OSF questionnaire reference, STP/BAS entitlement, and any AUSTRAC/ASIC/AFSL updates in `docs/runbooks/admin-controls.md` and the compliance dashboard so auditors can confirm your regulatory posture.
- Run pilots for at least two orgs (real or virtual): ingest payroll/POS batches through `/ingest/*`, perform `/compliance/precheck`, execute `/compliance/transfer`, and track alerts/resolutions via `/compliance/status` and `/compliance/reminders`. Log the pilot outputs (payloads, transfer receipts, reminder states) in `artifacts/compliance/` to demonstrate the entire ingest -> ledger -> precheck -> transfer -> alert loop.

## Phase 4 Innovation Stretch
- Use `/compliance/status`â€™s new `forecast` payload and `tierStatus` (reserve/automate/escalate) to show â€œvirtual balancesâ€ vs. forecasted obligations inside the compliance dashboard. Tie those metrics into alerts to warn operations when tier escalates to `escalate` before BAS lodgment.
- Start a lightweight prediction job (`forecastObligations`, `computeTierStatus` in `shared/src/ledger/predictive.ts`) to recompute obligations ahead of each BAS cycle. Feed the forecast into future alerts and call out the tier name on reminders/pending endpoints so you can surface unusual shortfalls and respond before deadlines.
- Keep linking each predictive alert to audit evidence in `artifacts/compliance/`; note how ML/tiered signals are tuned (even if heuristics) so future reviewers can evolve this into a true ML signal if you choose later.
- Schedule `/compliance/tier-check` as a cron job (or webhook) so the system recalculates forecasts/tier statuses regularly. When a tier flips to `escalate`, the route now creates a `TIER_ESCALATION` alert, writes the tier state, and logs it as a security event; store the resulting `artifacts/compliance/tier-state/<org>.json` plus the alert JSON as onboarding evidence for the ATO IR. Customize the cron frequency to match BAS cycles (e.g., daily or 6h) and add the command `curl -X POST http://localhost:3000/compliance/tier-check` to your scheduler notes.



============================================================
FILE: C:\src\apgms-final\docs\runbooks\designated-accounts-governance.md
============================================================
# Designated Accounts Governance Runbook

## Purpose
Keep the designated accounts controls at a "5/5" confidence level by exercising automated checks, manual reviews, and stakeholder retrospectives across the three pillars.

## Checks
1. **Provider abstraction** â€“ Verify `providers/banking/base.ts` logs `banking-provider: credit attempt` and `banking-provider: credit approaching cap` events; raise an alert if a provider exceeds 90% of `maxWriteCents` more than once per hour.
2. **Policy engine** â€“ Search the audit timeline for `DESIGNATED_WITHDRAWAL_ATTEMPT` alerts with metadata (orgId, violation) and ensure each entry contains the message â€œDesignated accounts are deposit-only; debits are prohibitedâ€.
3. **Reconciliation artefact** â€“ Run `pnpm --filter worker exec node scripts/verify-designated-reconciliation.mjs` nightly (or via CI) to confirm a `designated-reconciliation` artefact exists in the last 24 hours; the script outputs the latest `artifactId` and SHA-256 for auditors.

## Runbook Steps
1. Launch the nightly worker via Docker Compose: `docker compose up worker` (after running `docker compose build --no-cache worker` when dependencies change). Watch the logs for `designated-account-reconciliation:*` info, warn, and error lines.
2. Open the evidence center (`webapp/src/RegulatorEvidencePage.tsx`) to retrieve the latest `designated-reconciliation` entry, inspect the `wormUri`, and click **Verify** to confirm the stored SHA-256 matches the hash you recompute.
3. `.github/workflows/verify-designated-reconciliation.yml` executes `scripts/verify-designated-reconciliation.mjs` nightly; log the outcome in the governance channel (include the `artifactId` + hash) so the team knows whether the artefact creation succeeded and any mitigation steps.

## Retrospective Cadence
Schedule quarterly reviews with compliance, operations, and engineering to:

- Review alert counts (`DESIGNATED_WITHDRAWAL_ATTEMPT`, cap warnings).
- Inspect worker run metrics (processed orgs, success/failure counts, durations).
- Confirm the artefact verification script runs succeeded and document any remediation steps.

Document outcomes in this runbook and revisit `docs/compliance/designated-accounts.md` whenever new lessons arise so the compliance story stays aligned with the living architecture.

## Admin Control Logging
For events that manipulate PII (user deletion/export), refer to `docs/runbooks/admin-controls.md` to confirm the `security_event` stream includes `event`, `orgId`, `principal`, `subjectEmail`/`subjectUserId`, and the `x-correlation-id` header or Fastify `request.id`. That runbook explains how to trace those entries alongside the audit log chain and enforce fresh correlation IDs before regulators. 



============================================================
FILE: C:\src\apgms-final\docs\runbooks\secrets-management.md
============================================================
# Secrets Management Runbook

## Purpose
Document where the secrets live, how they are rotated, and how to ensure the audit chain stays intact when keys change.

## Secrets inventory
- **JWT keys** (`AUTH_JWKS`, `AUTH_DEV_SECRET`, `REGULATOR_JWT_AUDIENCE`): signing/verifying credentials loaded in `services/api-gateway/src/config.ts`.
- **PII keyset** (`PII_KEYS`, `PII_ACTIVE_KEY`, `PII_SALTS`, `PII_ACTIVE_SALT`): used by `shared/src/pii.ts` when tokenising TFNs/PIIs.
- **Envelope key** (`ENCRYPTION_MASTER_KEY`): used by `shared/src/crypto/envelope.ts` for AES-256-GCM envelopes stored in the database.
- **Database URLs** (`DATABASE_URL`, `SHADOW_DATABASE_URL`), `REDIS_URL`, `NATS_*`, and `WEBAPP_PORT`: treated as secrets for connection strings or endpoints.
- **Operational toggles** (`REQUIRE_TLS`, `AUTH_FAILURE_THRESHOLD`, `CORS_ALLOWED_ORIGINS`): stored in `.env` but still sensitive, so keep them in secured vaults (e.g., HashiCorp or cloud secret manager).

## Rotation procedures
1. Run `pnpm security:rotate-keys --write-env .env` to generate new PII key material and print encrypted secrets (`scripts/rotate-pii-keys.mjs`). Review the output for `PII_KEYS` and `PII_SALTS`.
2. Update the deployment secrets store (Vault/Key Vault/Secrets Manager) with the new values and leak the `AUTH_JWKS`, `ENCRYPTION_MASTER_KEY`, `PII_KEYS`, and `PII_SALTS` entries.
3. Trigger `pnpm --filter @apgms/shared generate` if the Prisma schema touches secrets tables.
4. Restart the API gateway so it picks up the new secrets, then run `pnpm run backup:evidence-pack` to capture the new audit artefacts and stash the pack alongside the rotated keys.

## Recovery & audits
- If a secret leaks, immediately revoke JWT tokens by rotating `AUTH_JWKS` and `AUTH_DEV_SECRET`, and rotate the PII keys (`PII_KEYS`/`PII_SALTS`).
- Use `shared/src/logging.ts` and `shared/src/redaction.ts` to verify that the rotated keys do not leak into logs; review the `auditLog` table for the `hash` chain (see `shared/prisma/migrations`) and re-run `scripts/collect-evidence.mjs` to produce a fresh evidence snapshot.
- The `.env.example` file documents every environment variable; keep it in sync with this runbook so new team members know what to provision.



============================================================
FILE: C:\src\apgms-final\docs\runbooks\stakeholder-connect.md
============================================================
# Stakeholder Connectivity & First-Run Instructions

This guide shows how to wire the APGMS prototype to an external banking/ATO stakeholder, which environment variables to customize, and what documentation/evidence to capture on first run.

## Prototype run (local developer + sandbox partner)

1. **Environment setup**
   * Set `DESIGNATED_BANKING_URL` to the partner/sandbox API base (e.g., `https://sandbox-bank.example.com`).
   * Supply `DESIGNATED_BANKING_TOKEN` and `DESIGNATED_BANKING_CERT_FINGERPRINT` if the partner requires bearer auth or certificate pinning.
   * Add `DSP_PRODUCT_ID` to record the ATO DSP reference youâ€™re using for the pilot.
2. **Initial startup**
   * Start the gateway and call `/compliance/status`; it will write `artifacts/compliance/partner-info.json` with partner metadata.
   * Issue pilot workloads: POST payroll/POS payloads to `/ingest/payroll` and `/ingest/pos` with unique `Idempotency-Key` headers.
